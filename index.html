<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Financiero v3.2 - Local Intelligence</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Markdown Parser for Report -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #1e1b4b;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --credit: #ec4899;
            --ai-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); /* Blue Logic Theme */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --radius: 16px;
            --nav-width: 260px;
            --header-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--nav-width); background: var(--surface); height: 100vh;
            display: flex; flex-direction: column; border-right: 1px solid #e5e7eb;
            position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s ease;
        }
        .brand {
            height: var(--header-height); display: flex; align-items: center; padding: 0 24px;
            font-size: 1.25rem; font-weight: 800; color: var(--primary); border-bottom: 1px solid #f3f4f6;
        }
        .brand span { color: #0ea5e9; }
        .nav-links { flex: 1; padding: 20px 12px; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            padding: 12px 16px; border-radius: 12px; color: var(--text-light); font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 12px; transition: all 0.2s;
        }
        .nav-item:hover { background: #f9fafb; color: var(--primary); }
        .nav-item.active { background: #e0e7ff; color: var(--primary); font-weight: 600; }
        
        /* AI Nav Item - Local Brain */
        .nav-item.ai-nav { color: #0284c7; }
        .nav-item.ai-nav.active { background: #e0f2fe; color: #0369a1; }
        .nav-item.ai-nav i { color: #0ea5e9; }

        /* --- MAIN CONTENT --- */
        .main-wrapper { flex: 1; margin-left: var(--nav-width); height: 100vh; overflow-y: auto; position: relative; padding-bottom: 80px; }
        .top-header {
            height: var(--header-height); background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 40; display: flex; justify-content: space-between; align-items: center;
            padding: 0 24px; border-bottom: 1px solid #e5e7eb;
        }
        .page-title { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        .date-filter-pill {
            background: white; border: 1px solid #e5e7eb; padding: 6px 12px;
            border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-sm);
        }
        .date-filter-pill input { border: none; outline: none; font-weight: 600; color: var(--primary); font-family: inherit; }
        .content-container { padding: 24px; max-width: 1200px; margin: 0 auto; }

        /* --- UI CARDS --- */
        .card { background: var(--surface); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid #f3f4f6; }
        .hero-balance {
            background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%); color: white; padding: 30px; border-radius: var(--radius);
            box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4); margin-bottom: 24px; position: relative; overflow: hidden;
        }
        .hero-balance::after { content: ''; position: absolute; right: -20px; top: -20px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        .hero-title { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .hero-amount { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .mini-stat { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid #f3f4f6; display: flex; flex-direction: column; justify-content: center; }
        .mini-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .mini-value { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }
        .mini-stat.debt .mini-value { color: var(--danger); }
        .mini-stat.income .mini-value { color: var(--success); }

        /* --- AI AGENT VIEW (Local) --- */
        .ai-welcome-card {
            background: var(--ai-gradient); color: white; padding: 30px; border-radius: var(--radius);
            text-align: center; margin-bottom: 30px; box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.4);
        }
        .ai-welcome-card h2 { font-size: 2rem; margin-bottom: 10px; }
        .ai-welcome-card p { opacity: 0.95; font-size: 1.1rem; max-width: 600px; margin: 0 auto 20px auto; }
        .btn-ai-action {
            background: white; color: #0369a1; padding: 15px 35px; border-radius: 30px; font-weight: 800; border: none; cursor: pointer; font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; display: inline-flex; align-items: center; gap: 10px;
        }
        .btn-ai-action:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        .ai-response-container { display: none; animation: slideUp 0.5s ease-out; }
        .ai-loading { display: none; flex-direction: column; align-items: center; padding: 40px; text-align: center; }
        .ai-spinner { width: 50px; height: 50px; border: 4px solid #f3f4f6; border-top-color: #0ea5e9; border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        .ai-loading-text { color: var(--text-light); font-weight: 500; animation: pulse 1.5s infinite; }

        /* Structured Report Styling */
        .report-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .report-section:last-child { border-bottom: none; }
        .report-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .report-text { font-size: 1rem; line-height: 1.6; color: var(--text-main); }
        
        .tag { padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .tag.good { background: #dcfce7; color: #166534; }
        .tag.warn { background: #fef9c3; color: #854d0e; }
        .tag.bad { background: #fee2e2; color: #991b1b; }

        /* --- MOBILE NAV --- */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; height: 65px; border-top: 1px solid #eee;
            z-index: 90; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom);
        }
        .mob-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.75rem; gap: 4px; background: none; border: none; cursor: pointer; }
        .mob-link.active { color: var(--primary); font-weight: 600; }
        .mob-link.ai-mob { color: #0ea5e9; }
        .mob-link.ai-mob.active { color: #0369a1; }

        /* --- FAB --- */
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white;
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            cursor: pointer; z-index: 100; transition: transform 0.2s; border: none;
        }
        .fab:hover { transform: scale(1.1); }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-wrapper { margin-left: 0; padding-bottom: 90px; }
            .mobile-nav { display: flex; }
            .fab { bottom: 85px; right: 20px; }
            .content-container { padding: 16px; }
            .history-filters { flex-direction: column; }
            .day-summary { flex-direction: column; text-align: center; }
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Reused styles */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
        input, select { padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem; background: #f9fafb; outline: none; }
        button { border: none; font-family: inherit; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600; width: 100%; }
        .btn-cancel { background: #e5e7eb; color: var(--text-main); padding: 12px 24px; border-radius: 10px; font-weight: 600; }
        
        /* History Nav */
        .date-nav-container { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .nav-btn { width: 40px; height: 40px; border-radius: 50%; background: white; border: 1px solid #d1d5db; display: flex; align-items: center; justify-content: center; color: var(--primary); transition: all 0.2s; }
        .current-date-display { text-align: center; flex: 1; }
        .date-label { font-weight: 800; font-size: 1.1rem; color: var(--text-main); text-transform: capitalize; }
        .date-sublabel { font-size: 0.8rem; color: var(--text-light); cursor: pointer; text-decoration: underline; }
        #historyDatePicker { position: absolute; opacity: 0; width: 1px; height: 1px; }
        
        /* Summary */
        .day-summary { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; }
        .summary-pill { background: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; border: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
        .summary-pill.inc { color: var(--success); background: #f0fdf4; border-color: #bbf7d0; }
        .summary-pill.exp { color: var(--danger); background: #fef2f2; border-color: #fecaca; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 16px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #eee; }
        td { padding: 16px; border-bottom: 1px solid #f3f4f6; }
        .history-filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; }
        .search-box { flex: 1; }
        .text-success { color: var(--success); font-weight: 600; }
        .text-danger { color: var(--danger); font-weight: 600; }
        .text-credit { color: var(--credit); font-weight: 600; }

        /* Modal Fix */
        .modal-overlay { z-index: 2000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s ease-out; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; z-index: 3000; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        .quota-card { border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .quota-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--text-main); }
        .quota-details { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-light); }
        .card-status-item { margin-bottom: 10px; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-status-item .card-name { font-weight: 600; }
        .card-status-item .card-debt { color: var(--danger); font-weight: 700; }
        .btn-icon-action { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 5px; margin-right: 5px; transition: transform 0.2s; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-wallet"></i> CRM <span>Expert</span>
        </div>
        <div class="nav-links">
            <div class="nav-item active" onclick="switchView('dashboard', this)">
                <i class="fas fa-home"></i> Dashboard
            </div>
            <div class="nav-item" onclick="switchView('transacciones', this)">
                <i class="fas fa-exchange-alt"></i> Transacciones
            </div>
            <div class="nav-item" onclick="switchView('estadisticas', this)">
                <i class="fas fa-chart-pie"></i> Estad√≠sticas
            </div>
            <div class="nav-item" onclick="switchView('historial', this)">
                <i class="fas fa-list"></i> Historial
            </div>
            <!-- AI Nav -->
            <div class="nav-item ai-nav" onclick="switchView('asistente', this)">
                <i class="fas fa-brain"></i> Asesor Financiero
            </div>
        </div>
        <div style="padding: 24px; font-size: 0.75rem; color: #9ca3af; text-align: center;">
            Familia & Finanzas ¬© 2025
        </div>
    </nav>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <button class="mob-link active" onclick="switchView('dashboard', this)">
            <i class="fas fa-home"></i> <span>Inicio</span>
        </button>
        <button class="mob-link" onclick="switchView('transacciones', this)">
            <i class="fas fa-exchange-alt"></i> <span>Trans.</span>
        </button>
        <button class="mob-link ai-mob" onclick="switchView('asistente', this)">
            <i class="fas fa-brain"></i> <span>Expert</span>
        </button>
        <button class="mob-link" onclick="switchView('historial', this)">
            <i class="fas fa-list"></i> <span>Hist.</span>
        </button>
    </nav>

    <!-- FAB -->
    <button class="fab" onclick="goToAddTransaction()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- MAIN CONTENT -->
    <div class="main-wrapper">
        <header class="top-header">
            <div class="page-title" id="pageTitle">Resumen Financiero</div>
            <div class="date-filter-pill" id="headerDateFilter">
                <i class="far fa-calendar-alt" style="color: var(--primary);"></i>
                <input type="month" id="dashboardMonth" onchange="updateDashboardView()">
            </div>
        </header>

        <div class="content-container">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="tab-content active">
                <div class="hero-balance">
                    <div class="hero-title">Patrimonio L√≠quido Total</div>
                    <div class="hero-amount" id="saldoTotal">$ 0</div>
                    <div style="font-size: 0.85rem; margin-top: 10px; opacity: 0.8;">
                        <i class="fas fa-info-circle"></i> Suma de Nequi, Bancos y Efectivo
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="mini-stat"><div class="mini-label"><i class="fas fa-university" style="color: #6366f1;"></i> D√©bito</div><div class="mini-value" id="saldoDebito">$0</div></div>
                    <div class="mini-stat"><div class="mini-label"><i class="fas fa-money-bill-wave" style="color: #10b981;"></i> Efectivo</div><div class="mini-value" id="saldoEfectivo">$0</div></div>
                    <div class="mini-stat"><div class="mini-label"><i class="fas fa-mobile-alt" style="color: #ec4899;"></i> Nequi</div><div class="mini-value" id="saldoNequi">$0</div></div>
                </div>
                <h3 style="margin-bottom: 15px; color: var(--text-light); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Flujo del Mes (<span id="lblPeriodoResumen">Actual</span>)</h3>
                <div class="stats-grid">
                    <div class="mini-stat income"><div class="mini-label">Ingresos</div><div class="mini-value" id="totalIngresosMes">$0</div></div>
                    <div class="mini-stat debt"><div class="mini-label">Gastos + Compras TC</div><div class="mini-value" id="totalGastosMes">$0</div></div>
                    <div class="mini-stat"><div class="mini-label">Balance Neto</div><div class="mini-value" id="balanceMes" style="color: var(--primary);">$0</div></div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                        <h3 style="margin:0;"><i class="fas fa-credit-card"></i> Deudas Tarjetas</h3>
                        <button onclick="openQuotaModal()" style="background: var(--bg-body); color: var(--text-main); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; width: auto;"><i class="fas fa-cog"></i> Gestionar</button>
                    </div>
                    <div class="hero-amount" id="deudaTotalTC" style="color: var(--danger); font-size: 1.8rem; margin-bottom: 15px;">$0</div>
                    <div id="cardsBreakdown"><div style="text-align:center; padding:20px;">Cargando...</div></div>
                </div>
            </div>

            <!-- ASISTENTE IA (LOCAL BRAIN) -->
            <div id="view-asistente" class="tab-content">
                <div class="ai-welcome-card">
                    <h2><i class="fas fa-brain"></i> Asesor Experto</h2>
                    <p>Motor de an√°lisis financiero local. Eval√∫a tus datos, deudas y presupuesto sin enviar informaci√≥n a la nube. 100% Privado y Gratuito.</p>
                    <button class="btn-ai-action" onclick="generateLocalAnalysis()">
                        <i class="fas fa-calculator"></i> Ejecutar Diagn√≥stico
                    </button>
                </div>

                <div id="aiLoading" class="ai-loading">
                    <div class="ai-spinner"></div>
                    <div class="ai-loading-text">Procesando datos matem√°ticos...</div>
                </div>

                <div id="aiResultContainer" class="ai-response-container">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                            <h3 style="margin:0; color: #0369a1;"><i class="fas fa-clipboard-check"></i> Diagn√≥stico Financiero</h3>
                            <span style="font-size:0.8rem; color:#6b7280;" id="aiTimestamp"></span>
                        </div>
                        <div id="aiContentBody">
                            <!-- Local AI Output -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRANSACCIONES -->
            <div id="view-transacciones" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 20px;" id="formTitle">Nueva Transacci√≥n</h2>
                    <form id="transactionForm">
                        <input type="hidden" id="editingId" value="">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Tipo de Movimiento</label>
                                <select id="tipo" required onchange="handleTipoChange()" style="font-weight: 600;">
                                    <option value="gasto">üí∏ Gasto</option>
                                    <option value="ingreso">üí∞ Ingreso</option>
                                    <option value="credito">üí≥ Cr√©dito</option>
                                    <option value="pago_tarjeta">üìâ Abono TC</option>
                                    <option value="transferencia">üîÑ Transferencia</option>
                                </select>
                            </div>
                            <div id="creditConfig" class="form-group full-width hidden" style="background: #fff1f2; padding: 15px; border-radius: 12px; border: 1px solid #fda4af;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group"><label style="color: var(--danger);">Tarjeta</label><select id="tarjetaCredito"></select></div>
                                    <div class="form-group"><label style="color: var(--danger);">Cuotas</label><input type="number" id="cuotas" min="1" max="36" value="1"></div>
                                </div>
                            </div>
                            <div id="divPagoTarjeta" class="form-group full-width hidden" style="background: #ecfdf5; padding: 15px; border-radius: 12px; border: 1px solid #6ee7b7;">
                                <div class="form-group"><label style="color: var(--success);">Tarjeta a Pagar</label><select id="tarjetaDestinoPago"></select></div>
                            </div>
                            <div class="form-group" id="metodoPagoDiv"><label id="lblMetodoPago">M√©todo de Pago</label><select id="metodoPago"><option value="debito">D√©bito</option><option value="efectivo">Efectivo</option><option value="nequi">Nequi</option></select></div>
                            <div class="form-group hidden" id="metodoDestinoDiv"><label>Cuenta Destino</label><select id="metodoDestino"><option value="debito">D√©bito</option><option value="efectivo">Efectivo</option><option value="nequi">Nequi</option></select></div>
                            <div class="form-group"><label>Monto</label><input type="text" id="monto" placeholder="$ 0" required oninput="formatCurrencyInput(this)" style="font-size: 1.2rem; font-weight: bold; color: var(--primary);"></div>
                            <div class="form-group"><label>Categor√≠a</label><select id="categoria" required><option value="">Seleccione...</option></select></div>
                            <div class="form-group hidden" id="subcategoriaDiv"><label>Subcategor√≠a</label><select id="subcategoria"></select></div>
                            <div class="form-group"><label>Responsable</label><select id="miembro" required><option value="papa">Pap√°</option><option value="mama">Mam√°</option><option value="hijo1">Hijo/a 1</option><option value="compartido">Compartido</option></select></div>
                            <div class="form-group full-width"><label>Descripci√≥n</label><input type="text" id="descripcion" placeholder="Detalle" required></div>
                            <div class="form-group"><label>Fecha</label><input type="date" id="fecha" required></div>
                        </div>
                        <div style="margin-top: 25px; display: flex; gap: 10px;">
                            <button type="button" onclick="preSubmit()" class="btn-primary" id="btnSubmitText">Guardar Transacci√≥n</button>
                            <button type="button" id="btnCancelar" class="btn-cancel hidden" onclick="cancelEdit()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ESTADISTICAS -->
            <div id="view-estadisticas" class="tab-content">
                <div class="card"><h3>Tendencia Financiera (6 Meses)</h3><div style="height: 300px; position: relative;"><canvas id="chartTendencias"></canvas></div></div>
                <div class="card"><h3>Distribuci√≥n de Gastos</h3><div style="height: 350px; position: relative;"><canvas id="chartCategorias"></canvas></div></div>
            </div>

            <!-- HISTORIAL -->
            <div id="view-historial" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 15px; text-align:center;">Agenda Financiera</h3>
                    <div class="date-nav-container">
                        <button class="nav-btn" onclick="changeDay(-1)"><i class="fas fa-chevron-left"></i></button>
                        <div class="current-date-display" onclick="document.getElementById('historyDatePicker').showPicker()">
                            <div class="date-label" id="lblHistoryDate">Hoy</div>
                            <div class="date-sublabel">Cambiar fecha</div>
                            <input type="date" id="historyDatePicker" onchange="setHistoryDate(this.value)">
                        </div>
                        <button class="nav-btn" onclick="changeDay(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="day-summary">
                        <div class="summary-pill inc"><i class="fas fa-arrow-down"></i><span id="valDailyInc">$0</span></div>
                        <div class="summary-pill exp"><i class="fas fa-arrow-up"></i><span id="valDailyExp">$0</span></div>
                    </div>
                    <div class="history-filters">
                        <input type="text" id="historySearch" class="filter-input search-box" placeholder="Buscar..." oninput="renderHistory()">
                        <select id="historyType" class="filter-input" style="flex:1;" onchange="renderHistory()"><option value="all">Todo</option><option value="gasto">Gastos</option><option value="ingreso">Ingresos</option><option value="credito">Cr√©dito</option></select>
                    </div>
                    <div class="table-container">
                        <table><thead><tr><th>Tipo</th><th>Cat.</th><th>Desc.</th><th>Monto</th><th></th></tr></thead><tbody id="transactionList"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="creditModal" style="display:none;">
        <div class="modal-content">
            <h3 class="modal-title">Confirmar Cr√©dito</h3>
            <div class="modal-details">
                <div class="modal-row"><span>Tarjeta:</span><strong id="modalTarjeta">-</strong></div>
                <div class="modal-row"><span>Cuotas:</span><span id="modalCuotas">0</span></div>
                <div class="modal-row total"><span>Total Deuda:</span><span id="modalTotalDeuda">$0</span></div>
            </div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeModal('creditModal')">Volver</button><button class="btn-confirm" onclick="confirmSaveTransaction()">Confirmar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="quotaModal" style="display:none;">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3 class="modal-title">Gesti√≥n Tarjetas</h3><button onclick="closeModal('quotaModal')" style="background:none; font-size:1.5rem;">&times;</button></div>
            <div class="add-card-form">
                <div class="form-group"><label>Nombre</label><input type="text" id="cardNameInput" placeholder="Ej: Visa"></div>
                <div class="form-group"><label>Cupo</label><input type="text" id="cardQuotaInput" oninput="formatCurrencyInput(this)" placeholder="$ 0"></div>
                <button class="btn-primary" onclick="saveCard()" id="btnSaveCard" style="height: 46px; width: auto; padding: 0 20px;"><i class="fas fa-plus"></i></button>
                <input type="hidden" id="editCardId">
            </div>
            <div id="quotaListContainer" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAP8f9ldzgyKAg74Da2yYL9u_urRLtf8nY",
            authDomain: "crm-financiero.firebaseapp.com",
            projectId: "crm-financiero",
            storageBucket: "crm-financiero.firebasestorage.app",
            messagingSenderId: "442754442943",
            appId: "1:442754442943:web:914d5a8ef619d77407880a",
            measurementId: "G-5EBSSNG8P9"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        // GLOBALS & CONFIG
        let transactions = []; let cardsList = []; let editingTransactionId = null; let chartInstance = null; let trendChartInstance = null; let tempTransactionData = null; let globalDeudaPorTarjeta = {}; let currentViewDate = new Date(); let currentHistoryDate = new Date(); 
        const categories = {
            gasto: { 'vivienda':{icon:'üè†',subcategorias:['Arriendo','Cuota hipoteca','Administraci√≥n','Impuesto','Reparaciones']}, 'servicios_publicos':{icon:'üí°',subcategorias:['Energ√≠a','Agua','Gas','Internet','Celular','Streaming']}, 'alimentacion':{icon:'üçî',subcategorias:['Mercado','Carnes','Frutas','Tienda','Domicilios']}, 'transporte':{icon:'üöó',subcategorias:['Transporte p√∫blico','Gasolina','SOAT','Mantenimiento','Parqueadero','Peajes','Uber']}, 'educacion':{icon:'üìö',subcategorias:['Pensi√≥n','Universidad','√ötiles','Uniformes','Transporte']}, 'salud':{icon:'‚öïÔ∏è',subcategorias:['Prepagada','Consultas','Medicamentos','Odontolog√≠a']}, 'vestuario':{icon:'üëï',subcategorias:['Ropa','Calzado']}, 'cuidado_personal':{icon:'üíÑ',subcategorias:['Peluquer√≠a','Aseo','Cosm√©ticos','Gym']}, 'entretenimiento':{icon:'üé¨',subcategorias:['Restaurantes','Cine','Paseos','Eventos']}, 'deudas':{icon:'üí≥',subcategorias:['Pr√©stamos','Gota a gota']}, 'seguros':{icon:'üõ°Ô∏è',subcategorias:['Vida','Hogar','Veh√≠culo']}, 'otros':{icon:'üì¶',subcategorias:['Mascotas','Regalos','Imprevistos']} },
            ingreso: { 'salario':{icon:'üíº',subcategorias:['Principal','Extras','Prima']}, 'negocio':{icon:'üè™',subcategorias:['Ventas','Servicios']}, 'inversiones':{icon:'üìà',subcategorias:['Dividendos','Intereses']}, 'otros':{icon:'üí∞',subcategorias:['Subsidios','Pensi√≥n','Regalos']} }
        };
        const categorias = categories;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date(); document.getElementById('dashboardMonth').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`; document.getElementById('fecha').valueAsDate = today;
            updateHistoryHeader(); document.getElementById('creditModal').style.display = 'none'; document.getElementById('quotaModal').style.display = 'none';
            loadCards();
        });

        // --- LOCAL BRAIN LOGIC (NO API) ---
        function generateLocalAnalysis() {
            const btn = document.querySelector('.btn-ai-action'); const loader = document.getElementById('aiLoading'); const result = document.getElementById('aiResultContainer');
            btn.disabled = true; loader.style.display = 'flex'; result.style.display = 'none';

            setTimeout(() => {
                const data = prepareFinancialContext();
                
                // 1. Health Diagnosis
                let healthStatus = ""; let healthColor = ""; let healthMsg = "";
                if (data.cashFlow > (data.income * 0.15)) { healthStatus = "SALUDABLE"; healthColor = "good"; healthMsg = "¬°Excelente! Est√°s gastando menos de lo que ganas y tienes capacidad de ahorro."; }
                else if (data.cashFlow >= 0) { healthStatus = "ALERTA"; healthColor = "warn"; healthMsg = "Cuidado. Est√°s al l√≠mite. Tus ingresos cubren los gastos pero cualquier imprevisto te desbalancea."; }
                else { healthStatus = "CR√çTICO"; healthColor = "bad"; healthMsg = "¬°Atenci√≥n Inmediata! Tus gastos superan tus ingresos. Est√°s generando deuda o quemando ahorros."; }

                // 2. Debt Analysis
                let debtAdvice = "";
                if (data.totalDebt === 0) {
                    debtAdvice = "üéâ No tienes deudas en tarjetas registradas. ¬°Sigue as√≠! Considera usar tarjetas solo para beneficios (puntos/millas) pagando a 1 cuota.";
                } else {
                    // Strategy Logic: Assuming standard behavior
                    const debtRatio = (data.totalDebt / data.income) * 100;
                    debtAdvice = `Tu deuda total es de **${formatMoney(data.totalDebt)}**. `;
                    if (debtRatio > 30) debtAdvice += `‚ö†Ô∏è Esto representa el ${Math.round(debtRatio)}% de tus ingresos mensuales, un nivel alto de riesgo. `;
                    
                    // Check card count
                    const cardsWithDebt = Object.entries(data.debtDetails).filter(([k,v]) => v > 0);
                    if (cardsWithDebt.length > 1) {
                        debtAdvice += `Tienes deuda en ${cardsWithDebt.length} tarjetas. Te sugiero el m√©todo **Bola de Nieve**: paga el m√≠nimo en todas y inyecta todo el capital extra a la tarjeta con menor saldo para eliminarla r√°pido y ganar motivaci√≥n.`;
                    } else {
                        debtAdvice += "Al tener deuda en una sola tarjeta, conc√©ntrate en hacer abonos a capital (pagos extra) para reducir los intereses compuestos.";
                    }
                }

                // 3. Spending Alerts
                let alertsHTML = "";
                if (data.topExpenses.length > 0) {
                    const topCat = data.topExpenses[0];
                    alertsHTML += `<li>Tu categor√≠a de mayor gasto es <strong>${topCat.category}</strong> con ${formatMoney(topCat.amount)}. ¬øEs esto vital o puedes reducirlo?</li>`;
                }
                if (data.cashFlow < 0) alertsHTML += `<li>‚ö†Ô∏è **D√©ficit Mensual**: Te faltan ${formatMoney(Math.abs(data.cashFlow))} para cerrar el mes en cero. Revisa gastos hormiga.</li>`;

                // Construct Report
                const html = `
                    <div class="report-section">
                        <div class="report-title"><i class="fas fa-heartbeat" style="color:#ef4444"></i> Salud Financiera: <span class="tag ${healthColor}">${healthStatus}</span></div>
                        <p class="report-text">${healthMsg}</p>
                    </div>
                    <div class="report-section">
                        <div class="report-title"><i class="fas fa-chart-pie" style="color:#3b82f6"></i> An√°lisis de Flujo (30 d√≠as)</div>
                        <ul class="report-text" style="list-style:none; padding:0;">
                            <li>üí∞ Ingresos: ${formatMoney(data.income)}</li>
                            <li>üí∏ Gastos: ${formatMoney(data.expenses)}</li>
                            <li>üìâ Balance: <strong>${formatMoney(data.cashFlow)}</strong></li>
                        </ul>
                    </div>
                    <div class="report-section">
                        <div class="report-title"><i class="fas fa-shield-alt" style="color:#eab308"></i> Estrategia de Deuda</div>
                        <p class="report-text">${debtAdvice}</p>
                    </div>
                    <div class="report-section">
                        <div class="report-title"><i class="fas fa-lightbulb" style="color:#8b5cf6"></i> Recomendaciones Clave</div>
                        <ul class="report-text" style="padding-left:20px;">
                            ${alertsHTML || "<li>Mant√©n tu disciplina actual. Est√°s en buen camino.</li>"}
                            <li>Regla 50/30/20: Intenta que tus gastos fijos no superen el 50% de tu ingreso.</li>
                        </ul>
                    </div>
                `;

                document.getElementById('aiContentBody').innerHTML = html;
                document.getElementById('aiTimestamp').textContent = new Date().toLocaleString();
                
                loader.style.display = 'none'; result.style.display = 'block'; btn.disabled = false;
            }, 1500); // Simulating processing time
        }

        function prepareFinancialContext() {
            let totalIncome = 0; let totalExpense = 0; let debts = {...globalDeudaPorTarjeta}; let totalDebt = 0;
            const today = new Date(); const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(today.getDate() - 30);
            const recentTransactions = transactions.filter(t => new Date(t.fecha) >= thirtyDaysAgo);
            recentTransactions.forEach(t => { const m = parseFloat(t.monto); if (t.tipo === 'ingreso') totalIncome += m; if (t.tipo === 'gasto' || t.tipo === 'credito') totalExpense += m; });
            Object.values(debts).forEach(d => totalDebt += d);
            let catMap = {}; recentTransactions.filter(t => t.tipo === 'gasto').forEach(t => { catMap[t.categoria] = (catMap[t.categoria] || 0) + parseFloat(t.monto); });
            const topCategories = Object.entries(catMap).sort(([,a],[,b]) => b-a).slice(0, 3).map(([k,v]) => ({ category: k, amount: v }));
            return { income: totalIncome, expenses: totalExpense, cashFlow: totalIncome - totalExpense, totalDebt: totalDebt, debtDetails: debts, topExpenses: topCategories };
        }

        // --- NAVIGATION ---
        function switchView(viewId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            const filter = document.getElementById('headerDateFilter'); if(filter) filter.style.display = viewId === 'dashboard' ? 'flex' : 'none';
            const titles = { 'dashboard': 'Resumen', 'transacciones': 'Registrar', 'estadisticas': 'An√°lisis', 'historial': 'Agenda', 'asistente': 'Asesor Experto' };
            document.getElementById('pageTitle').textContent = titles[viewId] || 'CRM';
            document.querySelectorAll('.sidebar .nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.mobile-nav .mob-link').forEach(el => el.classList.remove('active'));
            const sideLinks = document.querySelectorAll('.sidebar .nav-item'); const mobLinks = document.querySelectorAll('.mobile-nav .mob-link');
            if(viewId==='dashboard') { sideLinks[0].classList.add('active'); mobLinks[0].classList.add('active'); }
            if(viewId==='transacciones') { sideLinks[1].classList.add('active'); mobLinks[1].classList.add('active'); }
            if(viewId==='estadisticas') { sideLinks[2].classList.add('active'); }
            if(viewId==='historial') { sideLinks[3].classList.add('active'); mobLinks[3].classList.add('active'); }
            if(viewId==='asistente') { sideLinks[4].classList.add('active'); mobLinks[2].classList.add('active'); }
        }
        function goToAddTransaction() { switchView('transacciones'); }

        // --- UTILS ---
        function formatMoney(n) { return '$ ' + parseFloat(n).toLocaleString('es-CO', {maximumFractionDigits:0}); }
        function formatCurrencyInput(input) { let value = input.value.replace(/\D/g, ""); if (value === "") { input.value = ""; return; } input.value = "$ " + new Intl.NumberFormat('es-CO').format(value); }
        function parseCurrencyInput(valueString) { return valueString ? parseFloat(valueString.replace(/\D/g, '')) : 0; }

        // --- HISTORY LOGIC ---
        function changeDay(offset) { currentHistoryDate.setDate(currentHistoryDate.getDate() + offset); updateHistoryHeader(); renderHistory(); }
        function setHistoryDate(dateStr) { const [y, m, d] = dateStr.split('-').map(Number); currentHistoryDate = new Date(y, m - 1, d); updateHistoryHeader(); renderHistory(); }
        function updateHistoryHeader() { const displayStr = currentHistoryDate.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('lblHistoryDate').textContent = (new Date().toDateString() === currentHistoryDate.toDateString()) ? "Hoy" : displayStr; document.getElementById('historyDatePicker').value = `${currentHistoryDate.getFullYear()}-${String(currentHistoryDate.getMonth()+1).padStart(2,'0')}-${String(currentHistoryDate.getDate()).padStart(2,'0')}`; }

        // --- DATA & TRANSACTIONS ---
        async function loadCards() { try { const s = await db.collection('cards').orderBy('name').get(); cardsList = []; s.forEach(d => cardsList.push({id:d.id, ...d.data()})); if(cardsList.length===0){await seedDefaultCards();return;} populateCardSelects(); loadTransactions(); } catch(e){console.error(e);} }
        async function seedDefaultCards() { const defaults=['Exito','Nu','Falabella']; const b=db.batch(); defaults.forEach(n=>b.set(db.collection('cards').doc(),{name:n,quota:0})); await b.commit(); loadCards(); }
        function populateCardSelects() { const s1=document.getElementById('tarjetaCredito'); const s2=document.getElementById('tarjetaDestinoPago'); s1.innerHTML=''; s2.innerHTML=''; cardsList.forEach(c=>{s1.add(new Option(c.name,c.name));s2.add(new Option(c.name,c.name));}); }
        async function loadTransactions() { const s=await db.collection('transactions').orderBy('fecha','desc').get(); transactions=[]; s.forEach(d=>transactions.push({id:d.id,...d.data()})); updateDashboard(); renderHistory(); renderCharts(); renderTrendChart(); }

        function renderHistory() {
            const b=document.getElementById('transactionList'); b.innerHTML='';
            const fDate=`${currentHistoryDate.getFullYear()}-${String(currentHistoryDate.getMonth()+1).padStart(2,'0')}-${String(currentHistoryDate.getDate()).padStart(2,'0')}`;
            const txt=document.getElementById('historySearch').value.toLowerCase(); const type=document.getElementById('historyType').value;
            let dInc=0, dExp=0;
            const res=transactions.filter(t=>{
                const sameDay=t.fecha===fDate; const txtM=t.descripcion.toLowerCase().includes(txt); const typM=type==='all'||t.tipo===type;
                if(sameDay){const m=parseFloat(t.monto); if(t.tipo==='ingreso')dInc+=m; else if(t.tipo==='gasto'||t.tipo==='credito')dExp+=m;}
                return sameDay&&txtM&&typM;
            });
            document.getElementById('valDailyInc').textContent=formatMoney(dInc); document.getElementById('valDailyExp').textContent=formatMoney(dExp);
            if(res.length===0){b.innerHTML='<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">Sin movimientos</td></tr>';return;}
            res.forEach(t=>{
                let c=t.tipo==='ingreso'?'text-success':(t.tipo==='pago_tarjeta'?'text-credit':'text-danger'); let s=t.tipo==='ingreso'?'+':'-'; if(t.tipo==='transferencia'){c='text-main';s='';}
                b.innerHTML+=`<tr><td style="text-transform:capitalize;font-size:0.85rem;">${t.tipo.replace('_',' ')}</td><td>${t.categoria||'-'}</td><td>${t.descripcion}</td><td class="${c}" style="font-weight:bold;">${s} ${formatMoney(t.monto)}</td><td style="text-align:right;"><button onclick="editTransaction('${t.id}')" class="btn-icon-action" style="color:var(--info);"><i class="fas fa-edit"></i></button><button onclick="deleteTransaction('${t.id}')" class="btn-icon-action" style="color:var(--danger);"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        function updateDashboard() {
            let deb=0,eff=0,neq=0,incM=0,expM=0; let dMap={}; cardsList.forEach(c=>dMap[c.name]=0);
            const vm=currentViewDate.getMonth(); const vy=currentViewDate.getFullYear();
            transactions.forEach(t=>{
                const m=parseFloat(t.monto); const [ty,tm]=t.fecha.split('-').map(Number); const isView=(tm-1)===vm&&ty===vy;
                if(t.tipo==='pago_tarjeta'){ if(t.metodoPago==='debito')deb-=m; if(t.metodoPago==='efectivo')eff-=m; if(t.metodoPago==='nequi')neq-=m; if(dMap[t.tarjetaDestino]!==undefined)dMap[t.tarjetaDestino]-=m; }
                else if(!t.esCredito){
                    if(t.tipo==='ingreso'){ if(t.metodoPago==='debito')deb+=m; if(t.metodoPago==='efectivo')eff+=m; if(t.metodoPago==='nequi')neq+=m; if(isView)incM+=m; }
                    else if(t.tipo==='gasto'){ if(t.metodoPago==='debito')deb-=m; if(t.metodoPago==='efectivo')eff-=m; if(t.metodoPago==='nequi')neq-=m; if(isView)expM+=m; }
                    else if(t.tipo==='transferencia'){ if(t.metodoPago==='debito')deb-=m; if(t.metodoPago==='efectivo')eff-=m; if(t.metodoPago==='nequi')neq-=m; if(t.metodoDestino==='debito')deb+=m; if(t.metodoDestino==='efectivo')eff+=m; if(t.metodoDestino==='nequi')neq+=m; }
                } else { const c=t.metodoPago; if(dMap[c]!==undefined)dMap[c]+=(t.totalDeuda||m); if(isView)expM+=m; }
            });
            globalDeudaPorTarjeta=dMap;
            document.getElementById('saldoDebito').textContent=formatMoney(deb); document.getElementById('saldoEfectivo').textContent=formatMoney(eff); document.getElementById('saldoNequi').textContent=formatMoney(neq); document.getElementById('saldoTotal').textContent=formatMoney(deb+eff+neq);
            document.getElementById('totalIngresosMes').textContent=formatMoney(incM); document.getElementById('totalGastosMes').textContent=formatMoney(expM); document.getElementById('balanceMes').textContent=formatMoney(incM-expM);
            const div=document.getElementById('cardsBreakdown'); div.innerHTML=''; let totD=0;
            Object.keys(dMap).forEach(k=>{ if(dMap[k]!==0){ totD+=dMap[k]; div.innerHTML+=`<div class="card-status-item"><span class="card-name">${k}</span><span class="card-debt">${formatMoney(dMap[k])}</span></div>`; }});
            document.getElementById('deudaTotalTC').textContent=formatMoney(totD);
        }
        function updateDashboardView() { const v=document.getElementById('dashboardMonth').value; if(v){const[y,m]=v.split('-');currentViewDate=new Date(parseInt(y),parseInt(m)-1,1);updateDashboard();renderCharts();}}
        function renderTrendChart() { const ctx=document.getElementById('chartTendencias'); if(trendChartInstance)trendChartInstance.destroy(); const lbs=[],dI=[],dE=[],today=new Date(),b={}; for(let i=5;i>=0;i--){const d=new Date(today.getFullYear(),today.getMonth()-i,1);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;b[k]={i:0,e:0};lbs.push(d.toLocaleString('es-CO',{month:'short'}));} transactions.forEach(t=>{const k=t.fecha.substring(0,7);if(b[k]){if(t.tipo==='ingreso')b[k].i+=parseFloat(t.monto);else if(t.tipo==='gasto'||t.tipo==='credito')b[k].e+=parseFloat(t.monto);}}); Object.keys(b).sort().forEach(k=>{dI.push(b[k].i);dE.push(b[k].e);}); trendChartInstance=new Chart(ctx,{type:'line',data:{labels:lbs,datasets:[{label:'Ing',data:dI,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',fill:true},{label:'Gas',data:dE,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}}); }
        function renderCharts() { const ctx=document.getElementById('chartCategorias'); if(chartInstance)chartInstance.destroy(); const cats={},vm=currentViewDate.getMonth(),vy=currentViewDate.getFullYear(); transactions.filter(t=>(t.tipo==='gasto'||t.tipo==='credito')).forEach(t=>{const[ty,tm]=t.fecha.split('-').map(Number);if((tm-1)===vm&&ty===vy){const c=t.categoria||'Otros';cats[c]=(cats[c]||0)+parseFloat(t.monto);}}); chartInstance=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),backgroundColor:['#6366f1','#ec4899','#10b981','#f59e0b','#3b82f6','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}}); }

        // --- FORM ---
        function handleTipoChange() { const t=document.getElementById('tipo').value; const cc=document.getElementById('creditConfig'); const pc=document.getElementById('divPagoTarjeta'); const mp=document.getElementById('metodoPagoDiv'); const md=document.getElementById('metodoDestinoDiv'); const cat=document.getElementById('categoria'); cc.classList.add('hidden'); pc.classList.add('hidden'); mp.classList.remove('hidden'); md.classList.add('hidden'); if(t==='credito'){cc.classList.remove('hidden');mp.classList.add('hidden');}else if(t==='pago_tarjeta'){pc.classList.remove('hidden');}else if(t==='transferencia'){md.classList.remove('hidden');} cat.innerHTML='<option value="">Seleccione...</option>'; document.getElementById('subcategoriaDiv').classList.add('hidden'); if(t==='pago_tarjeta')cat.add(new Option('Abono Tarjeta','pago_tc')); else if(t==='transferencia')cat.add(new Option('Transferencia','transferencia')); else{const g=t==='credito'?'gasto':t;if(categorias[g]){Object.keys(categorias[g]).forEach(k=>{cat.add(new Option(categorias[g][k].icon+' '+k.toUpperCase().replace(/_/g,' '),k));});}} }
        document.getElementById('categoria').addEventListener('change',function(){ const t=document.getElementById('tipo').value; if(t==='pago_tarjeta'||t==='transferencia')return; const k=this.value; const s=document.getElementById('subcategoria'); const d=document.getElementById('subcategoriaDiv'); const g=t==='credito'?'gasto':t; if(k&&categorias[g][k]){d.classList.remove('hidden');s.innerHTML='';categorias[g][k].subcategorias.forEach(x=>s.add(new Option(x,x)));}else d.classList.add('hidden'); });
        function preSubmit(){ const t=document.getElementById('tipo').value; const m=parseCurrencyInput(document.getElementById('monto').value); if(m<=0){alert('Monto inv√°lido');return;} const d={tipo:t,monto:m,categoria:document.getElementById('categoria').value,subcategoria:document.getElementById('subcategoria').value||'',miembro:document.getElementById('miembro').value,descripcion:document.getElementById('descripcion').value,fecha:document.getElementById('fecha').value,timestamp:firebase.firestore.FieldValue.serverTimestamp()}; if(t==='credito'){const tc=document.getElementById('tarjetaCredito').value; const c=parseInt(document.getElementById('cuotas').value); d.metodoPago=tc; d.esCredito=true; d.cuotas=c; d.totalDeuda=m; tempTransactionData=d; document.getElementById('modalTarjeta').textContent=tc; document.getElementById('modalCuotas').textContent=c; document.getElementById('modalTotalDeuda').textContent=formatMoney(m); document.getElementById('creditModal').style.display='flex';} else{if(t==='pago_tarjeta'){d.metodoPago=document.getElementById('metodoPago').value; d.tarjetaDestino=document.getElementById('tarjetaDestinoPago').value;}else{d.metodoPago=document.getElementById('metodoPago').value; if(t==='transferencia')d.metodoDestino=document.getElementById('metodoDestino').value;} saveTransaction(d);} }
        function confirmSaveTransaction(){if(tempTransactionData)saveTransaction(tempTransactionData);closeModal('creditModal');}
        async function saveTransaction(d){try{if(editingTransactionId)await db.collection('transactions').doc(editingTransactionId).update(d);else await db.collection('transactions').add(d); cancelEdit(); loadTransactions(); showToast(editingTransactionId?'Actualizado':'Guardado','success');}catch(e){alert('Error: '+e.message);}}
        function cancelEdit(){editingTransactionId=null; document.getElementById('transactionForm').reset(); document.getElementById('formTitle').textContent='Nueva Transacci√≥n'; document.getElementById('btnCancelar').classList.add('hidden'); document.getElementById('btnSubmitText').textContent='Guardar Transacci√≥n'; handleTipoChange();}
        window.editTransaction=function(id){const t=transactions.find(x=>x.id===id);if(!t)return;editingTransactionId=id;switchView('transacciones');document.getElementById('tipo').value=t.tipo;handleTipoChange();const m=document.getElementById('monto');m.value=t.monto;formatCurrencyInput(m);document.getElementById('descripcion').value=t.descripcion;document.getElementById('fecha').value=t.fecha;document.getElementById('miembro').value=t.miembro;if(t.tipo==='credito'){document.getElementById('tarjetaCredito').value=t.metodoPago;document.getElementById('cuotas').value=t.cuotas;}else if(t.tipo==='pago_tarjeta'){document.getElementById('metodoPago').value=t.metodoPago;document.getElementById('tarjetaDestinoPago').value=t.tarjetaDestino;}else{document.getElementById('metodoPago').value=t.metodoPago;if(t.tipo==='transferencia')document.getElementById('metodoDestino').value=t.metodoDestino;}document.getElementById('formTitle').textContent='Editar Transacci√≥n';document.getElementById('btnSubmitText').textContent='Actualizar Transacci√≥n';document.getElementById('btnCancelar').classList.remove('hidden');setTimeout(()=>{document.getElementById('categoria').value=t.categoria;const e=new Event('change');document.getElementById('categoria').dispatchEvent(e);setTimeout(()=>{if(t.subcategoria)document.getElementById('subcategoria').value=t.subcategoria;},50);},100);}
        window.deleteTransaction=async function(id){if(confirm("Eliminar?")){await db.collection('transactions').doc(id).delete();loadTransactions();showToast('Eliminado','success');}}
        function showToast(msg,type){const c=document.getElementById('toastContainer');const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),4000);}
        
        function openQuotaModal(){renderQuotaCards();resetCardForm();document.getElementById('quotaModal').style.display='flex';}
        function closeModal(id){document.getElementById(id).style.display='none';}
        function resetCardForm(){document.getElementById('cardNameInput').value='';document.getElementById('cardQuotaInput').value='';document.getElementById('editCardId').value='';document.getElementById('btnSaveCard').innerHTML='<i class="fas fa-plus"></i>';}
        async function saveCard(){const n=document.getElementById('cardNameInput').value.trim();const q=parseCurrencyInput(document.getElementById('cardQuotaInput').value);const i=document.getElementById('editCardId').value;if(!n)return;try{if(i)await db.collection('cards').doc(i).update({name:n,quota:q});else await db.collection('cards').add({name:n,quota:q});resetCardForm();loadCards();setTimeout(renderQuotaCards,500);}catch(e){console.error(e);}}
        async function deleteCard(id){if(!confirm("Borrar?"))return;await db.collection('cards').doc(id).delete();loadCards();setTimeout(renderQuotaCards,500);}
        function editCard(id,name,quota){document.getElementById('cardNameInput').value=name;const i=document.getElementById('cardQuotaInput');i.value=quota;formatCurrencyInput(i);document.getElementById('editCardId').value=id;document.getElementById('btnSaveCard').innerHTML='<i class="fas fa-save"></i>';}
        function renderQuotaCards(){const d=document.getElementById('quotaListContainer');d.innerHTML='';cardsList.forEach(c=>{const db=globalDeudaPorTarjeta[c.name]||0;const av=(c.quota||0)-db;const el=document.createElement('div');el.className='quota-card';el.innerHTML=`<div class="quota-header"><span class="quota-name">${c.name}</span><div><button class="btn-icon-action" style="color:var(--info)" onclick="editCard('${c.id}','${c.name}','${c.quota}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon-action" style="color:var(--danger)" onclick="deleteCard('${c.id}')"><i class="fas fa-trash"></i></button></div></div><div class="quota-details"><span>Cupo: ${formatMoney(c.quota)}</span><span class="text-danger">Deuda: ${formatMoney(db)}</span></div><div style="font-size:0.8rem;text-align:right;color:var(--success);">Disp: ${formatMoney(av)}</div>`;d.appendChild(el);});}

        handleTipoChange();
    </script>
</body>
</html>