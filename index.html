<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Enterprise</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        dark: '#111827',
                        light: '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .card-gradient-1 { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #059669 0%, #10B981 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%); }
        .credit-card-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- HEADER MOBILE/DESKTOP -->
    <header class="bg-white border-b px-6 py-4 flex justify-between items-center z-20 shadow-sm shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-primary/10 p-2 rounded-lg">
                <i class="ph-fill ph-wallet text-primary text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight text-dark">Finanzas<span class="text-primary">Pro</span></h1>
                <p class="text-[10px] text-gray-400 font-medium tracking-wide">ENTERPRISE EDITION</p>
            </div>
        </div>
        <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-500">
            <span class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></span> Conectando...
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main id="mainContent" class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 hide-scrollbar relative">
        
        <!-- SECTION: DASHBOARD -->
        <section id="view-dashboard" class="space-y-6 animate-fade-in">
            <!-- Ajustar Saldos -->
            <div class="flex justify-end">
                <button onclick="openModal('balanceModal')" class="text-primary text-xs font-semibold flex items-center gap-1 hover:bg-primary/5 px-3 py-1.5 rounded-lg transition">
                    <i class="ph ph-sliders-horizontal"></i> Calibrar Saldos
                </button>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Patrimonio -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Patrimonio LÃ­quido</p>
                        <h3 id="dash-liquid" class="text-2xl font-bold text-emerald-600 mt-1">$0</h3>
                        <div class="flex gap-2 mt-2 text-[10px] text-gray-400 font-medium">
                            <span>DEB: <b id="dash-deb" class="text-gray-600">$0</b></span>
                            <span>â€¢</span>
                            <span>EFEC: <b id="dash-efe" class="text-gray-600">$0</b></span>
                        </div>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-xl text-emerald-600">
                        <i class="ph-fill ph-coins text-2xl"></i>
                    </div>
                </div>

                <!-- Deuda -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Deuda Total</p>
                        <h3 id="dash-debt" class="text-2xl font-bold text-red-500 mt-1">$0</h3>
                        <p class="text-[10px] text-gray-400 mt-1">Cupo Disponible: <b id="dash-limit" class="text-gray-600">$0</b></p>
                    </div>
                    <div class="bg-red-50 p-3 rounded-xl text-red-500">
                        <i class="ph-fill ph-credit-card text-2xl"></i>
                    </div>
                </div>

                <!-- Flujo -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Flujo Caja (Mes)</p>
                        <h3 id="dash-flow" class="text-2xl font-bold text-blue-600 mt-1">$0</h3>
                        <p class="text-[10px] text-gray-400 mt-1">Ingresos vs Gastos</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl text-blue-600">
                        <i class="ph-fill ph-chart-line-up text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="ph-fill ph-chart-pie-slice text-primary"></i> Gastos por CategorÃ­a
                </h3>
                <div class="h-64 w-full relative">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </section>

        <!-- SECTION: TARJETAS -->
        <section id="view-cards" class="space-y-6 hidden animate-fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Billetera</h2>
                <button onclick="openModal('cardModal')" class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg shadow-primary/30 flex items-center gap-2 active:scale-95 transition">
                    <i class="ph-bold ph-plus"></i> Nueva Tarjeta
                </button>
            </div>

            <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Cards injected via JS -->
                <div class="col-span-full text-center py-10 text-gray-400">
                    <i class="ph-duotone ph-spinner animate-spin text-3xl"></i>
                    <p class="text-sm mt-2">Cargando billetera...</p>
                </div>
            </div>
        </section>

        <!-- SECTION: HISTORIAL -->
        <section id="view-history" class="space-y-4 hidden animate-fade-in">
            <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100 sticky top-0 z-10">
                <h2 class="font-bold text-gray-800 flex items-center gap-2">
                    <i class="ph-fill ph-list-dashes text-primary"></i> Historial
                </h2>
                <span id="tx-count" class="text-xs bg-gray-100 px-2 py-1 rounded-md font-mono text-gray-500">0 regs</span>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold border-b">
                            <tr>
                                <th class="px-4 py-3 whitespace-nowrap">Fecha</th>
                                <th class="px-4 py-3">Tipo</th>
                                <th class="px-4 py-3">Detalle</th>
                                <th class="px-4 py-3">MÃ©todo</th>
                                <th class="px-4 py-3 text-right">Monto</th>
                                <th class="px-4 py-3 text-center">AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody id="tx-table-body" class="divide-y divide-gray-100">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- FAB (Floating Action Button) -->
    <button onclick="openModal('transactionModal')" class="fixed bottom-24 right-6 md:bottom-10 md:right-10 bg-dark text-white w-14 h-14 rounded-full shadow-2xl shadow-dark/40 flex items-center justify-center z-40 hover:scale-110 active:scale-95 transition-all group">
        <i class="ph-bold ph-plus text-2xl group-hover:rotate-90 transition-transform duration-300"></i>
    </button>

    <!-- BOTTOM NAVIGATION (Mobile) -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t px-6 py-3 pb-safe flex justify-between items-center z-50">
        <button onclick="switchView('dashboard')" class="nav-btn active flex flex-col items-center gap-1 text-gray-400 hover:text-primary w-16">
            <i class="ph-fill ph-squares-four text-2xl"></i>
            <span class="text-[10px] font-medium">Inicio</span>
        </button>
        <button onclick="switchView('cards')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-primary w-16">
            <i class="ph-fill ph-credit-card text-2xl"></i>
            <span class="text-[10px] font-medium">Tarjetas</span>
        </button>
        <div class="w-12"></div> <!-- Spacer for FAB -->
        <button onclick="switchView('history')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-primary w-16">
            <i class="ph-fill ph-list-dashes text-2xl"></i>
            <span class="text-[10px] font-medium">Historial</span>
        </button>
        <button onclick="alert('PrÃ³ximamente')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-primary w-16">
            <i class="ph-fill ph-chart-bar text-2xl"></i>
            <span class="text-[10px] font-medium">Stats</span>
        </button>
    </nav>

    <!-- MODALS (Hidden by default) -->
    
    <!-- 1. Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-white w-full md:max-w-md md:rounded-2xl rounded-t-2xl shadow-2xl h-[90vh] md:h-auto flex flex-col animate-fade-in">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 md:rounded-t-2xl">
                <h3 id="modalTitle" class="font-bold text-gray-800">Registrar Movimiento</h3>
                <button onclick="closeModal('transactionModal')" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600"><i class="ph-bold ph-x"></i></button>
            </div>
            <div class="p-5 overflow-y-auto flex-1">
                <form id="txForm" class="space-y-4">
                    <input type="hidden" id="txId">
                    
                    <!-- Type Selector -->
                    <div class="grid grid-cols-3 gap-2 bg-gray-100 p-1 rounded-xl">
                        <button type="button" onclick="setTxType('gasto')" class="type-btn active py-2 rounded-lg text-sm font-medium transition text-center" data-type="gasto">Gasto</button>
                        <button type="button" onclick="setTxType('ingreso')" class="type-btn py-2 rounded-lg text-sm font-medium transition text-center" data-type="ingreso">Ingreso</button>
                        <button type="button" onclick="setTxType('transferencia')" class="type-btn py-2 rounded-lg text-sm font-medium transition text-center" data-type="transferencia">Transf.</button>
                    </div>
                    <input type="hidden" id="txType" value="gasto">

                    <!-- Method -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Origen</label>
                            <select id="txMethod" class="w-full border-gray-200 rounded-xl p-3 bg-gray-50 text-sm focus:ring-2 focus:ring-primary outline-none" onchange="handleMethodChange()">
                                <option value="debito">ðŸ’³ DÃ©bito</option>
                                <option value="efectivo">ðŸ’µ Efectivo</option>
                                <option value="nequi">ðŸ“± Nequi</option>
                                <option value="credito">ðŸ’³ CrÃ©dito</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Monto</label>
                            <input type="number" id="txAmount" class="w-full border-gray-200 rounded-xl p-3 bg-gray-50 text-sm font-bold text-gray-800 focus:ring-2 focus:ring-primary outline-none" placeholder="0" required oninput="calculateInstallment()">
                        </div>
                    </div>

                    <!-- Credit Specifics -->
                    <div id="creditFields" class="hidden bg-indigo-50 border border-indigo-100 p-3 rounded-xl space-y-3">
                        <div>
                            <label class="text-xs font-bold text-indigo-800 mb-1 block">Tarjeta / Cupo</label>
                            <select id="txCard" class="w-full border-indigo-200 rounded-lg p-2 text-sm" onchange="calculateInstallment()"></select>
                        </div>
                        <div id="installmentsField" class="flex gap-3">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-indigo-800 mb-1 block">Cuotas</label>
                                <select id="txInstallments" class="w-full border-indigo-200 rounded-lg p-2 text-sm" onchange="calculateInstallment()">
                                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    <option value="6">6</option><option value="12">12</option><option value="24">24</option><option value="36">36</option>
                                </select>
                            </div>
                            <div class="w-1/2 flex flex-col justify-center items-end">
                                <span class="text-[10px] text-gray-500">Cuota aprox:</span>
                                <span id="txInstallmentVal" class="font-bold text-indigo-700">$0</span>
                                <span id="txInterestLabel" class="text-[10px] text-gray-400"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer Dest -->
                    <div id="transferFields" class="hidden bg-blue-50 border border-blue-100 p-3 rounded-xl space-y-2">
                         <label class="text-xs font-bold text-blue-800 mb-1 block">Destino</label>
                         <select id="txDestMethod" class="w-full border-blue-200 rounded-lg p-2 text-sm" onchange="handleDestChange()">
                             <option value="debito">DÃ©bito</option>
                             <option value="efectivo">Efectivo</option>
                             <option value="nequi">Nequi</option>
                             <option value="credito">Pagar Tarjeta</option>
                         </select>
                         <select id="txDestCard" class="w-full border-blue-200 rounded-lg p-2 text-sm hidden"></select>
                    </div>

                    <!-- Details -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">CategorÃ­a</label>
                        <select id="txCategory" class="w-full border-gray-200 rounded-xl p-3 bg-gray-50 text-sm outline-none"></select>
                    </div>

                    <div>
                         <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">DescripciÃ³n</label>
                         <input type="text" id="txDesc" class="w-full border-gray-200 rounded-xl p-3 bg-gray-50 text-sm outline-none" placeholder="Ej: Mercado D1">
                    </div>

                    <input type="date" id="txDate" class="w-full border-gray-200 rounded-xl p-3 bg-gray-50 text-sm outline-none" required>

                    <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition">Guardar Movimiento</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 2. Card Modal -->
    <div id="cardModal" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-fade-in">
            <h3 class="font-bold text-lg text-gray-800 mb-4">Configurar Tarjeta</h3>
            <form id="cardForm" class="space-y-4">
                <input type="hidden" id="cardFormId">
                <input type="text" id="cardFormName" placeholder="Nombre (ej: Nu)" class="w-full border p-3 rounded-xl" required>
                <input type="text" id="cardFormBank" placeholder="Banco / Franquicia" class="w-full border p-3 rounded-xl">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs text-gray-500">Cupo</label><input type="number" id="cardFormLimit" class="w-full border p-2 rounded-xl" required></div>
                    <div><label class="text-xs text-gray-500">Deuda Ini.</label><input type="number" id="cardFormDebt" class="w-full border p-2 rounded-xl" value="0"></div>
                </div>
                <div><label class="text-xs text-gray-500">Color</label><input type="color" id="cardFormColor" class="w-full h-10 rounded-lg" value="#4F46E5"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('cardModal')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-medium">Cancelar</button>
                    <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Balance Modal -->
    <div id="balanceModal" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-fade-in">
            <h3 class="font-bold text-lg text-gray-800 mb-2">Ajustar Saldos Iniciales</h3>
            <p class="text-xs text-gray-500 mb-4">Ingresa el dinero real que tienes hoy para calibrar el sistema.</p>
            <form id="balanceForm" class="space-y-3">
                <div><label class="text-xs font-bold text-gray-500">Bancos (DÃ©bito)</label><input type="number" id="balDebito" class="w-full border p-3 rounded-xl font-bold text-gray-800"></div>
                <div><label class="text-xs font-bold text-gray-500">Efectivo</label><input type="number" id="balEfectivo" class="w-full border p-3 rounded-xl font-bold text-gray-800"></div>
                <div><label class="text-xs font-bold text-gray-500">Nequi / Digital</label><input type="number" id="balNequi" class="w-full border p-3 rounded-xl font-bold text-gray-800"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('balanceModal')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-medium">Cancelar</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Actualizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logic Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIG & GLOBALS ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        let userId = null;
        let cards = [];
        let transactions = [];
        let initialBalances = { debito: 0, efectivo: 0, nequi: 0 };
        let chartInstance = null;

        const CATEGORIES = {
            gasto: ['Vivienda', 'Servicios', 'AlimentaciÃ³n', 'Transporte', 'EducaciÃ³n', 'Salud', 'Personal', 'Entretenimiento', 'Deudas', 'Otros'],
            ingreso: ['Salario', 'Negocio', 'Inversiones', 'Otros'],
            transferencia: ['Transferencia']
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('connectionStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> En lÃ­nea';
                initListeners();
            } else {
                document.getElementById('connectionStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Desconectado';
                signInAnonymously(auth).catch(console.error);
            }
        });

        function initListeners() {
            // Balances
            onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'config', 'initial_balances'), s => {
                if(s.exists()) initialBalances = s.data();
                recalc();
            });
            // Cards
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'cards'), s => {
                cards = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderCards();
                recalc();
            });
            // Transactions (Sorted in client to avoid index requirement on ephemeral env)
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'transactions'), s => {
                let raw = s.docs.map(d => ({id: d.id, ...d.data()}));
                raw.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); // Sort desc
                transactions = raw;
                document.getElementById('tx-count').innerText = `${transactions.length} regs`;
                renderHistory();
                recalc();
            });
        }

        // --- CORE LOGIC ---
        function recalc() {
            let bal = { ...initialBalances };
            let debts = {};
            let expensesByCat = {};
            let income=0, expense=0;

            // Init debt map
            cards.forEach(c => debts[c.id] = c.initialDebt || 0);

            // Process Transactions
            transactions.forEach(t => {
                const m = parseFloat(t.monto) || 0;
                const method = t.metodo || t.metodoPago;
                
                if (t.tipo === 'ingreso') {
                    income += m;
                    if(bal[method] !== undefined) bal[method] += m;
                }
                else if (t.tipo === 'gasto') {
                    expense += m;
                    if(t.categoria) expensesByCat[t.categoria] = (expensesByCat[t.categoria] || 0) + m;

                    if (method === 'credito') {
                        // Find card by ID or Name (Legacy support)
                        let c = cards.find(c => c.id === t.cardId) || cards.find(c => c.name === t.tarjetaCredito);
                        if(c) debts[c.id] = (debts[c.id] || 0) + m;
                    } else {
                        if(bal[method] !== undefined) bal[method] -= m;
                    }
                }
                else if (t.tipo === 'transferencia') {
                    if(bal[method] !== undefined) bal[method] -= m;
                    
                    if (t.metodoDestino === 'credito') {
                        let c = cards.find(c => c.id === t.cardDestId) || cards.find(c => c.name === t.tarjetaDestino);
                        if(c) debts[c.id] = (debts[c.id] || 0) - m;
                    } else {
                         if(bal[t.metodoDestino] !== undefined) bal[t.metodoDestino] += m;
                    }
                }
            });

            // Update UI
            updateText('dash-deb', bal.debito);
            updateText('dash-efe', bal.efectivo);
            updateText('saldoDebito', bal.debito); // Legacy tab
            updateText('saldoEfectivo', bal.efectivo);
            updateText('saldoNequi', bal.nequi);
            updateText('saldoTotal', bal.debito + bal.efectivo + bal.nequi);
            updateText('dash-liquid', bal.debito + bal.efectivo + bal.nequi);
            
            const totalDebt = Object.values(debts).reduce((a,b) => a+b, 0);
            const totalLimit = cards.reduce((a,b) => a+(b.limit||0), 0);
            updateText('dash-debt', totalDebt);
            updateText('dash-limit', totalLimit - totalDebt);
            updateText('dash-flow', income - expense);

            // Update individual card UI debt
            cards.forEach(c => {
                const el = document.getElementById(`debt-${c.id}`);
                const prog = document.getElementById(`prog-${c.id}`);
                const avail = document.getElementById(`avail-${c.id}`);
                if(el) {
                    const d = debts[c.id] || 0;
                    el.innerText = formatCOP(d);
                    if(avail) avail.innerText = formatCOP(c.limit - d);
                    if(prog) prog.style.width = `${Math.min(100, (d/c.limit)*100)}%`;
                }
            });

            renderChart(expensesByCat);
        }

        // --- RENDERING ---
        function renderCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            cards.forEach(c => {
                const div = document.createElement('div');
                const isAddi = c.name.toLowerCase().includes('addi');
                div.className = `relative h-48 rounded-2xl p-5 text-white shadow-lg overflow-hidden transition transform hover:-translate-y-1 group`;
                div.style.background = c.color.includes('#') ? `linear-gradient(135deg, ${c.color}, #1f2937)` : c.color;
                
                div.innerHTML = `
                    <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.editCard('${c.id}')" class="bg-white/20 p-1.5 rounded-full hover:bg-white/40"><i class="ph-bold ph-pencil-simple"></i></button>
                        <button onclick="window.deleteCard('${c.id}')" class="bg-white/20 p-1.5 rounded-full hover:bg-red-500/80"><i class="ph-bold ph-trash"></i></button>
                    </div>
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-6 bg-yellow-300/80 rounded ${isAddi ? 'opacity-0' : ''}"></div>
                        <span class="font-bold italic opacity-80 text-sm">${c.bank || 'Credito'}</span>
                    </div>
                    <div class="mb-4">
                        <h3 class="text-lg font-mono tracking-widest truncate">${c.name}</h3>
                        ${isAddi ? '<span class="text-[10px] bg-white/20 px-2 py-0.5 rounded text-green-200">0% interÃ©s â‰¤3 cuotas</span>' : ''}
                    </div>
                    <div class="flex justify-between items-end text-sm mt-auto">
                        <div><p class="text-[10px] uppercase opacity-70">Deuda</p><p class="font-bold text-lg" id="debt-${c.id}">$0</p></div>
                        <div class="text-right"><p class="text-[10px] uppercase opacity-70">Disponible</p><p class="font-medium" id="avail-${c.id}">$0</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full h-1.5 bg-black/20"><div id="prog-${c.id}" class="h-full bg-white/90 transition-all duration-500" style="width:0%"></div></div>
                `;
                container.appendChild(div);
            });
        }

        function renderHistory() {
            const tbody = document.getElementById('tx-table-body');
            tbody.innerHTML = '';
            transactions.forEach(t => {
                const row = document.createElement('tr');
                const isIngreso = t.tipo === 'ingreso';
                row.className = 'hover:bg-gray-50 transition-colors group border-b border-gray-50';
                
                let methodBadge = `<span class="px-2 py-1 rounded text-xs font-bold ${t.metodo==='credito'?'bg-purple-100 text-purple-700':'bg-gray-100 text-gray-600'}">${t.metodo||t.metodoPago}</span>`;
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-gray-500">${t.fecha}</td>
                    <td class="px-4 py-3"><span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${isIngreso?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${t.tipo}</span></td>
                    <td class="px-4 py-3"><div class="font-medium text-gray-900">${t.categoria}</div><div class="text-xs text-gray-400">${t.descripcion}</div></td>
                    <td class="px-4 py-3">${methodBadge}</td>
                    <td class="px-4 py-3 text-right font-bold ${isIngreso?'text-green-600':'text-gray-700'}">${formatCOP(t.monto)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="window.editTx('${t.id}')" class="text-blue-400 hover:text-blue-600 mx-1"><i class="ph-bold ph-pencil-simple"></i></button>
                        <button onclick="window.deleteTx('${t.id}')" class="text-red-300 hover:text-red-500 mx-1"><i class="ph-bold ph-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderChart(data) {
            const ctx = document.getElementById('mainChart');
            if(!ctx) return;
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ data: Object.values(data), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { usePointStyle: true } } } }
            });
        }

        // --- UI HELPERS ---
        window.formatCOP = (val) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(val || 0);
        const updateText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = window.formatCOP(val); };
        
        // --- INTERACTION HANDLERS ---
        window.switchView = (view) => {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('text-primary', 'active'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            // Desktop logic
            document.getElementById('tab-dashboard').style.display = view === 'dashboard' ? 'block' : 'none';
            document.getElementById('tab-tarjetas').style.display = view === 'cards' ? 'block' : 'none';
            document.getElementById('tab-historial').style.display = view === 'history' ? 'block' : 'none';
            document.getElementById('tab-transacciones').style.display = 'none'; // Modal only
            document.getElementById('tab-estadisticas').style.display = 'none';
        };

        // --- MODAL LOGIC ---
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
            if(id === 'transactionModal') {
                // Populate Selects
                const cardSel = document.getElementById('txCard');
                cardSel.innerHTML = '<option value="">Seleccione...</option>' + cards.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                const destCardSel = document.getElementById('txDestCard');
                destCardSel.innerHTML = cardSel.innerHTML;
                // Default to gasto
                window.setTxType('gasto');
                document.getElementById('txDate').valueAsDate = new Date();
            }
            if(id === 'balanceModal') {
                document.getElementById('balDebito').value = initialBalances.debito;
                document.getElementById('balEfectivo').value = initialBalances.efectivo;
                document.getElementById('balNequi').value = initialBalances.nequi;
            }
        };
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
            // Reset forms
            if(id === 'transactionModal') {
                document.getElementById('txForm').reset();
                document.getElementById('txId').value = '';
            }
        };

        // --- FORM HANDLERS ---
        window.setTxType = (type) => {
            document.getElementById('txType').value = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                if(b.dataset.type === type) { b.classList.add('bg-white', 'text-primary', 'shadow-sm'); } 
                else { b.classList.remove('bg-white', 'text-primary', 'shadow-sm'); b.classList.add('text-gray-500'); }
            });
            // Update Categories
            const catSel = document.getElementById('txCategory');
            catSel.innerHTML = '<option value="">Seleccione...</option>';
            (CATEGORIES[type] || []).forEach(c => catSel.innerHTML += `<option>${c}</option>`);
            
            // Toggle Fields
            document.getElementById('creditFields').classList.add('hidden');
            document.getElementById('transferFields').classList.add('hidden');
            
            if(type === 'transferencia') document.getElementById('transferFields').classList.remove('hidden');
            else window.handleMethodChange();
        };

        window.handleMethodChange = () => {
            const m = document.getElementById('txMethod').value;
            const type = document.getElementById('txType').value;
            const isCred = m === 'credito';
            
            if(isCred) document.getElementById('creditFields').classList.remove('hidden');
            else document.getElementById('creditFields').classList.add('hidden');

            // Show installments only for expense + credit
            const instDiv = document.getElementById('installmentsField');
            if(isCred && type === 'gasto') instDiv.classList.remove('hidden');
            else instDiv.classList.add('hidden');
            
            window.calculateInstallment();
        };

        window.handleDestChange = () => {
            const m = document.getElementById('txDestMethod').value;
            const cardSel = document.getElementById('txDestCard');
            if(m === 'credito') cardSel.classList.remove('hidden');
            else cardSel.classList.add('hidden');
        };

        window.calculateInstallment = () => {
            const m = parseFloat(document.getElementById('txAmount').value) || 0;
            const c = parseInt(document.getElementById('txInstallments').value);
            const cardId = document.getElementById('txCard').value;
            const card = cards.find(x => x.id === cardId);
            const isAddi = card && card.name.toLowerCase().includes('addi');
            
            if (m > 0) {
                let rate = (isAddi && c <= 3) ? 0 : 0.019;
                let val = 0;
                if (c === 1 || rate === 0) val = m / c;
                else val = m * (rate * Math.pow(1+rate, c)) / (Math.pow(1+rate, c) - 1);
                
                document.getElementById('txInstallmentVal').innerText = formatCOP(val);
                document.getElementById('txInterestLabel').innerText = rate === 0 ? 'Sin interÃ©s' : '1.9% M.V.';
            }
        };

        // --- SAVE & DELETE ACTIONS ---
        document.getElementById('balanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!userId) return;
            const d = {
                debito: parseFloat(document.getElementById('balDebito').value)||0,
                efectivo: parseFloat(document.getElementById('balEfectivo').value)||0,
                nequi: parseFloat(document.getElementById('balNequi').value)||0
            };
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'initial_balances'), d);
            closeModal('balanceModal');
        });

        document.getElementById('cardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cardFormId').value;
            const data = {
                name: document.getElementById('cardFormName').value,
                bank: document.getElementById('cardFormBank').value,
                limit: parseFloat(document.getElementById('cardFormLimit').value),
                initialDebt: parseFloat(document.getElementById('cardFormDebt').value),
                color: document.getElementById('cardFormColor').value
            };
            const col = collection(db, 'artifacts', appId, 'users', userId, 'cards');
            if(id) await updateDoc(doc(col, id), data); else await addDoc(col, data);
            closeModal('cardModal');
        });

        document.getElementById('txForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('txId').value;
            const data = {
                tipo: document.getElementById('txType').value,
                metodo: document.getElementById('txMethod').value,
                monto: parseFloat(document.getElementById('txAmount').value),
                categoria: document.getElementById('txCategory').value,
                descripcion: document.getElementById('txDesc').value,
                fecha: document.getElementById('txDate').value,
                timestamp: new Date().toISOString()
            };
            
            if(data.metodo === 'credito') {
                data.cardId = document.getElementById('txCard').value;
                if(data.tipo === 'gasto') data.cuotas = parseInt(document.getElementById('txInstallments').value);
            }
            if(data.tipo === 'transferencia') {
                data.metodoDestino = document.getElementById('txDestMethod').value;
                if(data.metodoDestino === 'credito') data.cardDestId = document.getElementById('txDestCard').value;
            }

            const col = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            if(id) await updateDoc(doc(col, id), data); else await addDoc(col, data);
            closeModal('transactionModal');
        });

        window.deleteTx = async(id) => { if(confirm('Â¿Borrar movimiento?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'transactions', id)); };
        window.deleteCard = async(id) => { if(confirm('Â¿Borrar tarjeta?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'cards', id)); };

        // --- EDIT LOADERS ---
        window.editCard = (id) => {
            const c = cards.find(x => x.id === id);
            if(!c) return;
            document.getElementById('cardFormId').value = c.id;
            document.getElementById('cardFormName').value = c.name;
            document.getElementById('cardFormBank').value = c.bank;
            document.getElementById('cardFormLimit').value = c.limit;
            document.getElementById('cardFormDebt').value = c.initialDebt;
            document.getElementById('cardFormColor').value = c.color;
            openModal('cardModal');
        };

        window.editTx = (id) => {
            const t = transactions.find(x => x.id === id);
            if(!t) return;
            openModal('transactionModal');
            // Pre-fill logic
            window.setTxType(t.tipo);
            document.getElementById('txId').value = t.id;
            document.getElementById('txMethod').value = t.metodo || t.metodoPago;
            window.handleMethodChange();
            if(t.cardId) document.getElementById('txCard').value = t.cardId;
            if(t.cuotas) document.getElementById('txInstallments').value = t.cuotas;
            if(t.tipo === 'transferencia') {
                document.getElementById('txDestMethod').value = t.metodoDestino;
                window.handleDestChange();
                if(t.cardDestId) document.getElementById('txDestCard').value = t.cardDestId;
            }
            document.getElementById('txAmount').value = t.monto;
            document.getElementById('txCategory').value = t.categoria;
            document.getElementById('txDesc').value = t.descripcion;
            document.getElementById('txDate').value = t.fecha;
            window.calculateInstallment();
        };
        
        // Default View
        window.switchView('dashboard');
    </script>
</body>
</html>