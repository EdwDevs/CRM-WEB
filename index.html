<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Financiero v4.1 - Fixed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #5046e5;
            --primary-dark: #3730a3;
            --primary-light: #818cf8;
            --secondary: #1e1b4b;
            --accent: #0ea5e9;
            --accent-light: #38bdf8;
            
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --bg-elevated: #ffffff;
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --text-inverse: #ffffff;
            
            --success: #10b981;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --info: #3b82f6;
            --info-light: #dbeafe;
            --credit: #ec4899;
            --credit-light: #fce7f3;
            
            --ai-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            --hero-gradient: linear-gradient(135deg, #5046e5 0%, #7c3aed 50%, #0ea5e9 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.03);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.03);
            --shadow-glow: 0 0 40px -10px rgba(80, 70, 229, 0.3);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --nav-width: 280px;
            --header-height: 72px;
            
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);

            --surface-padding: 24px;
            --card-padding: 28px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --bg-elevated: #334155;
            
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --shadow-glow: 0 0 40px -10px rgba(80, 70, 229, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background-color var(--transition-base), color var(--transition-base);
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation: none !important;
                transition: none !important;
                scroll-behavior: auto !important;
            }
        }

        .sidebar {
            width: var(--nav-width);
            background: var(--bg-surface);
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 50;
            transition: transform var(--transition-base), box-shadow var(--transition-base), opacity var(--transition-base);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(80, 70, 229, 0.03) 0%, transparent 100%);
            pointer-events: none;
        }

        .brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 24px;
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            position: relative;
            z-index: 1;
        }

        .brand i {
            background: var(--hero-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
            margin-right: 8px;
        }

        .brand span {
            background: var(--hero-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            flex: 1;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            z-index: 1;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--hero-gradient);
            border-radius: 0 3px 3px 0;
            transition: height var(--transition-fast);
        }

        .nav-item:hover {
            background: rgba(80, 70, 229, 0.06);
            color: var(--primary);
            transform: translateX(1px);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
        }

        .nav-item:hover::before {
            height: 24px;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(80, 70, 229, 0.1) 0%, rgba(14, 165, 233, 0.05) 100%);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-item.active::before {
            height: 32px;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
            transition: transform var(--transition-fast);
        }

        .nav-item:hover i {
            transform: scale(1.1);
        }

        .nav-item.ai-nav {
            color: var(--accent);
        }

        .nav-item.ai-nav.active {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(37, 99, 235, 0.08) 100%);
            color: var(--accent);
        }

        .nav-item.ai-nav.active::before {
            background: var(--ai-gradient);
        }

        .nav-item.ai-nav i {
            color: var(--accent);
        }

        .theme-toggle {
            margin: 12px 16px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            background: var(--bg-body);
            border: 1px solid rgba(148, 163, 184, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .theme-toggle:hover {
            background: rgba(80, 70, 229, 0.08);
            border-color: rgba(80, 70, 229, 0.2);
            color: var(--primary);
        }

        .theme-toggle i {
            font-size: 1rem;
            transition: transform var(--transition-fast);
        }

        .theme-toggle:hover i {
            transform: rotate(15deg);
        }

        .main-wrapper {
            flex: 1;
            margin-left: var(--nav-width);
            height: 100vh;
            overflow-y: auto;
            position: relative;
            padding-bottom: 80px;
        }

        .main-wrapper::before {
            content: '';
            position: fixed;
            top: 0;
            right: 0;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(80, 70, 229, 0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .top-header {
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 40;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 32px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
            gap: 16px;
        }

        [data-theme="dark"] .top-header {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(148, 163, 184, 0.08);
        }

        .page-title {
            font-size: clamp(1.1rem, 1.6vw, 1.35rem);
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .hamburger-btn {
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: var(--bg-surface);
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-xs);
            transition: all var(--transition-fast);
        }

        .hamburger-btn:hover {
            color: var(--primary);
            border-color: rgba(80, 70, 229, 0.4);
            box-shadow: var(--shadow-sm);
        }

        .hamburger-btn i {
            font-size: 1.1rem;
        }

        .date-filter-pill {
            background: var(--bg-surface);
            border: 1px solid rgba(148, 163, 184, 0.15);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-xs);
            transition: all var(--transition-fast);
        }

        [data-theme="dark"] .date-filter-pill {
            background: rgba(15, 23, 42, 0.85);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .date-filter-pill:hover {
            border-color: rgba(80, 70, 229, 0.3);
            box-shadow: var(--shadow-md);
        }

        .date-filter-pill i {
            color: var(--primary);
        }

        .date-filter-pill input {
            border: none;
            outline: none;
            font-weight: 600;
            color: var(--primary);
            font-family: inherit;
            background: transparent;
            min-width: 120px;
        }

        .content-container {
            --section-gap: 28px;
            padding: 32px;
            max-width: 1280px;
            margin: 0 auto;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: var(--section-gap);
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: var(--card-padding);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(148, 163, 184, 0.08);
            transition: box-shadow var(--transition-slow), transform var(--transition-slow), border-color var(--transition-fast);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card:active {
            transform: translateY(1px) scale(0.98);
        }

        [data-theme="dark"] .card {
            border-color: rgba(148, 163, 184, 0.1);
        }
        
        .hero-balance {
            background: var(--hero-gradient);
            color: white;
            padding: 36px 32px;
            border-radius: var(--radius-xl);
            margin-bottom: 36px;
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .hero-balance::before {
            content: '';
            position: absolute;
            right: -50px;
            top: -50px;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
        }

        .hero-balance::after {
            content: '';
            position: absolute;
            right: 80px;
            bottom: -30px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .hero-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .hero-amount {
            font-size: clamp(2.1rem, 3.5vw, 2.9rem);
            font-weight: 800;
            letter-spacing: -0.03em;
            position: relative;
            z-index: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 32px;
            margin-bottom: 32px;
        }

        .mini-stat {
            background: var(--bg-surface);
            padding: var(--surface-padding);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xs);
            border: 1px solid rgba(148, 163, 184, 0.08);
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .mini-stat:hover {
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .mini-stat {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .mini-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .mini-label i {
            font-size: 0.9rem;
        }

        .mini-value {
            font-size: clamp(1.1rem, 1.6vw, 1.4rem);
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .mini-stat.debt .mini-value {
            color: var(--danger);
        }

        .mini-stat.income .mini-value {
            color: var(--success);
        }

        .advanced-filters {
            background: var(--bg-body);
            padding: var(--surface-padding);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(148, 163, 184, 0.1);
            margin-bottom: 32px;
        }

        [data-theme="dark"] .advanced-filters {
            background: var(--bg-elevated);
            border-color: rgba(148, 163, 184, 0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-control {
            padding: 12px 16px;
            border: 1px solid rgba(71, 85, 105, 0.75);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            width: 100%;
            background: var(--bg-surface);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .filter-control:focus {
            border-color: #1d4ed8;
            box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.3);
            outline: none;
        }

        .filter-control:focus-visible {
            border-color: #1d4ed8;
            box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.5);
            outline: 2px solid rgba(29, 78, 216, 0.8);
            outline-offset: 2px;
        }

        [data-theme="dark"] .filter-control {
            border-color: rgba(226, 232, 240, 0.7);
            background: var(--bg-body);
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            align-items: center;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            padding-top: 20px;
        }

        [data-theme="dark"] .filter-actions {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .btn-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .btn-clear:hover {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
            transform: translateY(-1px);
        }

        .btn-clear:focus-visible {
            outline: 2px solid rgba(100, 116, 139, 0.9);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(100, 116, 139, 0.35);
        }
        
        .filter-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
        }

        .summary-pill {
            background: var(--bg-surface);
            padding: 10px 20px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            border: 1px solid rgba(148, 163, 184, 0.15);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-xs);
        }

        [data-theme="dark"] .summary-pill {
            border-color: rgba(148, 163, 184, 0.15);
        }

        [data-theme="dark"] .summary-pill.inc {
            background: rgba(16, 185, 129, 0.18);
            border-color: rgba(16, 185, 129, 0.35);
        }

        [data-theme="dark"] .summary-pill.exp {
            background: rgba(239, 68, 68, 0.18);
            border-color: rgba(239, 68, 68, 0.35);
        }

        .summary-pill.inc {
            color: var(--success);
            background: var(--success-light);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .summary-pill.exp {
            color: var(--danger);
            background: var(--danger-light);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .ai-welcome-card {
            background: var(--ai-gradient);
            color: white;
            padding: 40px 32px;
            border-radius: var(--radius-xl);
            text-align: center;
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg), 0 10px 25px -5px rgba(14, 165, 233, 0.3);
            position: relative;
            overflow: hidden;
        }

        .ai-welcome-card::before {
            content: '';
            position: absolute;
            right: -100px;
            top: -100px;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .ai-welcome-card h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .ai-welcome-card p {
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto 24px;
            font-size: 0.95rem;
        }

        .btn-ai-action {
            background: white;
            color: var(--accent);
            padding: 16px 40px;
            border-radius: var(--radius-full);
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-ai-action:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .btn-ai-action:active {
            transform: translateY(-1px);
        }

        .ai-response-container {
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        .ai-loading {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 60px;
            text-align: center;
        }

        .ai-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s infinite linear;
            margin-bottom: 20px;
        }

        .ai-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(14, 165, 233, 0.1);
        }

        .score-badge {
            background: var(--hero-gradient);
            color: #fff;
            padding: 8px 20px;
            border-radius: var(--radius-full);
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: var(--shadow-md);
        }

        .report-section {
            margin-bottom: 32px;
            padding: 24px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(148, 163, 184, 0.1);
            background: linear-gradient(to right, var(--bg-body), var(--bg-surface));
        }

        [data-theme="dark"] .report-section {
            background: linear-gradient(to right, var(--bg-elevated), var(--bg-surface));
        }

        .report-section h4 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .insight-item {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all var(--transition-fast);
        }

        .insight-item:hover {
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .insight-item {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .insight-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .insight-val {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .ai-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-list li {
            position: relative;
            padding-left: 28px;
            margin-bottom: 14px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .ai-list li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
            font-size: 0.9rem;
            top: 2px;
        }

        .text-good { color: #16a34a !important; }
        .text-warn { color: #ca8a04 !important; }
        .text-bad { color: #dc2626 !important; }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input, select {
            padding: 14px 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--bg-body);
            color: var(--text-primary);
            outline: none;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        [data-theme="dark"] input, [data-theme="dark"] select {
            border-color: rgba(148, 163, 184, 0.2);
            background: var(--bg-elevated);
        }

        input:focus, select:focus {
            border-color: var(--primary);
            background: var(--bg-surface);
            box-shadow: 0 0 0 4px rgba(80, 70, 229, 0.08);
        }

        button {
            border: none;
            font-family: inherit;
            cursor: pointer;
            touch-action: manipulation;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 22px;
            border-radius: var(--radius-md);
            font-weight: 600;
            border: 1px solid transparent;
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-slow), box-shadow var(--transition-slow), background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast), filter var(--transition-fast);
            text-shadow: 0 1px 1px rgba(15, 23, 42, 0.25);
            touch-action: manipulation;
        }

        .btn.is-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
            cursor: wait;
        }

        .btn.is-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .btn:active {
            transform: translateY(1px) scale(0.98);
        }

        .btn--block {
            width: 100%;
        }

        .btn--sm {
            padding: 8px 14px;
            font-size: 0.85rem;
        }

        .btn--md {
            padding: 10px 20px;
            font-size: 0.95rem;
        }

        .btn--lg {
            padding: 14px 28px;
            font-size: 1rem;
        }

        .btn--icon {
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: transparent;
            box-shadow: none;
            text-shadow: none;
            font-size: 1.35rem;
        }

        .btn--icon:hover {
            background: rgba(148, 163, 184, 0.12);
            color: var(--primary);
        }

        .btn--full {
            width: 100%;
            flex: 1;
            justify-content: center;
        }

        .btn--primary {
            background: var(--hero-gradient);
            color: var(--text-inverse);
        }

        .btn--primary:hover {
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.25), 0 0 0 3px rgba(30, 64, 175, 0.3);
            transform: translateY(-2px);
            filter: brightness(1.07) saturate(1.05);
        }

        .btn--primary:focus-visible {
            outline: 3px solid rgba(30, 64, 175, 0.85);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.45), 0 8px 18px rgba(30, 64, 175, 0.25);
        }

        .btn--primary:active {
            transform: translateY(1px) scale(0.98);
        }

        .btn--secondary {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border-color: rgba(71, 85, 105, 0.4);
            text-shadow: none;
        }

        .btn--secondary:hover {
            background: rgba(148, 163, 184, 0.14);
            border-color: rgba(51, 65, 85, 0.7);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
            transform: translateY(-1px);
        }

        .btn--secondary:focus-visible {
            outline: 3px solid rgba(51, 65, 85, 0.85);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(51, 65, 85, 0.35), 0 8px 18px rgba(15, 23, 42, 0.12);
        }

        .btn--secondary:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: var(--shadow-xs);
        }

        .btn--ghost {
            background: transparent;
            color: var(--text-secondary);
            border-color: rgba(148, 163, 184, 0.3);
            text-shadow: none;
        }

        .btn--ghost:hover {
            background: rgba(148, 163, 184, 0.12);
            color: var(--text-primary);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
            transform: translateY(-1px);
        }

        .btn--ghost:focus-visible {
            outline: 2px solid rgba(100, 116, 139, 0.85);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(100, 116, 139, 0.3);
        }

        .btn--ghost:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: var(--shadow-xs);
        }

        .btn--danger {
            background: var(--danger-gradient);
            color: var(--text-inverse);
        }

        .btn--danger:hover {
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.3), 0 0 0 3px rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
            filter: brightness(1.05) saturate(1.05);
        }

        .btn--danger:focus-visible {
            outline: 3px solid rgba(220, 38, 38, 0.85);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.35), 0 8px 18px rgba(185, 28, 28, 0.25);
        }

        .btn--danger:active {
            transform: translateY(1px) scale(0.98);
        }

        .btn-icon-action--info {
            color: var(--info);
        }

        .btn-icon-action--danger {
            color: var(--danger);
        }

        .btn-icon-action--success {
            color: var(--success);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--bg-body);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
            color: var(--text-secondary);
        }

        tr:hover td {
            background: var(--bg-body);
        }

        tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .table-container {
                border: none;
                overflow: visible;
            }

            .table-container table {
                font-size: 0.9rem;
            }

            .table-container thead {
                display: none;
            }

            .table-container table,
            .table-container tbody,
            .table-container tr,
            .table-container td {
                display: block;
                width: 100%;
            }

            .table-container tr {
                background: var(--bg-surface);
                border: 1px solid rgba(148, 163, 184, 0.18);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-xs);
                margin-bottom: 14px;
                overflow: hidden;
            }

            .table-container td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                border-bottom: 1px solid rgba(148, 163, 184, 0.12);
            }

            .table-container td::before {
                content: "";
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.72rem;
                letter-spacing: 0.05em;
                color: var(--text-muted);
            }

            .table-container td:nth-child(1)::before { content: "Fecha"; }
            .table-container td:nth-child(2)::before { content: "Tipo"; }
            .table-container td:nth-child(3)::before { content: "Método"; }
            .table-container td:nth-child(4)::before { content: "Categoría"; }
            .table-container td:nth-child(5)::before { content: "Descripción"; }
            .table-container td:nth-child(6)::before { content: "Monto"; }
            .table-container td:nth-child(7)::before { content: "Acciones"; }

            .table-container td:last-child {
                border-bottom: none;
                justify-content: flex-start;
            }

            .table-container td:last-child::before {
                flex: 0 0 auto;
            }

            .table-container td:last-child .btn-icon-action {
                margin-right: 8px;
            }
        }

        .btn-icon-action {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 8px;
            margin-right: 4px;
            min-width: 44px;
            min-height: 44px;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            transition: all var(--transition-fast);
            touch-action: manipulation;
        }

        .btn-icon-action:hover {
            background: rgba(148, 163, 184, 0.1);
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .quota-card {
            border: 1px solid rgba(148, 163, 184, 0.1);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            background: var(--bg-surface);
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: var(--shadow-xs);
            transition: all var(--transition-fast);
        }

        .quota-card:hover {
            box-shadow: var(--shadow-sm);
            border-color: rgba(148, 163, 184, 0.2);
        }

        [data-theme="dark"] .quota-card {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .quota-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .quota-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .card-status-item {
            margin-bottom: 12px;
            padding: 20px;
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-xs);
            transition: all var(--transition-fast);
        }

        .card-status-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateX(4px);
        }

        [data-theme="dark"] .card-status-item {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .card-status-item .card-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-status-item .card-debt {
            color: var(--danger);
            font-weight: 700;
            font-size: 1.05rem;
        }

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-surface);
            height: 78px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            z-index: 90;
            justify-content: space-around;
            align-items: center;
            padding: 8px 12px calc(env(safe-area-inset-bottom) + 4px);
            box-shadow: 0 -4px 20px -5px rgba(0, 0, 0, 0.1);
            gap: 6px;
        }

        [data-theme="dark"] .mobile-nav {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .mob-link {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-width: 44px;
            min-height: 44px;
            color: var(--text-muted);
            font-size: 0.7rem;
            gap: 4px;
            background: none;
            border: none;
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
            touch-action: manipulation;
        }

        .mob-link i {
            font-size: 1.2rem;
            margin-bottom: 2px;
            transition: transform var(--transition-fast);
        }

        .mob-link:hover i {
            transform: translateY(-2px);
        }

        .mob-link.active {
            background: linear-gradient(135deg, rgba(80, 70, 229, 0.1) 0%, rgba(14, 165, 233, 0.05) 100%);
            color: var(--primary);
            font-weight: 600;
            border-radius: var(--radius-sm);
        }

        .mob-link.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--hero-gradient);
            border-radius: 0 0 3px 3px;
        }

        .mob-link.ai-mob {
            color: var(--accent);
        }

        .mob-link.ai-mob.active {
            color: var(--accent);
        }

        .mob-link.ai-mob.active::before {
            background: var(--ai-gradient);
        }

        .mob-fab {
            flex: 0 0 60px;
            height: 60px;
            width: 60px;
            border-radius: 50%;
            background: var(--hero-gradient);
            color: var(--text-inverse);
            box-shadow: var(--shadow-lg), 0 8px 20px rgba(80, 70, 229, 0.35);
            transform: translateY(-22px);
            font-size: 1.35rem;
            border: none;
            position: relative;
        }

        .mob-fab i {
            font-size: 1.35rem;
        }

        .mob-fab::after {
            content: "Nuevo";
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-base);
            z-index: 45;
        }
        
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--hero-gradient);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg), 0 0 20px -5px rgba(80, 70, 229, 0.5);
            cursor: pointer;
            z-index: 100;
            transition: all var(--transition-fast);
            border: none;
            touch-action: manipulation;
        }

        .fab:hover {
            transform: scale(1.08) translateY(-4px);
            box-shadow: var(--shadow-xl), 0 0 30px -5px rgba(80, 70, 229, 0.6);
        }

        .fab:active {
            transform: scale(1.02);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(148, 163, 184, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            color: white;
            z-index: 3000;
            animation: slideUp 0.3s ease-out;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
        }

        .toast.success {
            background: var(--success-gradient);
        }

        .toast.error {
            background: var(--danger-gradient);
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .toast.info {
            background: var(--ai-gradient);
        }

        .modal-overlay {
            z-index: 2000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            display: none;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: var(--bg-surface);
            padding: 32px;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease-out;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .modal-content--wide {
            max-width: 960px;
        }

        .card-detail-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin: 16px 0 24px;
        }

        .card-detail-summary .summary-tile {
            background: var(--bg-body);
            padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.12);
        }

        .card-detail-summary .summary-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .card-detail-summary .summary-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .card-detail-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .calendar-container {
            background: var(--bg-body);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        [data-theme="dark"] .calendar-container {
            background: var(--bg-elevated);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }

        .calendar-month-year {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 12px;
        }

        .calendar-weekdays span {
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 8px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: transparent;
            border: none;
        }

        .calendar-day:hover:not(.calendar-day-empty):not(.calendar-day-disabled) {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .calendar-day-empty {
            cursor: default;
        }

        .calendar-day-disabled {
            color: var(--text-muted);
            opacity: 0.4;
            cursor: not-allowed;
        }

        .calendar-day-selected {
            background: var(--primary-color) !important;
            color: white !important;
        }

        .calendar-day-today {
            border: 2px solid var(--primary-color);
        }

        .add-card-form {
            background: var(--bg-body);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }

        [data-theme="dark"] .add-card-form {
            background: var(--bg-elevated);
            border-color: rgba(148, 163, 184, 0.1);
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                opacity: 0;
                box-shadow: none;
            }

            .brand {
                justify-content: flex-start;
                padding: 0 24px;
                font-size: 1.2rem;
            }

            .brand i {
                margin-right: 8px;
            }

            .nav-links {
                padding: 20px 16px;
                align-items: flex-start;
            }

            .nav-item {
                justify-content: flex-start;
                gap: 12px;
                font-size: 0.9rem;
                padding: 12px 16px;
                width: 100%;
            }

            .nav-item span {
                display: inline;
            }

            .nav-item i {
                font-size: 1.2rem;
            }

            .theme-toggle {
                justify-content: flex-start;
                padding: 12px 16px;
            }

            .theme-toggle span {
                display: inline;
            }

            .main-wrapper {
                margin-left: 0;
            }

            .hamburger-btn {
                display: inline-flex;
            }

            body.sidebar-open .sidebar {
                transform: translateX(0);
                opacity: 1;
                box-shadow: var(--shadow-lg);
            }

            body.sidebar-open .sidebar-overlay {
                opacity: 1;
                pointer-events: auto;
            }
        }

        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
                z-index: 100;
            }

            .main-wrapper {
                margin-left: 0;
                padding-bottom: 100px;
            }

            .top-header {
                position: sticky;
                top: 0;
                z-index: 95;
            }

            .fab {
                display: none;
            }

            .content-container {
                --section-gap: 24px;
                padding: 24px;
                margin-bottom: 24px;
            }

            .stats-grid {
                gap: 24px;
            }

            .add-card-form {
                grid-template-columns: 1fr;
            }

            .hero-balance {
                padding: 28px 24px;
            }

            .hero-amount {
                font-size: clamp(1.9rem, 6vw, 2.35rem);
            }

            .card {
                padding: var(--surface-padding);
            }

            .hero-title {
                font-size: 0.8rem;
            }

            .mini-label {
                font-size: 0.7rem;
            }

            .date-filter-pill {
                font-size: 0.8rem;
            }

            .filter-row {
                grid-template-columns: repeat(2, minmax(140px, 1fr));
                gap: 12px;
            }

            .btn--lg,
            .btn-ai-action,
            .btn-icon-action {
                font-size: 1.05rem;
                min-height: 44px;
            }

            .btn--lg,
            .btn-ai-action {
                padding: 16px 32px;
            }

            .btn-icon-action {
                padding: 10px 12px;
            }
        }

        @media (max-width: 480px) {
            .content-container {
                --section-gap: 16px;
                padding: 16px;
            }

            .stats-grid {
                gap: 16px;
            }

            .filter-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .hidden {
            display: none !important;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
        }

        .goal-card {
            border: 1px solid rgba(148, 163, 184, 0.1);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            background: var(--bg-surface);
            transition: all var(--transition-fast);
        }

        .goal-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        [data-theme="dark"] .goal-card {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .goal-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .goal-progress {
            height: 10px;
            background: var(--bg-body);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 12px;
        }

        [data-theme="dark"] .goal-progress {
            background: var(--bg-elevated);
        }

        .goal-progress-bar {
            height: 100%;
            background: var(--success-gradient);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
            position: relative;
        }

        .goal-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .goal-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .goal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .family-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .member-card {
            background: var(--bg-surface);
            padding: 24px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(148, 163, 184, 0.08);
            text-align: center;
            transition: all var(--transition-fast);
        }

        .member-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }

        [data-theme="dark"] .member-card {
            border-color: rgba(148, 163, 184, 0.1);
        }

        .member-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--hero-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 14px;
            box-shadow: var(--shadow-md);
        }

        .member-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .member-total {
            font-size: 1.15rem;
            font-weight: 700;
        }

        .member-total.gastos {
            color: var(--danger);
        }

        .member-total.ingresos {
            color: var(--success);
        }

        .reminder-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-left: 4px solid var(--warning);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .reminder-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        [data-theme="dark"] .reminder-card {
            background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
        }

        .reminder-icon {
            font-size: 1.5rem;
            color: var(--warning);
            flex-shrink: 0;
        }

        .reminder-text {
            flex: 1;
        }

        .reminder-title {
            font-weight: 600;
            color: #92400e;
            font-size: 0.95rem;
        }

        [data-theme="dark"] .reminder-title {
            color: #fbbf24;
        }

        .reminder-date {
            font-size: 0.8rem;
            color: #a16207;
            margin-top: 4px;
        }

        [data-theme="dark"] .reminder-date {
            color: #fcd34d;
        }

        .prediction-card {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 28px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .prediction-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        .prediction-title {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        [data-theme="dark"] .prediction-title {
            color: #bfdbfe;
        }

        .prediction-value {
            font-size: 2.25rem;
            font-weight: 800;
            background: var(--hero-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .export-btns {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn-export {
            background: var(--bg-surface);
            border: 1px solid rgba(148, 163, 184, 0.15);
            padding: 12px 24px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            transition: all var(--transition-fast);
        }

        .btn-export:hover {
            background: var(--bg-body);
            border-color: rgba(80, 70, 229, 0.3);
            color: var(--primary);
            transform: translateY(-2px);
        }

        [data-theme="dark"] .btn-export:hover {
            background: var(--bg-elevated);
        }

        .voice-search {
            position: relative;
        }

        .voice-search-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 1.1rem;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .voice-search-btn:hover {
            background: rgba(80, 70, 229, 0.1);
        }

        .voice-search-btn.recording {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        .voice-search input {
            padding-right: 48px;
        }

        .sync-indicator {
            position: fixed;
            top: 90px;
            right: 24px;
            padding: 10px 18px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .sync-indicator.offline {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .sync-indicator.syncing {
            background: var(--info-light);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .sync-indicator.online {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .sync-indicator i {
            animation: spin 1s infinite linear;
        }

        .pending-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .pending-delete-label {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        tr.pending-delete-row td {
            opacity: 0.6;
        }

        .budget-alert {
            background: var(--danger-light);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .budget-alert-icon {
            font-size: 1.5rem;
            color: var(--danger);
            flex-shrink: 0;
        }

        .budget-alert-text {
            flex: 1;
        }

        .budget-alert-title {
            font-weight: 600;
            color: #991b1b;
            font-size: 0.95rem;
        }

        .budget-alert-desc {
            font-size: 0.85rem;
            color: #dc2626;
            margin-top: 4px;
        }

        .cuota-item {
            background: var(--bg-body);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-fast);
        }

        .cuota-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .cuota-item.pagada {
            background: var(--success-light);
            border-color: rgba(16, 185, 129, 0.2);
            opacity: 0.7;
        }

        .cuota-item.pendiente {
            background: var(--warning-light);
            border-color: rgba(245, 158, 11, 0.2);
        }

        .cuota-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cuota-numero {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .cuota-fecha {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .cuota-monto {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .btn-cuota-pagar {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-cuota-pagar:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .cuota-pagada-badge {
            background: var(--success);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .credit-summary-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        [data-theme="dark"] .credit-summary-card {
            background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
        }

        .credit-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .credit-card-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #92400e;
        }

        [data-theme="dark"] .credit-card-name {
            color: #fbbf24;
        }

        .credit-progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .credit-progress-label {
            font-size: 0.85rem;
            color: #a16207;
        }

        [data-theme="dark"] .credit-progress-label {
            color: #fcd34d;
        }

        .credit-progress-value {
            font-weight: 700;
            color: #92400e;
        }

        [data-theme="dark"] .credit-progress-value {
            color: #fbbf24;
        }

        .credit-progress-bar {
            height: 8px;
            background: rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .credit-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #d97706);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        .cuotas-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }

        .next-installment-section {
            background: rgba(15, 23, 42, 0.06);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            margin-top: 12px;
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        [data-theme="dark"] .next-installment-section {
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .next-installment-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .next-installment-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .next-installment-date {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .cuotas-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-details {
            background: var(--bg-body);
            padding: 20px;
            border-radius: var(--radius-md);
            margin: 20px 0;
        }

        [data-theme="dark"] .modal-details {
            background: var(--bg-elevated);
        }

        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .modal-row:last-child {
            border-bottom: none;
        }

        .modal-row span {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .modal-row strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .modal-row.total {
            font-size: 1.1rem;
            padding-top: 16px;
            border-top: 2px solid rgba(148, 163, 184, 0.15);
            margin-top: 8px;
        }

        .modal-row.total span {
            color: var(--text-primary);
            font-weight: 600;
        }

        .modal-row.total strong {
            color: var(--danger);
            font-size: 1.2rem;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .audit-panel {
            margin-top: 24px;
            padding: 18px;
            background: var(--bg-body);
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        [data-theme="dark"] .audit-panel {
            background: var(--bg-elevated);
        }

        .audit-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 16px;
        }

        .audit-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .audit-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .audit-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .audit-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .audit-item {
            padding: 12px 14px;
            border-radius: var(--radius-md);
            background: var(--bg-surface);
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: var(--shadow-xs);
        }

        [data-theme="dark"] .audit-item {
            background: rgba(15, 23, 42, 0.2);
        }

        .audit-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .audit-item-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .audit-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            background: var(--warning-light);
            color: #b45309;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .audit-badge--danger {
            background: var(--danger-light);
            color: #b91c1c;
        }

        .audit-item-body {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .audit-item-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .audit-empty {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            padding: 12px 0;
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand"><i class="fas fa-wallet"></i> CRM <span>Expert</span></div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-moon" id="themeIcon"></i>
            <span id="themeText">Modo Oscuro</span>
        </button>
        <div class="nav-links">
            <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-home"></i> <span>Dashboard</span></div>
            <div class="nav-item" onclick="switchView('transacciones', this)"><i class="fas fa-exchange-alt"></i> <span>Transacciones</span></div>
            <div class="nav-item" onclick="switchView('estadisticas', this)"><i class="fas fa-chart-pie"></i> <span>Estadísticas</span></div>
            <div class="nav-item" onclick="switchView('historial', this)"><i class="fas fa-list"></i> <span>Historial</span></div>
            <div class="nav-item" onclick="switchView('objetivos', this)"><i class="fas fa-bullseye"></i> <span>Objetivos</span></div>
            <div class="nav-item" onclick="switchView('asistente', this)"><i class="fas fa-brain"></i> <span>Asesor Experto</span></div>
        </div>
        <div style="padding: 24px; font-size: 0.75rem; color: #9ca3af; text-align: center;">Familia & Finanzas © 2025</div>
    </nav>

    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <nav class="mobile-nav">
        <button class="mob-link active" onclick="switchView('dashboard', this)"><i class="fas fa-home"></i> <span>Inicio</span></button>
        <button class="mob-link" onclick="switchView('transacciones', this)"><i class="fas fa-exchange-alt"></i> <span>Trans.</span></button>
        <button class="mob-link mob-fab" onclick="goToAddTransaction()"><i class="fas fa-plus"></i></button>
        <button class="mob-link" onclick="switchView('historial', this)"><i class="fas fa-list"></i> <span>Hist.</span></button>
        <button class="mob-link ai-mob" onclick="switchView('asistente', this)"><i class="fas fa-brain"></i> <span>Expert</span></button>
    </nav>

    <div class="sync-indicator offline" id="syncIndicator">
        <i class="fas fa-wifi"></i> <span id="syncText">Sin conexión</span>
    </div>

    <button class="fab" onclick="goToAddTransaction()"><i class="fas fa-plus"></i></button>

    <div class="main-wrapper">
        <header class="top-header">
            <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Abrir menú">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title" id="pageTitle">Resumen Financiero</div>
            <div class="date-filter-pill" id="headerDateFilter">
                <i class="far fa-calendar-alt" style="color: var(--primary);"></i>
                <input type="month" id="dashboardMonth" onchange="updateDashboardView()">
            </div>
        </header>

        <div class="content-container">
            
            <div id="budgetAlert" class="budget-alert hidden">
                <div class="budget-alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="budget-alert-text">
                    <div class="budget-alert-title">¡Alerta de Presupuesto!</div>
                    <div class="budget-alert-desc" id="budgetAlertDesc">Has excedido el 90% de tu presupuesto en alguna categoría.</div>
                </div>
            </div>

            <div id="remindersContainer"></div>

            <div id="view-dashboard" class="tab-content active">
                <div class="hero-balance">
                    <div class="hero-title">Patrimonio Líquido Total</div><div class="hero-amount" id="saldoTotal">$ 0</div>
                    <div style="font-size:0.85rem; margin-top:10px; opacity:0.8;"><i class="fas fa-info-circle"></i> Suma de Nequi, Bancos y Efectivo</div>
                </div>

                <div class="family-summary" id="familySummary">
                    <div class="member-card skeleton" style="height: 120px;"></div>
                    <div class="member-card skeleton" style="height: 120px;"></div>
                    <div class="member-card skeleton" style="height: 120px;"></div>
                    <div class="member-card skeleton" style="height: 120px;"></div>
                </div>

                <div class="stats-grid">
                    <div class="mini-stat"><div class="mini-label"><i class="fas fa-university" style="color: #6366f1;"></i> Débito</div><div class="mini-value" id="saldoDebito">$0</div></div>
                    <div class="mini-stat"><div class="mini-label"><i class="fas fa-money-bill-wave" style="color: #10b981;"></i> Efectivo</div><div class="mini-value" id="saldoEfectivo">$0</div></div>
                    <div class="mini-stat"><div class="mini-label"><i class="fas fa-mobile-alt" style="color: #ec4899;"></i> Nequi</div><div class="mini-value" id="saldoNequi">$0</div></div>
                </div>
                <h3 style="margin-bottom: 15px; color: var(--text-light); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Flujo del Mes (<span id="lblPeriodoResumen">Actual</span>)</h3>
                <div class="stats-grid">
                    <div class="mini-stat income"><div class="mini-label">Ingresos</div><div class="mini-value" id="totalIngresosMes">$0</div></div>
                    <div class="mini-stat debt"><div class="mini-label">Gastos + Compras TC</div><div class="mini-value" id="totalGastosMes">$0</div></div>
                    <div class="mini-stat"><div class="mini-label">Balance Neto</div><div class="mini-value" id="balanceMes">$0</div></div>
                </div>
                <div class="card" id="dailyCapCard">
                    <h3 style="margin-bottom:15px;"><i class="fas fa-calendar-day"></i> Tope del día</h3>
                    <div class="stats-grid">
                        <div class="mini-stat">
                            <div class="mini-label">Tope del día</div>
                            <div class="mini-value" id="dailyCapValue">$0</div>
                        </div>
                        <div class="mini-stat debt">
                            <div class="mini-label">Gasto acumulado de hoy</div>
                            <div class="mini-value" id="dailySpendValue">$0</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-label">Estado</div>
                            <div class="mini-value" id="dailyCapStatus">OK</div>
                        </div>
                    </div>
                    <div style="margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                        Tope del día (no incluye Vivienda ni Servicios Públicos).
                        <span>Tope diario = Patrimonio Líquido Total / días pendientes del mes.</span>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;"><i class="fas fa-credit-card"></i> Deudas Tarjetas</h3>
                        <button onclick="openQuotaModal()" class="btn btn--secondary btn--sm"><i class="fas fa-cog"></i> Gestionar</button>
                    </div>
                    <div class="hero-amount" id="deudaTotalTC" style="color:var(--danger); font-size:1.8rem; margin-bottom:15px;">$0</div>
                    <div id="cardsBreakdown"><div class="loading"><div class="spinner"></div></div></div>
                </div>
            </div>

            <div id="view-asistente" class="tab-content">
                <div class="ai-welcome-card">
                    <h2><i class="fas fa-brain"></i> Auditor Financiero</h2>
                    <p>Análisis detallado de solvencia, liquidez y patrones de consumo. Ejecución 100% local y privada.</p>
                    <button class="btn-ai-action" onclick="generateLocalAnalysis()"><i class="fas fa-search-dollar"></i> Ejecutar Auditoría</button>
                </div>
                <div id="aiLoading" class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">Calculando ratios...</div></div>
                <div id="aiResultContainer" class="ai-response-container">
                    <div class="card">
                        <div class="ai-report-header">
                            <div><h3 style="margin:0; color:#0f172a;">Diagnóstico Integral</h3><span style="font-size:0.8rem; color:#64748b;">Basado en historial de 30 días</span></div>
                            <div id="aiScoreBadge" class="score-badge">SCORE: --</div>
                        </div>
                        <div id="aiContentBody"></div>
                    </div>
                    <div class="prediction-card" id="predictionCard">
                        <div class="prediction-title"><i class="fas fa-crystal-ball"></i> Predicción Próximo Mes</div>
                        <div class="prediction-value" id="predictedExpenses">$0</div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 5px;">Gastos estimados basándose en tu historial</div>
                    </div>
                </div>
            </div>

            <div id="view-transacciones" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom:20px;" id="formTitle">Nueva Transacción</h2>
                    <form id="transactionForm">
                        <input type="hidden" id="editingId" value="">
                        <div class="form-grid">
                            <div class="form-group full-width"><label>Tipo</label><select id="tipo" required onchange="handleTipoChange()"><option value="gasto">💸 Gasto</option><option value="ingreso">💰 Ingreso</option><option value="credito">💳 Crédito</option><option value="pago_tarjeta">📉 Abono TC</option><option value="transferencia">🔄 Transferencia</option></select></div>
                            <div id="creditConfig" class="form-group full-width hidden" style="background:#fff1f2; padding:15px; border-radius:12px; border:1px solid #fda4af;"><div style="display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:15px;"><div class="form-group"><label style="color:var(--danger);">Tarjeta</label><select id="tarjetaCredito"></select></div><div class="form-group"><label style="color:var(--danger);">Cuotas</label><input type="number" id="cuotas" value="1"></div><div class="form-group"><label style="color:var(--danger);">Cuotas pagadas</label><input type="number" id="cuotasPagadas" value="0" min="0"></div></div></div>
                            <div id="divPagoTarjeta" class="form-group full-width hidden" style="background:#ecfdf5; padding:15px; border-radius:12px; border:1px solid #6ee7b7;"><div class="form-group"><label style="color:var(--success);">Tarjeta a Pagar</label><select id="tarjetaDestinoPago"></select></div></div>
                            <div class="form-group" id="metodoPagoDiv"><label id="lblMetodoPago">Método</label><select id="metodoPago"><option value="debito">Débito</option><option value="efectivo">Efectivo</option><option value="nequi">Nequi</option></select></div>
                            <div class="form-group hidden" id="metodoDestinoDiv"><label>Destino</label><select id="metodoDestino"><option value="debito">Débito</option><option value="efectivo">Efectivo</option><option value="nequi">Nequi</option></select></div>
                            <div class="form-group"><label>Monto</label><input type="text" id="monto" required inputmode="decimal" pattern="[0-9.,]*" oninput="formatCurrencyInput(this)" style="font-size:1.2rem; font-weight:bold; color:var(--primary);"></div>
                            <div class="form-group"><label>Categoría</label><select id="categoria" required></select></div>
                            <div class="form-group hidden" id="subcategoriaDiv"><label>Subcategoría</label><select id="subcategoria"></select></div>
                            <div class="form-group"><label>Responsable</label><select id="miembro"><option value="papa">Papá</option><option value="mama">Mamá</option><option value="hijo1">Hijo/a 1</option><option value="compartido">Compartido</option></select></div>
                            <div class="form-group full-width"><label>Descripción</label><input type="text" id="descripcion" required></div>
                            <div class="form-group"><label>Fecha</label><input type="date" id="fecha" required></div>
                        </div>
                        <div style="margin-top:25px; display:flex; gap:10px;">
                            <button type="button" onclick="preSubmit()" class="btn btn--primary btn--lg" id="btnSubmitText">Guardar</button>
                            <button type="button" id="btnCancelar" class="btn btn--ghost btn--lg hidden" onclick="cancelEdit()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="view-estadisticas" class="tab-content">
                <div class="card"><h3>Tendencia (6 Meses)</h3><div style="height:300px;"><canvas id="chartTendencias"></canvas></div></div>
                <div class="card"><h3>Distribución de Gastos</h3><div style="height:350px;"><canvas id="chartCategorias"></canvas></div></div>
            </div>

            <div id="view-objetivos" class="tab-content">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;"><i class="fas fa-bullseye"></i> Objetivos de Ahorro</h3>
                        <button onclick="openGoalModal()" class="btn btn--primary btn--sm"><i class="fas fa-plus"></i> Nuevo</button>
                    </div>
                    <div id="goalsContainer">
                        <div class="skeleton" style="height: 100px; margin-bottom: 15px;"></div>
                        <div class="skeleton" style="height: 100px; margin-bottom: 15px;"></div>
                    </div>
                </div>
            </div>

            <div id="view-historial" class="tab-content">
                <div class="export-btns">
                    <button class="btn-export" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                    <button class="btn-export" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-filter" style="color:var(--primary);"></i> Historial y Filtros
                    </h3>
                    
                    <div class="advanced-filters">
                        <div class="filter-row">
                            <div class="filter-group voice-search">
                                <label>Buscar (Texto o Voz)</label>
                                <input type="text" id="filterText" class="filter-control" placeholder="Ej: Cena, Netflix...">
                                <button class="voice-search-btn" id="voiceSearchBtn" onclick="toggleVoiceSearch()"><i class="fas fa-microphone"></i></button>
                            </div>
                            <div class="filter-group">
                                <label>Tipo</label>
                                <select id="filterType" class="filter-control">
                                    <option value="all">Todos</option>
                                    <option value="gasto">Gasto</option>
                                    <option value="ingreso">Ingreso</option>
                                    <option value="credito">Crédito</option>
                                    <option value="pago_tarjeta">Pago TC</option>
                                    <option value="transferencia">Transferencia</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Método de Pago/Destino</label>
                                <select id="filterMethod" class="filter-control">
                                    <option value="all">Cualquiera</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Desde</label>
                                <input type="date" id="filterStart" class="filter-control">
                            </div>
                            <div class="filter-group">
                                <label>Hasta</label>
                                <input type="date" id="filterEnd" class="filter-control">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button class="btn-clear" onclick="clearFilters()">Limpiar Filtros</button>
                            <button class="btn btn--primary btn--md" onclick="renderHistory()">
                                <i class="fas fa-search"></i> Aplicar
                            </button>
                        </div>
                    </div>

                    <div class="filter-summary">
                        <div class="summary-pill inc"><i class="fas fa-arrow-down"></i> <span id="valFilteredInc">$0</span></div>
                        <div class="summary-pill exp"><i class="fas fa-arrow-up"></i> <span id="valFilteredExp">$0</span></div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Método</th>
                                    <th>Cat.</th>
                                    <th>Desc.</th>
                                    <th>Monto</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="transactionList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="creditModal"><div class="modal-content"><h3>Confirmar Crédito</h3><div class="modal-details"><div class="modal-row"><span>Tarjeta:</span><strong id="modalTarjeta">-</strong></div><div class="modal-row"><span>Cuotas:</span><span id="modalCuotas">0</span></div><div class="modal-row total"><span>Total Deuda:</span><span id="modalTotalDeuda">$0</span></div></div><div class="modal-actions"><button class="btn btn--ghost btn--md" onclick="closeModal('creditModal')">Volver</button><button class="btn btn--primary btn--md" onclick="confirmSaveTransaction()">Confirmar</button></div></div></div>
    
    <div class="modal-overlay" id="quotaModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3 class="modal-title">Gestión Tarjetas</h3><button onclick="closeModal('quotaModal')" class="btn btn--icon btn--ghost" aria-label="Cerrar">&times;</button></div>
            <div class="add-card-form">
                <div class="form-group"><label>Nombre</label><input type="text" id="cardNameInput" placeholder="Ej: Visa"></div>
                <div class="form-group"><label>Cupo</label><input type="text" id="cardQuotaInput" inputmode="decimal" pattern="[0-9.,]*" oninput="formatCurrencyInput(this)" placeholder="$ 0"></div>
                <input type="hidden" id="cardAvailableAdjustmentInput" value="0">
                <input type="hidden" id="cardPaymentDayInput">
                <button class="btn btn--primary btn--icon" onclick="saveCard()" id="btnSaveCard" aria-label="Guardar tarjeta"><i class="fas fa-plus"></i></button>
                <input type="hidden" id="editCardId">
            </div>
            <div id="quotaListContainer" style="max-height:300px; overflow-y:auto;"></div>
            <div class="audit-panel">
                <div class="audit-header">
                    <div>
                        <div class="audit-title">Alertas de consistencia</div>
                        <div class="audit-subtitle">Comparación de deuda, cupo disponible y cuotas restantes.</div>
                    </div>
                    <div class="audit-actions">
                        <button class="btn btn--ghost btn--sm" onclick="runConsistencyAudit()"><i class="fas fa-search"></i> Ejecutar</button>
                        <button class="btn btn--primary btn--sm" id="btnApplyConsistencyCorrections" onclick="applyConsistencyCorrections()" disabled><i class="fas fa-wrench"></i> Aplicar correcciones</button>
                    </div>
                </div>
                <div id="consistencyAlertList" class="audit-list">
                    <div class="audit-empty">Ejecuta la auditoría para ver diferencias.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cardDetailModal">
        <div class="modal-content modal-content--wide">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div>
                    <h3 class="modal-title">Detalle de Tarjeta</h3>
                    <div id="cardDetailName" style="font-size:1rem; font-weight:600; color:var(--primary);"></div>
                    <div id="cardDetailMeta" style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;"></div>
                </div>
                <button onclick="closeModal('cardDetailModal')" class="btn btn--icon btn--ghost" aria-label="Cerrar">&times;</button>
            </div>
            <div class="card-detail-summary" id="cardDetailSummary"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Descripción</th>
                            <th>Monto total</th>
                            <th>Cuotas</th>
                            <th>Pagadas</th>
                            <th>Saldo pendiente</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cardDetailTransactions"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="goalModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3 class="modal-title">Nuevo Objetivo</h3><button onclick="closeModal('goalModal')" class="btn btn--icon btn--ghost" aria-label="Cerrar">&times;</button></div>
            <div class="form-group"><label>Nombre del Objetivo</label><input type="text" id="goalName" placeholder="Ej: Vacaciones"></div>
            <div class="form-group"><label>Monto Objetivo</label><input type="text" id="goalTarget" inputmode="decimal" pattern="[0-9.,]*" oninput="formatCurrencyInput(this)" placeholder="$ 0"></div>
            <div class="form-group"><label>Ahorrado</label><input type="text" id="goalSaved" inputmode="decimal" pattern="[0-9.,]*" oninput="formatCurrencyInput(this)" placeholder="$ 0"></div>
            <div class="form-group"><label>Fecha Límite</label><input type="date" id="goalDeadline"></div>
            <button class="btn btn--primary btn--lg btn--block" onclick="saveGoal()">Guardar Objetivo</button>
        </div>
    </div>

    <div class="modal-overlay" id="pagoCuotaModal">
        <div class="modal-content" style="max-width:420px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 class="modal-title">📅 Programar Próxima Cuota</h3>
                <button onclick="closeModal('pagoCuotaModal')" class="btn btn--icon btn--ghost" aria-label="Cerrar">&times;</button>
            </div>
            <div style="text-align:center; margin-bottom:15px;">
                <div id="pagoCuotaInfo" style="font-size:0.9rem; color:var(--text-muted);"></div>
            </div>
            <div class="calendar-container" style="display:none;">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="cambiarMesCalendario(-1)">&#8249;</button>
                    <span id="calendarMonthYear" class="calendar-month-year"></span>
                    <button class="calendar-nav-btn" onclick="cambiarMesCalendario(1)">&#8250;</button>
                </div>
                <div class="calendar-weekdays">
                    <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                </div>
                <div id="calendarDays" class="calendar-days"></div>
            </div>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn btn--ghost btn--lg btn--full" onclick="closeModal('pagoCuotaModal')">Cancelar</button>
                <button class="btn btn--primary btn--lg btn--full" onclick="confirmarPagoCuota()" id="btnConfirmarPagoCuota">💰 Confirmar Pago</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAP8f9ldzgyKAg74Da2yYL9u_urRLtf8nY", authDomain: "crm-financiero.firebaseapp.com", projectId: "crm-financiero", storageBucket: "crm-financiero.firebasestorage.app", messagingSenderId: "442754442943", appId: "1:442754442943:web:914d5a8ef619d77407880a", measurementId: "G-5EBSSNG8P9" };
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let transactions=[], cardsList=[], editingTransactionId=null, chartInstance=null, trendChartInstance=null, tempTransactionData=null, globalDeudaPorTarjeta={}, currentViewDate=new Date(), goals=[], pendingSync=[], currentDetailCardName=null, consistencyAudit={issues:[], corrections:[]};
        
        const categories={gasto:{'vivienda':{icon:'🏠',subcategorias:['Arriendo/Hipoteca','Administración','Reparaciones 🛠️','Muebles 🛋️','Electrodomésticos 📺','Artículos Aseo 🧹','Decoración 🖼️','Impuesto Predial 📄']},'servicios_publicos':{icon:'💡',subcategorias:['Energía ⚡','Agua 💧','Gas 🔥','Internet 🌐','Plan Celular 📱','Streaming (Netflix/Disney) 🎬','Spotify/Music 🎵','Nube (Google/iCloud) ☁️','Servicio Doméstico 🧹']},'alimentacion':{icon:'🍔',subcategorias:['Mercado General 🛒','Carnes y Pescados 🥩','Frutas y Verduras 🥦','Panadería 🥖','Restaurantes 🍽️','Domicilios (Rappi/Uber) 🛵','Café/Snacks ☕','Licores 🍺']},'transporte':{icon:'🚗',subcategorias:['Gasolina ⛽','Transporte Público 🚌','Taxi/Uber/DiDi 🚖','Parqueadero 🅿️','Peajes 🚧','Mantenimiento/Taller 🔧','Lavado Auto 🚿','SOAT/Seguro 🛡️','Licencia/Trámites 📝']},'educacion':{icon:'📚',subcategorias:['Pensión Escolar/U 🎓','Cursos Online 💻','Libros/Ebooks 📖','Útiles/Papelería ✏️','Uniformes 👕','Transporte Escolar 🚌','Idiomas 🗣️']},'salud':{icon:'⚕️',subcategorias:['Medicina Prepagada 🏥','Citas Médicas 🩺','Medicamentos 💊','Odontología 🦷','Optometría 👓','Laboratorio/Exámenes 💉','Terapia/Psicología 🧠']},'vestuario':{icon:'👕',subcategorias:['Ropa Casual 👚','Ropa Formal 👔','Ropa Deportiva 🏃','Calzado 👟','Accesorios (Bolsos/Joyas) 👜','Lavandería/Sastrería 🧵']},'cuidado_personal':{icon:'💄',subcategorias:['Peluquería/Barbería 💇','Manicure/Pedicure 💅','Cosméticos/Maquillaje 💄','Cuidado Piel (Skincare) 🧴','Aseo Personal 🧼','Masajes/Spa 💆']},'entretenimiento':{icon:'🎬',subcategorias:['Cine 🍿','Salidas/Bares 🍻','Conciertos/Eventos 🎟️','Videojuegos 🎮','Libros/Hobbies 🎨','Paseos/Turismo ✈️','Suscripciones (Música/Juegos) 🎧']},'mascotas':{icon:'🐶',subcategorias:['Comida Mascota 🦴','Veterinaria 🩺','Juguetes/Accesorios 🎾','Guardería/Paseador 🐕','Medicamentos 💊']},'tecnologia':{icon:'💻',subcategorias:['Celulares/Tablets 📱','Computadores 💻','Accesorios (Cables/Audífonos) 🎧','Software/Suscripciones 💾','Mantenimiento 🔧']},'otros':{icon:'📦',subcategorias:['Gastos Improvisados 🎲','Comisiones/Bancos 🏦','Impuestos 📄','Otros 🔖']}},ingreso:{'salario':{icon:'💼',subcategorias:['Salario Principal 💰','Bonificaciones 🎁','Horas Extras ⏰','Propinas 🤝']},'inversiones':{icon:'📈',subcategorias:['Dividendos 📊','Intereses 💵','Ganancias Bolsillo 📉','Alquileres 🏘️']},'negocio':{icon:'🏪',subcategorias:['Ventas 🛒','Servicios Prestados 🤝','Comisiones 💲','Otros Negocio 📦']},'otros_ingreso':{icon:'🎁',subcategorias:['Regalos 🎉','Préstamos Recibidos 🤝','Reembolsos 💳','Herencia 💎','Otros Ingresos 🎁']}}};
        const categorias=categories;

        function toggleTheme(){const d=document.body;const isDark=d.getAttribute('data-theme')==='dark';d.setAttribute('data-theme',isDark?'light':'dark');localStorage.setItem('theme',isDark?'light':'dark');updateThemeIcon();}
        function updateThemeIcon(){const isDark=document.body.getAttribute('data-theme')==='dark';document.getElementById('themeIcon').className=isDark?'fas fa-sun':'fas fa-moon';document.getElementById('themeText').textContent=isDark?'Modo Claro':'Modo Oscuro';}
        
        function initTheme(){const t=localStorage.getItem('theme')||'light';document.body.setAttribute('data-theme',t);updateThemeIcon();}

        function toggleSidebar(){document.body.classList.toggle('sidebar-open');}
        function closeSidebar(){document.body.classList.remove('sidebar-open');}
        
        function initKeyboardShortcuts(){document.addEventListener('keydown',(e)=>{if(e.ctrlKey&&e.key==='n'){e.preventDefault();goToAddTransaction();}if(e.key==='Escape'){cancelEdit();closeModal('creditModal');closeModal('quotaModal');closeModal('goalModal');closeModal('pagoCuotaModal');}});}
        
        document.addEventListener('DOMContentLoaded', () => { 
            initTheme();initKeyboardShortcuts();initOfflineSupport();
            const t=new Date(); const yyyy=t.getFullYear(); const mm=String(t.getMonth()+1).padStart(2,'0');
            document.getElementById('dashboardMonth').value=`${yyyy}-${mm}`;document.getElementById('fecha').valueAsDate=t;
            const firstDay=`${yyyy}-${mm}-01`;const lastDay=new Date(yyyy,t.getMonth()+1,0).toISOString().split('T')[0];
            document.getElementById('filterStart').value=firstDay;document.getElementById('filterEnd').value=lastDay;
            document.getElementById('goalDeadline').value=lastDay;
            loadCards();loadGoals();
        });

        function getStoredOfflineTransactions(){try{return JSON.parse(localStorage.getItem('offlineTransactions')||'[]');}catch(e){return [];}}
        function setStoredOfflineTransactions(data){localStorage.setItem('offlineTransactions',JSON.stringify(data));}
        function getStoredPendingDeletes(){try{return JSON.parse(localStorage.getItem('pendingDeletes')||'[]');}catch(e){return [];}}
        function setStoredPendingDeletes(data){localStorage.setItem('pendingDeletes',JSON.stringify(data));}
        function normalizeOfflineDataForSync(item){const {id,pendingSync,...data}=item;return data;}
        function initOfflineSupport(){
            const offlineData=getStoredOfflineTransactions();
            const pendingDeletes=getStoredPendingDeletes();
            pendingSync=[];
            if(offlineData.length>0){pendingSync=offlineData.map(item=>({type:'add',data:normalizeOfflineDataForSync(item)}));}
            if(pendingDeletes.length>0){pendingSync.push(...pendingDeletes.map(id=>({type:'delete',id})));}
            window.addEventListener('online',()=>{syncPendingTransactions();});
            window.addEventListener('offline',()=>{showSyncStatus('offline');});
            if(navigator.onLine){showSyncStatus('online');if(pendingSync.length>0)syncPendingTransactions();}else{showSyncStatus('offline');}
        }
        function showSyncStatus(status){const ind=document.getElementById('syncIndicator');const txt=document.getElementById('syncText');ind.className='sync-indicator '+status;txt.textContent=status==='online'?'Conectado':status==='syncing'?'Sincronizando...':'Sin conexión';}
        async function syncPendingTransactions(){
            if(pendingSync.length===0)return;
            showSyncStatus('syncing');
            const items=[...pendingSync];
            try{
                for(const item of items){
                    if(item.type==='add'){await db.collection('transactions').add(item.data);}
                    else if(item.type==='delete'){await db.collection('transactions').doc(item.id).delete();}
                }
                pendingSync=[];
                setStoredOfflineTransactions([]);
                setStoredPendingDeletes([]);
                showSyncStatus('online');
                showToast('Datos sincronizados','success');
                loadTransactions();
            }catch(e){
                console.error('Sync error:',e);
            }
        }
        function saveToLocal(data,isDelete=false,id=null){
            const normalizedId=id?String(id).replace(/^offline-/,''):null;
            if(isDelete){
                if(id && !String(id).startsWith('offline-')){
                    pendingSync.push({type:'delete',id});
                    const pendingDeletes=getStoredPendingDeletes();
                    if(!pendingDeletes.includes(id)){
                        pendingDeletes.push(id);
                        setStoredPendingDeletes(pendingDeletes);
                    }
                }
            }else{
                pendingSync.push({type:'add',data});
            }
            const offlineData=getStoredOfflineTransactions();
            if(isDelete){
                const idx=offlineData.findIndex(t=>t.id===normalizedId);
                if(idx>-1)offlineData.splice(idx,1);
            }else{
                offlineData.push({...data,id:Date.now().toString()});
            }
            setStoredOfflineTransactions(offlineData);
        }

        function clearFilters() {
            document.getElementById('filterText').value = '';
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterMethod').value = 'all';
            const t = new Date();
            const yyyy = t.getFullYear();
            const mm = String(t.getMonth()+1).padStart(2,'0');
            document.getElementById('filterStart').value = `${yyyy}-${mm}-01`;
            document.getElementById('filterEnd').value = new Date(yyyy, t.getMonth() + 1, 0).toISOString().split('T')[0];
            renderHistory();
        }

        function populateMethodFilter() {
            const sel = document.getElementById('filterMethod');
            sel.innerHTML = '<option value="all">Cualquiera</option>';
            ['debito', 'efectivo', 'nequi'].forEach(m => sel.add(new Option(m.charAt(0).toUpperCase() + m.slice(1), m)));
            cardsList.forEach(c => sel.add(new Option('💳 ' + c.name, c.name)));
        }

        function renderHistory() {
            const tbody = document.getElementById('transactionList'); tbody.innerHTML = '';
            const txt = document.getElementById('filterText').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const method = document.getElementById('filterMethod').value;
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            let inc = 0, exp = 0;
            const filtered = transactions.filter(t => {
                if (start && t.fecha < start) return false;
                if (end && t.fecha > end) return false;
                if (type !== 'all' && t.tipo !== type) return false;
                const textMatch = t.descripcion.toLowerCase().includes(txt) || (t.categoria && t.categoria.toLowerCase().includes(txt)) || (t.subcategoria && t.subcategoria.toLowerCase().includes(txt));
                if (!textMatch) return false;
                if (method !== 'all') {
                    const creditName = t.tipo === 'credito' ? resolveCreditCardName(t) : null;
                    const m1 = t.tipo !== 'credito' && t.metodoPago === method;
                    const m2 = t.tipo === 'credito' && creditName === method;
                    const m3 = (t.tipo === 'pago_tarjeta' || t.tipo === 'transferencia') && (t.metodoPago === method || t.tarjetaDestino === method || t.metodoDestino === method);
                    if (!(m1 || m2 || m3)) return false;
                }
                const m = parseFloat(t.monto);
                if (t.tipo === 'ingreso') inc += m;
                if (t.tipo === 'gasto' || t.tipo === 'credito') exp += m;
                return true;
            });
            document.getElementById('valFilteredInc').textContent = formatMoney(inc);
            document.getElementById('valFilteredExp').textContent = formatMoney(exp);
            if(filtered.length===0){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px;color:#999;">No hay resultados con estos filtros</td></tr>'; return; }
            filtered.forEach(t => {
                let color = t.tipo==='ingreso'?'text-success':(t.tipo==='pago_tarjeta'?'text-credit':'text-danger');
                let symbol = t.tipo==='ingreso'?'+':'-'; if(t.tipo==='transferencia'){color='text-main';symbol='';}
                let met=t.metodoPago;
                if(t.tipo==='credito'){
                    const creditName=resolveCreditCardName(t);
                    met=`${creditName} (${t.cuotas}x)`;
                } else if(t.tipo==='pago_tarjeta'||t.tipo==='transferencia') met=`${t.metodoPago} ➔ ${t.tarjetaDestino||t.metodoDestino}`;
                const pendingLabel=t.pendingSync
                    ? '<span class="pending-label">Pendiente</span>'
                    : t.pendingDelete
                        ? '<span class="pending-label pending-delete-label">Pendiente de eliminación</span>'
                        : '';
                const actionButtons=t.pendingSync || t.pendingDelete
                    ? `<span style="color:${t.pendingDelete?'var(--danger)':'var(--warning)'};font-size:0.75rem;font-weight:600;">Pendiente</span>`
                    : `<button onclick="editTransaction('${t.id}')" class="btn-icon-action btn-icon-action--info"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteTransaction('${t.id}')" class="btn-icon-action btn-icon-action--danger"><i class="fas fa-trash"></i></button>`;
                const rowClass=t.pendingDelete?'pending-delete-row':'';
                tbody.innerHTML += `<tr class="${rowClass}">
                    <td>${t.fecha}</td>
                    <td style="text-transform:capitalize;font-size:0.85rem;">${t.tipo.replace('_',' ')}</td>
                    <td style="font-size:0.85rem;color:#4b5563;">${met}</td>
                    <td>${t.categoria||'-'}</td>
                    <td>${t.descripcion} ${pendingLabel}</td>
                    <td class="${color}" style="font-weight:bold;">${symbol} ${formatMoney(t.monto)}</td>
                    <td style="text-align:right;">
                        ${actionButtons}
                    </td>
                </tr>`;
            });
        }

        function generateLocalAnalysis(){
            const btn=document.querySelector('.btn-ai-action');const loader=document.getElementById('aiLoading');const result=document.getElementById('aiResultContainer');
            btn.disabled=true;loader.style.display='flex';result.style.display='none';
            setTimeout(()=>{
                const d=prepareFinancialContext();
                let score=100; if(d.cashFlow<0)score-=30; if((d.cashFlow/d.income)<0.1)score-=10; if(d.totalDebt>d.income)score-=20;
                let debtHTML=d.totalDebt===0?`<div class="insight-item"><div class="insight-val text-success">Sin Deuda</div></div>`:`<div class="insight-grid"><div class="insight-item"><div class="insight-label">Deuda</div><div class="insight-val text-danger">${formatMoney(d.totalDebt)}</div></div><div class="insight-item"><div class="insight-label">Ratio</div><div class="insight-val">${((d.totalDebt/d.income)*100).toFixed(0)}%</div></div></div>`;
                const html=`<div class="report-section"><h4><i class="fas fa-heartbeat" style="color:#ef4444"></i> Diagnóstico</h4><div class="insight-grid"><div class="insight-item"><div class="insight-label">Ingresos</div><div class="insight-val text-success">${formatMoney(d.income)}</div></div><div class="insight-item"><div class="insight-label">Gastos</div><div class="insight-val text-danger">${formatMoney(d.expenses)}</div></div><div class="insight-item"><div class="insight-label">Flujo</div><div class="insight-val">${formatMoney(d.cashFlow)}</div></div></div></div><div class="report-section"><h4><i class="fas fa-shield-alt" style="color:#eab308"></i> Deudas</h4>${debtHTML}</div><div class="report-section"><h4><i class="fas fa-lightbulb" style="color:#f59e0b"></i> Recomendaciones</h4><ul class="ai-list">${generateRecommendations(d)}</ul></div>`;
                document.getElementById('aiContentBody').innerHTML=html; document.getElementById('aiScoreBadge').textContent=`SCORE: ${score}/100`;
                predictNextMonthExpenses();
                loader.style.display='none';result.style.display='block';btn.disabled=false;
            },1000);
        }

        function generateRecommendations(d){let rec=[];if(d.cashFlow<0)rec.push('Tu flujo de efectivo es negativo. Considera reducir gastos no esenciales.');if(d.totalDebt>0)rec.push('Tienes deudas activas. Prioriza pagar las de mayor interés primero.');if((d.cashFlow/d.income)<0.1&&d.cashFlow>0)rec.push('Tu tasa de ahorro es baja. Intenta aumentarla al 10% de tus ingresos.');if(d.expenses> d.income * 0.8)rec.push('Estás gastando más del 80% de tus ingresos. Revisa tus categorías más altas.');if(rec.length===0)rec.push('¡Excelente! Tu situación financiera está equilibrada.');return rec.map(r=>`<li>${r}</li>`).join('');}
        
        function predictNextMonthExpenses(){const months={};transactions.filter(t=>t.tipo==='gasto'||t.tipo==='credito').forEach(t=>{const k=t.fecha.substring(0,7);if(!months[k])months[k]=0;months[k]+=parseFloat(t.monto);});const vals=Object.values(months);if(vals.length<2){document.getElementById('predictedExpenses').textContent='Datos insuficientes';return;}const avg=vals.reduce((a,b)=>a+b,0)/vals.length;const trend=vals.length>=2?vals[vals.length-1]-vals[vals.length-2]:0;const prediction=Math.round(avg+trend);document.getElementById('predictedExpenses').textContent=formatMoney(Math.max(0,prediction));}

        function prepareFinancialContext(){
            let i=0,e=0,dt={...globalDeudaPorTarjeta},td=0;const t=new Date();const p=new Date();p.setDate(t.getDate()-30);const rt=transactions.filter(x=>new Date(x.fecha)>=p);
            rt.forEach(x=>{const m=parseFloat(x.monto);if(x.tipo==='ingreso')i+=m;if(x.tipo==='gasto'||x.tipo==='credito')e+=m;});
            Object.values(dt).forEach(x=>td+=x); let cm={}; rt.filter(x=>x.tipo==='gasto').forEach(x=>{cm[x.categoria]=(cm[x.categoria]||0)+parseFloat(x.monto);});
            const tc=Object.entries(cm).sort(([,a],[,b])=>b-a).slice(0,3).map(([k,v])=>({category:k,amount:v}));
            return {income:i,expenses:e,cashFlow:i-e,totalDebt:td,debtCards:Object.values(dt).filter(x=>x>0).length,topExpenses:tc};
        }

        function formatMoney(n){return '$ '+parseFloat(n).toLocaleString('es-CO',{maximumFractionDigits:0});}
        function formatCurrencyInput(i){let v=i.value.replace(/\D/g,"");if(v===""){i.value="";return;}i.value="$ "+new Intl.NumberFormat('es-CO').format(v);}
        function parseCurrencyInput(v){return v?parseFloat(v.replace(/\D/g,'')):0;}
        function showToast(m,t){const c=document.getElementById('toastContainer');const d=document.createElement('div');d.className=`toast ${t}`;d.textContent=m;c.appendChild(d);setTimeout(()=>d.remove(),4000);}

        function findCardById(cardId){return cardsList.find(c=>c.id===cardId);}
        function resolveCreditCardId(credit){
            if(credit.cardId)return credit.cardId;
            const legacyName=credit.cardName||credit.metodoPago;
            if(!legacyName)return '';
            const card=cardsList.find(c=>c.name===legacyName);
            return card?card.id:'';
        }
        function resolveCreditCardName(credit){
            if(credit.cardId){
                const card=findCardById(credit.cardId);
                if(card)return card.name;
            }
            return credit.cardName||credit.metodoPago||'';
        }
        function isValidCardName(name){
            return typeof name==='string'&&name.trim().length>0;
        }

        function calculateDebtByCard(){
            let dm={};
            cardsList.forEach(c=>dm[c.name]=0);
            transactions.forEach(t=>{
                const m=parseFloat(t.monto);
                if(t.tipo==='pago_tarjeta'){
                    if(dm[t.tarjetaDestino]!==undefined)dm[t.tarjetaDestino]-=m;
                    return;
                }
                if(!t.esCredito)return;
                const c=resolveCreditCardName(t);
                if(!isValidCardName(c))return;
                if(dm[c]!==undefined){
                    const totalDeuda=t.totalDeuda||m;
                    const cuotas=t.cuotas||1;
                    const pagadas=t.cuotasPagadas||0;
                    const porPagar=Math.max(0,cuotas-pagadas);
                    dm[c]+=(totalDeuda/cuotas)*porPagar;
                }
            });
            return dm;
        }

        function calculateAvailableQuota(card, debtMap=globalDeudaPorTarjeta){
            const debt=debtMap[card.name]||0;
            const adjustment=card.ajusteDisponible||0;
            return (card.quota||0)-debt+adjustment;
        }

        function openCardDetail(cardName){
            currentDetailCardName=cardName;
            renderCardDetail();
            document.getElementById('cardDetailModal').style.display='flex';
        }

        function openCardDetailFromModal(cardName){
            closeModal('quotaModal');
            openCardDetail(cardName);
        }

        function renderCardDetail(){
            if(!currentDetailCardName)return;
            const cardName=currentDetailCardName;
            const card=cardsList.find(c=>c.name===cardName);
            const creditos=transactions.filter(t=>t.tipo==='credito'&&t.esCredito&&resolveCreditCardName(t)===cardName);
            const detailBody=document.getElementById('cardDetailTransactions');
            const summary=document.getElementById('cardDetailSummary');
            const meta=document.getElementById('cardDetailMeta');
            document.getElementById('cardDetailName').textContent=`${cardName}`;
            meta.textContent=`Cupo: ${formatMoney(card?.quota||0)} · Día pago: ${card?.diaPago||'No configurado'}`;

            let totalDebt=0;
            let nextInstallment=0;
            detailBody.innerHTML='';

            if(creditos.length===0){
                detailBody.innerHTML='<tr><td colspan="7" style="text-align:center; color:var(--text-muted);">Sin compras a crédito registradas.</td></tr>';
            }else{
                creditos.forEach(cred=>{
                    const total=cred.totalDeuda||cred.monto||0;
                    const cuotas=cred.cuotas||1;
                    const pagadas=cred.cuotasPagadas||0;
                    const montoCuota=total/cuotas;
                    const saldoPendiente=Math.max(0, montoCuota*(cuotas-pagadas));
                    if(pagadas<cuotas){
                        nextInstallment+=montoCuota;
                    }
                    totalDebt+=saldoPendiente;
                    detailBody.innerHTML+=`<tr>
                        <td>${formatDate(cred.fecha)}</td>
                        <td>${cred.descripcion||'Compra crédito'}</td>
                        <td>${formatMoney(total)}</td>
                        <td>${cuotas}</td>
                        <td>${pagadas}</td>
                        <td>${formatMoney(saldoPendiente)}</td>
                        <td>
                            <div class="card-detail-actions">
                                <button onclick="editCreditTransaction('${cred.id}')" class="btn-icon-action btn-icon-action--info" title="Editar compra" aria-label="Editar compra"><i class="fas fa-pen"></i></button>
                                <button onclick="editCreditTransaction('${cred.id}','cuotasPagadas')" class="btn-icon-action btn-icon-action--success" title="Actualizar cuotas pagadas" aria-label="Actualizar cuotas pagadas"><i class="fas fa-check-circle"></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
            }

            const available=card?calculateAvailableQuota(card):0;
            summary.innerHTML=`
                <div class="summary-tile">
                    <div class="summary-label">Deuda total</div>
                    <div class="summary-value" style="color:var(--danger);">${formatMoney(totalDebt)}</div>
                </div>
                <div class="summary-tile">
                    <div class="summary-label">Cuota siguiente estimada</div>
                    <div class="summary-value">${formatMoney(nextInstallment)}</div>
                </div>
                <div class="summary-tile">
                    <div class="summary-label">Cupo disponible</div>
                    <div class="summary-value" style="color:var(--success);">${formatMoney(available)}</div>
                </div>`;
        }

        function editCreditTransaction(id, focusField=null){
            closeModal('cardDetailModal');
            editTransaction(id);
            if(focusField){
                setTimeout(()=>{
                    const target=document.getElementById(focusField);
                    if(target){
                        target.focus();
                        if(typeof target.select==='function'){
                            target.select();
                        }
                    }
                },200);
            }
        }

        function updateDailyCapIndicator(){
            const dailyCapValue=document.getElementById('dailyCapValue');
            const dailySpendValue=document.getElementById('dailySpendValue');
            const dailyCapStatus=document.getElementById('dailyCapStatus');
            if(!dailyCapValue||!dailySpendValue||!dailyCapStatus)return;

            let d=0,e=0,n=0;
            transactions.forEach(t=>{
                const m=parseFloat(t.monto);
                if(t.tipo==='pago_tarjeta'){
                    if(t.metodoPago==='debito')d-=m;
                    if(t.metodoPago==='efectivo')e-=m;
                    if(t.metodoPago==='nequi')n-=m;
                }else if(!t.esCredito){
                    if(t.tipo==='ingreso'){
                        if(t.metodoPago==='debito')d+=m;
                        if(t.metodoPago==='efectivo')e+=m;
                        if(t.metodoPago==='nequi')n+=m;
                    }else if(t.tipo==='gasto'){
                        if(t.metodoPago==='debito')d-=m;
                        if(t.metodoPago==='efectivo')e-=m;
                        if(t.metodoPago==='nequi')n-=m;
                    }else if(t.tipo==='transferencia'){
                        if(t.metodoPago==='debito')d-=m;
                        if(t.metodoPago==='efectivo')e-=m;
                        if(t.metodoPago==='nequi')n-=m;
                        if(t.metodoDestino==='debito')d+=m;
                        if(t.metodoDestino==='efectivo')e+=m;
                        if(t.metodoDestino==='nequi')n+=m;
                    }
                }
            });
            const saldoDisponible=d+e+n;

            const vm=currentViewDate.getMonth();
            const vy=currentViewDate.getFullYear();
            const daysInMonth=new Date(vy, vm+1, 0).getDate();
            const excludedCategories=new Set(['vivienda','servicios_publicos']);
            const today=new Date();
            const isCurrentMonth=today.getMonth()===vm&&today.getFullYear()===vy;
            const currentDay=isCurrentMonth?Math.min(today.getDate(),daysInMonth):1;
            let gastoDia=0;

            transactions.forEach(t=>{
                if(t.tipo!=='gasto'&&t.tipo!=='credito')return;
                const categoryId=(t.categoria||'').toLowerCase();
                if(excludedCategories.has(categoryId))return;
                const [ty,tm,td]=t.fecha.split('-').map(Number);
                if((tm-1)!==vm||ty!==vy)return;
                const monto=parseFloat(t.monto);
                if(td===currentDay){
                    gastoDia+=monto;
                }
            });

            const diasRestantesIncluyendoHoy=daysInMonth-currentDay+1;
            const topeDia=Math.max(0,saldoDisponible/diasRestantesIncluyendoHoy);
            const excedido=gastoDia>topeDia;

            dailyCapValue.textContent=formatMoney(topeDia);
            dailySpendValue.textContent=formatMoney(gastoDia);
            dailyCapStatus.textContent=excedido?'Excedido':'OK';
            dailyCapStatus.style.color=excedido?'var(--danger)':'var(--success)';
        }

        function updateDashboard(){let d=0,e=0,n=0,i=0,g=0; const dm=calculateDebtByCard(); const vm=currentViewDate.getMonth(); const vy=currentViewDate.getFullYear();
        transactions.forEach(t=>{const m=parseFloat(t.monto); const[ty,tm]=t.fecha.split('-').map(Number); const iv=(tm-1)===vm&&ty===vy;
        if(t.tipo==='pago_tarjeta'){if(t.metodoPago==='debito')d-=m;if(t.metodoPago==='efectivo')e-=m;if(t.metodoPago==='nequi')n-=m;}
        else if(!t.esCredito){if(t.tipo==='ingreso'){if(t.metodoPago==='debito')d+=m;if(t.metodoPago==='efectivo')e+=m;if(t.metodoPago==='nequi')n+=m;if(iv)i+=m;}else if(t.tipo==='gasto'){if(t.metodoPago==='debito')d-=m;if(t.metodoPago==='efectivo')e-=m;if(t.metodoPago==='nequi')n-=m;if(iv)g+=m;}else if(t.tipo==='transferencia'){if(t.metodoPago==='debito')d-=m;if(t.metodoPago==='efectivo')e-=m;if(t.metodoPago==='nequi')n-=m;if(t.metodoDestino==='debito')d+=m;if(t.metodoDestino==='efectivo')e+=m;if(t.metodoDestino==='nequi')n+=m;}}else{if(iv)g+=m;}});
        globalDeudaPorTarjeta=dm; document.getElementById('saldoDebito').textContent=formatMoney(d); document.getElementById('saldoEfectivo').textContent=formatMoney(e); document.getElementById('saldoNequi').textContent=formatMoney(n); document.getElementById('saldoTotal').textContent=formatMoney(d+e+n); document.getElementById('totalIngresosMes').textContent=formatMoney(i); document.getElementById('totalGastosMes').textContent=formatMoney(g); document.getElementById('balanceMes').textContent=formatMoney(i-g);
        updateDailyCapIndicator();
        const dv=document.getElementById('cardsBreakdown'); dv.innerHTML=''; let td=0; 
        
        // Get all credit transactions grouped by card
        const creditosPorTarjeta={}; 
        transactions
            .filter(t=>t.tipo==='credito'&&t.esCredito)
            .forEach(t=>{
                const creditName=resolveCreditCardName(t);
                if(!isValidCardName(creditName))return;
                const normalizedName=creditName.trim();
                if(!creditosPorTarjeta[normalizedName])creditosPorTarjeta[normalizedName]=[];
                creditosPorTarjeta[normalizedName].push(t);
            });
        const cuotaSiguientePorTarjeta={};
        const fechaSiguientePorTarjeta={};
        const today=new Date();
        const parseIsoDate=(value)=>{const parts=value.split('-');return new Date(parts[0], parts[1]-1, parts[2]);};
        const buildPaymentDate=(year,monthIndex,day)=>{
            const lastDay=new Date(year, monthIndex+1, 0).getDate();
            return new Date(year, monthIndex, Math.min(day, lastDay));
        };
        const resolveNextPaymentDate=(cred,paymentDay,baseDate)=>{
            if(cred.proximaFechaPago){
                return parseIsoDate(cred.proximaFechaPago);
            }
            const base=baseDate||today;
            let next=buildPaymentDate(base.getFullYear(), base.getMonth(), paymentDay);
            if(next < today){
                next=buildPaymentDate(base.getFullYear(), base.getMonth()+1, paymentDay);
            }
            return next;
        };

        Object.keys(creditosPorTarjeta).forEach(cardName=>{
            if(!isValidCardName(cardName))return;
            const cardData=cardsList.find(c=>c.name===cardName);
            const paymentDay=cardData?.diaPago?parseInt(cardData.diaPago):15;
            const creditos=creditosPorTarjeta[cardName]||[];
            let totalCuota=0;
            let nearestDate=null;

            creditos.forEach(cred=>{
                const cuotas=cred.cuotas||1;
                const pagadas=cred.cuotasPagadas||0;
                if(pagadas>=cuotas)return;
                const montoCuota=(cred.totalDeuda||cred.monto)/cuotas;
                totalCuota+=montoCuota;

                const nextPaymentDate=resolveNextPaymentDate(cred, paymentDay, today);

                if(!nearestDate || nextPaymentDate < nearestDate){
                    nearestDate=nextPaymentDate;
                }
            });

            cuotaSiguientePorTarjeta[cardName]=totalCuota;
            fechaSiguientePorTarjeta[cardName]=nearestDate;
        });
        
        const resumenCuotas=Object.keys(cuotaSiguientePorTarjeta)
            .map(cardName=>({cardName,cuota:cuotaSiguientePorTarjeta[cardName]||0,fecha:fechaSiguientePorTarjeta[cardName]}))
            .filter(item=>isValidCardName(item.cardName))
            .filter(item=>item.cuota>0)
            .sort((a,b)=>{
                if(!a.fecha&&!b.fecha)return 0;
                if(!a.fecha)return 1;
                if(!b.fecha)return -1;
                return a.fecha-b.fecha;
            });
        if(resumenCuotas.length>0){
            const totalResumen=resumenCuotas.reduce((sum,item)=>sum+item.cuota,0);
            const resumenItems=resumenCuotas.map(item=>`<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(148,163,184,0.2);">
                <span>💳 ${item.cardName} - Próxima cuota aprox.</span>
                <strong>${formatMoney(item.cuota)}</strong>
            </div>`).join('');
            dv.innerHTML+=`<div style="background:var(--card-bg); border:1px solid rgba(148,163,184,0.25); border-radius:12px; padding:12px 16px; margin-bottom:16px;">
                ${resumenItems}
                <div style="display:flex; justify-content:space-between; align-items:center; padding-top:10px; font-weight:700;">
                    <span>Total general</span>
                    <span>${formatMoney(totalResumen)}</span>
                </div>
            </div>`;
        }

        Object.keys(dm).forEach(k=>{
            const creditos=creditosPorTarjeta[k]||[];
            if(dm[k]!==0||creditos.length>0){
                td+=dm[k];
                const cuotaSiguiente=cuotaSiguientePorTarjeta[k]||0;
                const fechaSiguiente=fechaSiguientePorTarjeta[k];
                const cuotaLabel=cuotaSiguiente>0?formatMoney(cuotaSiguiente):'Sin cuotas pendientes';
                const fechaLabel=cuotaSiguiente>0&&fechaSiguiente?`Fecha estimada: ${fechaSiguiente.toLocaleDateString('es-CO',{day:'numeric',month:'short'})}`:'';
                const safeCardName=k.replace(/'/g,"\\'");
                dv.innerHTML+=`<div class="credit-summary-card" id="credit-summary-${k.replace(/\s/g,'_')}">
            <div class="credit-summary-header"><span class="credit-card-name">💳 ${k}</span><div style="display:flex; gap:10px; align-items:center;">
                <button class="btn btn--ghost btn--sm" onclick="openCardDetail('${safeCardName}')"><i class="fas fa-eye"></i> Detalle</button>
                <span style="font-size:1.25rem;font-weight:700;color:var(--danger);">${formatMoney(dm[k])}</span></div></div>
            <div class="next-installment-section">
                <div class="next-installment-title"><i class="fas fa-calendar-alt"></i> Próxima cuota estimada</div>
                <div class="next-installment-value">${cuotaLabel}</div>
                ${fechaLabel?`<div class="next-installment-date">${fechaLabel}</div>`:''}
            </div>
            ${creditos.length>0?`<div class="cuotas-section"><div class="cuotas-title"><i class="fas fa-credit-card"></i> Gestión de Cuotas</div>
            <div id="cuotas-list-${k.replace(/\s/g,'_')}"></div></div>`:''}
        </div>`;
            }
        }); 
        document.getElementById('deudaTotalTC').textContent=formatMoney(td);
        
        // Simple payment option - one per credit
        Object.keys(creditosPorTarjeta).forEach(cardName=>{
            const creditos=creditosPorTarjeta[cardName];const container=document.getElementById(`cuotas-list-${cardName.replace(/\s/g,'_')}`);
            if(!container)return;container.innerHTML='';const today=new Date();const cardData=cardsList.find(c=>c.name===cardName);
            const paymentDay=cardData?.diaPago?parseInt(cardData.diaPago):15;
            
            creditos.forEach((cred,idx)=>{const cuotaTotal=cred.cuotas||1;const pagadas=cred.cuotasPagadas||0;const siguienteCuota=pagadas+1;
                if(siguienteCuota>cuotaTotal)return; // Skip if all paid
                const montoPorCuota=(cred.totalDeuda||cred.monto)/cuotaTotal;
                
                // --- CORRECCIÓN DE FECHA ---
                const nextPaymentDate=resolveNextPaymentDate(cred, paymentDay, today);
                // ---------------------------
                
                const isVencida=today>nextPaymentDate;
                const diasRestantes=Math.ceil((nextPaymentDate-today)/(1000*60*60*24));
                
                container.innerHTML+=`<div style="background:var(--bg-body);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;border:1px solid rgba(148,163,184,0.1);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <div><span style="font-weight:600;font-size:1rem;color:var(--text-primary);">${cred.descripcion||'Crédito'}</span>
                        <div style="font-size:0.8rem;color:var(--text-muted);">Cuota ${siguienteCuota} de ${cuotaTotal}</div></div>
                        <div style="text-align:right;"><span style="font-weight:700;font-size:1.2rem;color:var(--primary);">${formatMoney(montoPorCuota)}</span>
                        <div style="font-size:0.8rem;color:${isVencida?'var(--danger)':'var(--success)'};">${isVencida?'Vencida':'Pago: '+nextPaymentDate.toLocaleDateString('es-CO',{day:'numeric',month:'short'})}</div></div>
                    </div>
                    <button class="btn-cuota-pagar btn--full" onclick="pagarCuota('${cred.id}',${siguienteCuota},${montoPorCuota},'${cardName}','${paymentDay}')"><i class="fas fa-calendar-check"></i> Gestionar Pago</button>
                </div>`;
            });
        });
        
        updateDailyCapIndicator();updateFamilySummary();checkBudgetAlerts();renderReminders();
        if(currentDetailCardName){
            renderCardDetail();
        }
        }
        
        function updateFamilySummary(){const cont=document.getElementById('familySummary');const vm=currentViewDate.getMonth();const vy=currentViewDate.getFullYear();const miembros={papa:{name:'Papá',icon:'👨'},mama:{name:'Mamá',icon:'👩'},hijo1:{name:'Hijo/a',icon:'👶'},compartido:{name:'Compartido',icon:'👨‍👩‍👧‍👦'}};const stats={};Object.keys(miembros).forEach(m=>stats[m]={gastos:0,ingresos:0});
        transactions.forEach(t=>{const[ty,tm]=t.fecha.split('-').map(Number);if((tm-1)===vm&&ty===vy){const m=parseFloat(t.monto);const mem=t.miembro||'compartido';if(t.tipo==='gasto'||t.tipo==='credito')stats[mem].gastos+=m;if(t.tipo==='ingreso')stats[mem].ingresos+=m;}});
        let html='';Object.keys(stats).forEach(k=>{const mem=miembros[k];const net=stats[k].ingresos-stats[k].gastos;html+=`<div class="member-card"><div class="member-avatar">${mem.icon}</div><div class="member-name">${mem.name}</div><div style="font-size:0.8rem;color:var(--text-light);">Gastos: <span class="member-total gastos">${formatMoney(stats[k].gastos)}</span></div><div style="font-size:0.8rem;color:var(--text-light);">Ingresos: <span class="member-total ingresos">${formatMoney(stats[k].ingresos)}</div></div>`;});cont.innerHTML=html;}
        
        function checkBudgetAlerts(){const vm=currentViewDate.getMonth();const vy=currentViewDate.getFullYear();const budgets={};transactions.filter(t=>{const[ty,tm]=t.fecha.split('-').map(Number);return(t.tipo==='gasto'||t.tipo==='credito')&&(tm-1)===vm&&ty===vy;}).forEach(t=>{budgets[t.categoria]=(budgets[t.categoria]||0)+parseFloat(t.monto);});
        let exceeded=null;Object.keys(budgets).forEach(cat=>{if(budgets[cat]>1000000&&!exceeded){exceeded=cat;}});const alertDiv=document.getElementById('budgetAlert');if(exceeded){alertDiv.classList.remove('hidden');document.getElementById('budgetAlertDesc').textContent=`Has excedido $1,000,000 en ${exceeded.toUpperCase().replace(/_/g,' ')}`;}else{alertDiv.classList.add('hidden');}}
        
        function renderReminders(){
            const cont=document.getElementById('remindersContainer');
            const today=new Date();
            today.setHours(0,0,0,0);
            
            const reminders=[];
            
            Object.keys(globalDeudaPorTarjeta).forEach(card=>{
                if(globalDeudaPorTarjeta[card]>0){
                    const cardData=cardsList.find(c=>c.name===card);
                    const paymentDay=cardData?.diaPago?parseInt(cardData.diaPago):15;
                    
                    // Lógica corregida: Buscar fecha real basada en los créditos
                    const cardCredits = transactions.filter(t => 
                        t.tipo === 'credito' && 
                        t.esCredito && 
                        resolveCreditCardName(t) === card && 
                        (t.cuotasPagadas || 0) < (t.cuotas || 1)
                    );

                    let nextPaymentDate = null;

                    if (cardCredits.length > 0) {
                        // Obtener todas las próximas fechas de pago
                        const dates = cardCredits.map(cred => {
                            if (cred.proximaFechaPago) {
                                const parts = cred.proximaFechaPago.split('-');
                                return new Date(parts[0], parts[1] - 1, parts[2]);
                            } else {
                                // Si no hay fecha guardada, usar el default de este mes
                                let d = new Date(today.getFullYear(), today.getMonth(), paymentDay);
                                // Si hoy ya pasó el día de pago y no se ha pagado (no tiene proximaFechaPago), 
                                // técnicamente está vencido o es hoy, así que dejamos esa fecha para que salga alerta.
                                return d;
                            }
                        });
                        // Ordenar y tomar la más antigua (la deuda más próxima)
                        dates.sort((a,b) => a - b);
                        nextPaymentDate = dates[0];
                    }

                    // Fallback si algo falla
                    if (!nextPaymentDate) {
                        nextPaymentDate = new Date(today.getFullYear(), today.getMonth(), paymentDay);
                        if(nextPaymentDate < today){
                            nextPaymentDate = new Date(today.getFullYear(), today.getMonth()+1, paymentDay);
                        }
                    }

                    const daysUntilPayment=Math.ceil((nextPaymentDate-today)/(1000*60*60*24));
                    
                    reminders.push({
                        title:`Pago ${card}`,
                        desc:`Deuda actual: ${formatMoney(globalDeudaPorTarjeta[card])}`,
                        date:nextPaymentDate,
                        daysUntil:daysUntilPayment
                    });
                }
            });

            if(reminders.length===0){cont.innerHTML='';return;}
            
            let html='';
            reminders.forEach(r=>{
                // Ajustar colores según urgencia
                const isOverdue = r.daysUntil <= 0;
                const isUrgent = r.daysUntil <= 3;
                const isWarning = r.daysUntil <= 7;
                
                let urgencyClass = 'var(--text-muted)';
                let urgencyBg = 'transparent';
                let iconClass = 'fas fa-calendar-alt'; // Icono normal

                if(isOverdue) {
                    urgencyClass = 'var(--danger)';
                    urgencyBg = 'var(--danger-light)';
                    iconClass = 'fas fa-exclamation-circle';
                } else if(isUrgent) {
                    urgencyClass = '#c2410c'; // Naranja oscuro
                    urgencyBg = '#ffedd5'; // Naranja claro
                    iconClass = 'fas fa-clock';
                } else if(isWarning) {
                    urgencyClass = 'var(--warning)';
                    urgencyBg = 'var(--warning-light)';
                }

                html+=`<div class="reminder-card" style="background:${urgencyBg}; border-left: 4px solid ${isOverdue ? 'var(--danger)' : (isUrgent ? '#f97316' : (isWarning ? 'var(--warning)' : 'transparent'))};">
                    <div class="reminder-icon"><i class="${iconClass}" style="color:${isOverdue ? 'var(--danger)' : (isUrgent ? '#f97316' : 'var(--warning)')}"></i></div>
                    <div class="reminder-text">
                        <div class="reminder-title">${r.title}</div>
                        <div class="reminder-date" style="font-size:0.75rem;color:var(--text-muted);">Próximo pago: ${r.date.toLocaleDateString('es-CO',{weekday:'short',day:'numeric',month:'short'})}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:600;color:${urgencyClass};font-size:0.9rem;">${r.daysUntil < 0 ? 'Vencido (' + Math.abs(r.daysUntil) + 'd)' : (r.daysUntil===0 ? '¡Hoy!' : (r.daysUntil===1 ? 'Mañana' : `${r.daysUntil} días`))}</div>
                        <div style="font-size:0.85rem;color:var(--text-muted);">${r.desc}</div>
                    </div>
                </div>`;
            });
            cont.innerHTML=html;
        }
        
        let tempPagoCuotaData=null;
        function buildPaymentDate(year,monthIndex,day){
            const lastDay=new Date(year, monthIndex+1, 0).getDate();
            return new Date(year, monthIndex, Math.min(day, lastDay));
        }
        function resolveCurrentPaymentDate(credito,paymentDay){
            if(credito.proximaFechaPago){
                const parts=credito.proximaFechaPago.split('-');
                return new Date(parts[0], parts[1]-1, parts[2]);
            }
            const today=new Date();
            let next=buildPaymentDate(today.getFullYear(), today.getMonth(), paymentDay);
            if(next < today){
                next=buildPaymentDate(today.getFullYear(), today.getMonth()+1, paymentDay);
            }
            return next;
        }
        function addNextPaymentMonth(baseDate,paymentDay){
            const year=baseDate.getFullYear();
            const month=baseDate.getMonth()+1;
            return buildPaymentDate(year, month, paymentDay);
        }
        
        // Función unificada para pagar cuota
        window.pagarCuota = function(creditId, cuotaNum, monto, cardName, paymentDay) {
            const credito = transactions.find(t => t.id === creditId);
            if (!credito) {
                showToast('Crédito no encontrado', 'error');
                return;
            }
            // Importante: Guardar el ID correctamente
            const resolvedPaymentDay=parseInt(paymentDay, 10) || 15;
            const paymentDate=resolveCurrentPaymentDate(credito, resolvedPaymentDay);
            tempPagoCuotaData = { creditId, cuotaNum, monto, cardName, paymentDay: resolvedPaymentDay, paymentDate };
            
            const infoDiv = document.getElementById('pagoCuotaInfo');
            infoDiv.innerHTML = `Cuota <strong>${cuotaNum}</strong> de ${credito.cuotas||1} - <strong>${formatMoney(monto)}</strong><br>Tarjeta: ${cardName}<br>Fecha de pago automática: <strong>${paymentDate.toLocaleDateString('es-CO',{day:'numeric',month:'short',year:'numeric'})}</strong>`;
            
            document.getElementById('pagoCuotaModal').style.display = 'flex';
        }
        
        window.confirmarPagoCuota = async function() {
            if (!tempPagoCuotaData) return;
            const paymentDate=tempPagoCuotaData.paymentDate;
            const año=paymentDate.getFullYear();
            const mes=String(paymentDate.getMonth() + 1).padStart(2, '0');
            const dia=String(paymentDate.getDate()).padStart(2, '0');
            const fechaPagoActual=`${año}-${mes}-${dia}`;
            const btn = document.getElementById('btnConfirmarPagoCuota');
            if (btn) btn.classList.add('is-loading');
            
            try {
                const credito = transactions.find(t => t.id === tempPagoCuotaData.creditId);
                const nuevasPagadas = Math.max(credito.cuotasPagadas || 0, tempPagoCuotaData.cuotaNum);
                const totalCuotas = credito.cuotas || 1;
                if (nuevasPagadas >= totalCuotas) {
                    await db.collection('transactions').doc(tempPagoCuotaData.creditId).delete();
                } else {
                    const proximaFecha = addNextPaymentMonth(paymentDate, tempPagoCuotaData.paymentDay);
                    const añoProximo = proximaFecha.getFullYear();
                    const mesProximo = String(proximaFecha.getMonth() + 1).padStart(2, '0');
                    const diaProximo = String(proximaFecha.getDate()).padStart(2, '0');
                    const nuevaFecha = `${añoProximo}-${mesProximo}-${diaProximo}`;
                    await db.collection('transactions').doc(tempPagoCuotaData.creditId).update({
                        cuotasPagadas: nuevasPagadas,
                        proximaFechaPago: nuevaFecha
                    });
                }
                
                closeModal('pagoCuotaModal');
                if (nuevasPagadas >= totalCuotas) {
                    showToast(`✅ Crédito liquidado con el pago de la cuota ${tempPagoCuotaData.cuotaNum} (${formatDate(fechaPagoActual)})`, 'success');
                } else {
                    const proximaFecha = addNextPaymentMonth(paymentDate, tempPagoCuotaData.paymentDay);
                    const añoProximo = proximaFecha.getFullYear();
                    const mesProximo = String(proximaFecha.getMonth() + 1).padStart(2, '0');
                    const diaProximo = String(proximaFecha.getDate()).padStart(2, '0');
                    const nuevaFecha = `${añoProximo}-${mesProximo}-${diaProximo}`;
                    showToast(`✅ Cuota ${tempPagoCuotaData.cuotaNum} registrada (${formatDate(fechaPagoActual)}). Próximo pago: ${formatDate(nuevaFecha)}`, 'success');
                }
                loadTransactions();
            } catch (e) {
                console.error(e);
                showToast('Error al actualizar', 'error');
            } finally {
                if (btn) btn.classList.remove('is-loading');
            }
        }
        
        function renderGoals(){const cont=document.getElementById('goalsContainer');if(goals.length===0){cont.innerHTML='<p style="text-align:center;color:var(--text-light);">No tienes objetivos definidos</p>';return;}
        let html='';goals.forEach(g=>{const pct=Math.min(100,Math.round((g.saved/g.target)*100));const daysLeft=Math.ceil((new Date(g.deadline)-new Date())/(1000*60*60*24));html+=`<div class="goal-card"><div class="goal-header"><div class="goal-name">${g.name}</div><div style="font-weight:700;color:var(--primary);">${pct}%</div></div><div class="goal-progress"><div class="goal-progress-bar" style="width:${pct}%"></div></div><div class="goal-stats"><span>Ahorrado: ${formatMoney(g.saved)}</span><span>Meta: ${formatMoney(g.target)}</span></div><div class="goal-stats" style="margin-top:5px;"><span>${daysLeft>0?`${daysLeft} días restantes`:'Vencido'}</span></div><div class="goal-actions"><button class="btn btn--primary btn--sm" onclick="addToGoal('${g.id}')"><i class="fas fa-plus"></i> Agregar</button><button class="btn btn--danger btn--sm" onclick="deleteGoal('${g.id}')"><i class="fas fa-trash"></i></button></div></div>`;});cont.innerHTML=html;}
        
        function loadGoals(){const stored=localStorage.getItem('goals');if(stored){goals=JSON.parse(stored);renderGoals();}}
        async function saveGoal(){const name=document.getElementById('goalName').value.trim();const target=parseCurrencyInput(document.getElementById('goalTarget').value);const saved=parseCurrencyInput(document.getElementById('goalSaved').value);const deadline=document.getElementById('goalDeadline').value;if(!name||target<=0){showToast('Completa los campos correctamente','error');return;}
        const goal={id:Date.now().toString(),name,target,saved,deadline};goals.push(goal);localStorage.setItem('goals',JSON.stringify(goals));closeModal('goalModal');renderGoals();showToast('Objetivo guardado','success');}
        async function addToGoal(id){const g=goals.find(goal=>goal.id===id);if(!g)return;const amount=prompt(`¿Cuánto quieres agregar a "${g.name}"?`);if(!amount)return;const val=parseCurrencyInput(amount);if(val<=0){showToast('Monto inválido','error');return;}g.saved+=val;localStorage.setItem('goals',JSON.stringify(goals));renderGoals();showToast('Ahorro actualizado','success');}
        async function deleteGoal(id){if(!confirm('¿Eliminar este objetivo?'))return;goals=goals.filter(g=>g.id!==id);localStorage.setItem('goals',JSON.stringify(goals));renderGoals();showToast('Objetivo eliminado','success');}
        function openGoalModal(){document.getElementById('goalName').value='';document.getElementById('goalTarget').value='';document.getElementById('goalSaved').value='';document.getElementById('goalModal').style.display='flex';}

        function exportToCSV(){let csv='Fecha,Tipo,Método,Categoría,Subcategoría,Responsable,Descripción,Monto\n';transactions.forEach(t=>{const m=t.monto;const metodo=t.tipo==='credito'?resolveCreditCardName(t):t.metodoPago;csv+=`${t.fecha},${t.tipo},${metodo},${t.categoria||''},${t.subcategoria||''},${t.miembro||''},"${t.descripcion.replace(/"/g,'""')}",${m}\n`;});const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='crm_financiero.csv';a.click();showToast('CSV exportado','success');}
        function exportToPDF(){window.print();showToast('Usa Ctrl+P para guardar como PDF','info');}

        function toggleVoiceSearch(){const btn=document.getElementById('voiceSearchBtn');if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){showToast('Búsqueda por voz no soportada','error');return;}
        const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;const recognition=new SpeechRecognition();recognition.lang='es-CO';recognition.interimResults=false;
        if(btn.classList.contains('recording')){recognition.stop();btn.classList.remove('recording');return;}
        recognition.start();btn.classList.add('recording');recognition.onresult=(event=>{const text=event.results[0][0].transcript;document.getElementById('filterText').value=text;renderHistory();btn.classList.remove('recording');showToast(`Buscando: "${text}"`,'success');});recognition.onerror=()=>{btn.classList.remove('recording');showToast('Error en reconocimiento','error');};recognition.onend=()=>{btn.classList.remove('recording');};}

        function updateDashboardView(){const v=document.getElementById('dashboardMonth').value; if(v){const[y,m]=v.split('-'); currentViewDate=new Date(parseInt(y),parseInt(m)-1,1); updateDashboard(); updateDailyCapIndicator(); renderCharts();}}
        function renderTrendChart(){const c=document.getElementById('chartTendencias'); if(trendChartInstance)trendChartInstance.destroy(); const l=[],i=[],g=[],t=new Date(),b={}; for(let x=5;x>=0;x--){const d=new Date(t.getFullYear(),t.getMonth()-x,1);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;b[k]={i:0,g:0};l.push(d.toLocaleString('es-CO',{month:'short'}));} transactions.forEach(tx=>{const k=tx.fecha.substring(0,7);if(b[k]){if(tx.tipo==='ingreso')b[k].i+=parseFloat(tx.monto);else if(tx.tipo==='gasto'||tx.tipo==='credito')b[k].g+=parseFloat(tx.monto);}}); Object.keys(b).sort().forEach(k=>{i.push(b[k].i);g.push(b[k].g);}); trendChartInstance=new Chart(c,{type:'line',data:{labels:l,datasets:[{label:'Ing',data:i,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',fill:true},{label:'Gas',data:g,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}});}
        function renderCharts(){const c=document.getElementById('chartCategorias'); if(chartInstance)chartInstance.destroy(); const ct={},vm=currentViewDate.getMonth(),vy=currentViewDate.getFullYear(); transactions.filter(t=>(t.tipo==='gasto'||t.tipo==='credito')).forEach(t=>{const[ty,tm]=t.fecha.split('-').map(Number);if((tm-1)===vm&&ty===vy){const n=t.categoria||'Otros';ct[n]=(ct[n]||0)+parseFloat(t.monto);}}); chartInstance=new Chart(c,{type:'doughnut',data:{labels:Object.keys(ct),datasets:[{data:Object.values(ct),backgroundColor:['#6366f1','#ec4899','#10b981','#f59e0b','#3b82f6','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}});}
        
        async function loadCards(){try{const s=await db.collection('cards').orderBy('name').get(); cardsList=[]; s.forEach(d=>cardsList.push({id:d.id,...d.data()})); if(cardsList.length===0){await seedDefaultCards();return;} populateCardSelects(); populateMethodFilter(); loadTransactions();}catch(e){console.error(e);}}
        async function seedDefaultCards(){const cards=[{name:'Exito',diaPago:5},{name:'Nu',diaPago:15},{name:'Falabella',diaPago:20}]; const b=db.batch(); cards.forEach(c=>b.set(db.collection('cards').doc(),{name:c.name,quota:0,diaPago:c.diaPago,ajusteDisponible:0})); await b.commit(); loadCards();}
        function populateCardSelects(){const s1=document.getElementById('tarjetaCredito'); const s2=document.getElementById('tarjetaDestinoPago'); s1.innerHTML=''; s2.innerHTML=''; cardsList.forEach(c=>{s1.add(new Option(c.name,c.id));s2.add(new Option(c.name,c.name));});}
        async function loadTransactions(){
            const s=await db.collection('transactions').orderBy('fecha','desc').get();
            const offlineData=getStoredOfflineTransactions();
            const pendingDeletes=getStoredPendingDeletes();
            const offlineTransactions=offlineData.map(item=>({...item,id:`offline-${item.id}`,pendingSync:true}));
            transactions=[];
            s.forEach(d=>transactions.push({id:d.id,...d.data(),pendingDelete:pendingDeletes.includes(d.id)}));
            transactions=[...offlineTransactions,...transactions].map(t=>{
                if(t.tipo==='credito'){
                    const legacyName=t.cardName||t.metodoPago;
                    const cardId=t.cardId||cardsList.find(c=>c.name===legacyName)?.id||'';
                    const cardName=cardId?(findCardById(cardId)?.name||legacyName):legacyName||'';
                    return {...t,cardId,cardName};
                }
                return t;
            }).sort((a,b)=>a.fecha<b.fecha?1:-1);
            updateDashboard(); renderHistory(); renderCharts(); renderTrendChart();
        }
        
        function handleTipoChange(){const t=document.getElementById('tipo').value; const cc=document.getElementById('creditConfig'); const pc=document.getElementById('divPagoTarjeta'); const mp=document.getElementById('metodoPagoDiv'); const md=document.getElementById('metodoDestinoDiv'); const cat=document.getElementById('categoria'); cc.classList.add('hidden'); pc.classList.add('hidden'); mp.classList.remove('hidden'); md.classList.add('hidden'); if(t==='credito'){cc.classList.remove('hidden');mp.classList.add('hidden');}else if(t==='pago_tarjeta'){pc.classList.remove('hidden');}else if(t==='transferencia'){md.classList.remove('hidden');} cat.innerHTML='<option value="">Seleccione...</option>'; document.getElementById('subcategoriaDiv').classList.add('hidden'); if(t==='pago_tarjeta')cat.add(new Option('Abono Tarjeta','pago_tc')); else if(t==='transferencia')cat.add(new Option('Transferencia','transferencia')); else{const g=t==='credito'?'gasto':t;if(categorias[g]){Object.keys(categorias[g]).forEach(k=>{cat.add(new Option(categorias[g][k].icon+' '+k.toUpperCase().replace(/_/g,' '),k));});}}}
        document.getElementById('categoria').addEventListener('change',function(){const t=document.getElementById('tipo').value;if(t==='pago_tarjeta'||t==='transferencia')return;const k=this.value;const s=document.getElementById('subcategoria');const d=document.getElementById('subcategoriaDiv');const g=t==='credito'?'gasto':t;if(k&&categorias[g][k]){d.classList.remove('hidden');s.innerHTML='';categorias[g][k].subcategorias.forEach(x=>s.add(new Option(x,x)));}else d.classList.add('hidden');});
        function preSubmit(){
            const t=document.getElementById('tipo').value;
            const m=parseCurrencyInput(document.getElementById('monto').value);
            if(m<=0){alert('Monto inválido');return;}
            const d={tipo:t,monto:m,categoria:document.getElementById('categoria').value,subcategoria:document.getElementById('subcategoria').value||'',miembro:document.getElementById('miembro').value,descripcion:document.getElementById('descripcion').value,fecha:document.getElementById('fecha').value,timestamp:firebase.firestore.FieldValue.serverTimestamp()};
            if(t==='credito'){
                const tc=document.getElementById('tarjetaCredito').value;
                const c=parseInt(document.getElementById('cuotas').value);
                const pagadasRaw=parseInt(document.getElementById('cuotasPagadas').value);
                const cardData=findCardById(tc);
                const cardName=cardData?.name||'';
                const paymentDay=cardData?.diaPago?parseInt(cardData.diaPago):15;
                if(!c||c<=0){showToast('Completa cuotas válidas','error');alert('Completa cuotas válidas');return;}
                const today=new Date();
                const todayLocal=new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const formatLocalDate=(date)=>`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                const fechaPrimerPago=formatLocalDate(todayLocal);
                let proximaPago=buildPaymentDate(todayLocal.getFullYear(), todayLocal.getMonth(), paymentDay);
                if(proximaPago < todayLocal){
                    proximaPago=buildPaymentDate(todayLocal.getFullYear(), todayLocal.getMonth()+1, paymentDay);
                }
                d.cardId=tc;
                d.cardName=cardName;
                d.esCredito=true;
                d.cuotas=c;
                d.totalDeuda=m;
                d.fechaPrimerPago=fechaPrimerPago;
                d.proximaFechaPago=formatLocalDate(proximaPago);
                const pagadas=Number.isNaN(pagadasRaw)?0:Math.min(Math.max(pagadasRaw,0),c);
                d.cuotasPagadas=pagadas;
                tempTransactionData=d;
                document.getElementById('modalTarjeta').textContent=cardName;
                document.getElementById('modalCuotas').textContent=c;
                document.getElementById('modalTotalDeuda').textContent=formatMoney(m);
                document.getElementById('creditModal').style.display='flex';
            }else{
                if(t==='pago_tarjeta'){
                    d.metodoPago=document.getElementById('metodoPago').value;
                    d.tarjetaDestino=document.getElementById('tarjetaDestinoPago').value;
                }else{
                    d.metodoPago=document.getElementById('metodoPago').value;
                    if(t==='transferencia')d.metodoDestino=document.getElementById('metodoDestino').value;
                }
                saveTransaction(d);
            }
        }
        function confirmSaveTransaction(){if(tempTransactionData)saveTransaction(tempTransactionData);closeModal('creditModal');}
        async function saveTransaction(d){const btn=document.getElementById('btnSubmitText');if(btn)btn.classList.add('is-loading');try{if(editingTransactionId)await db.collection('transactions').doc(editingTransactionId).update(d);else await db.collection('transactions').add(d); cancelEdit(); loadTransactions(); showToast(editingTransactionId?'Actualizado':'Guardado','success');}catch(e){saveToLocal(d);loadTransactions();showToast('Guardado localmente (offline)','warning');}finally{if(btn)btn.classList.remove('is-loading');}}
        function cancelEdit(){editingTransactionId=null; document.getElementById('transactionForm').reset(); document.getElementById('formTitle').textContent='Nueva Transacción'; document.getElementById('btnCancelar').classList.add('hidden'); document.getElementById('btnSubmitText').textContent='Guardar'; handleTipoChange();}
        window.editTransaction=function(id){const t=transactions.find(x=>x.id===id);if(!t)return;editingTransactionId=id;switchView('transacciones');document.getElementById('tipo').value=t.tipo;handleTipoChange();const m=document.getElementById('monto');m.value=t.monto;formatCurrencyInput(m);document.getElementById('descripcion').value=t.descripcion;document.getElementById('fecha').value=t.fecha;document.getElementById('miembro').value=t.miembro;if(t.tipo==='credito'){document.getElementById('tarjetaCredito').value=resolveCreditCardId(t);document.getElementById('cuotas').value=t.cuotas;document.getElementById('cuotasPagadas').value=t.cuotasPagadas||0;}else if(t.tipo==='pago_tarjeta'){document.getElementById('metodoPago').value=t.metodoPago;document.getElementById('tarjetaDestinoPago').value=t.tarjetaDestino;}else{document.getElementById('metodoPago').value=t.metodoPago;if(t.tipo==='transferencia')document.getElementById('metodoDestino').value=t.metodoDestino;}document.getElementById('formTitle').textContent='Editar';document.getElementById('btnSubmitText').textContent='Actualizar';document.getElementById('btnCancelar').classList.remove('hidden');setTimeout(()=>{document.getElementById('categoria').value=t.categoria;const e=new Event('change');document.getElementById('categoria').dispatchEvent(e);setTimeout(()=>{if(t.subcategoria)document.getElementById('subcategoria').value=t.subcategoria;},50);},100);}
        window.deleteTransaction=async function(id){
            if(!confirm("¿Estás seguro?\nEsta acción no se puede deshacer."))return;
            try{
                if(String(id).startsWith('offline-')){
                    saveToLocal(null,true,id);
                    loadTransactions();
                    showToast('Eliminación local completada','success');
                    return;
                }
                await db.collection('transactions').doc(id).delete();
                loadTransactions();
                showToast('Borrado','success');
            }catch(e){
                saveToLocal(null,true,id);
                loadTransactions();
                showToast('Eliminación pendiente','warning');
            }
        }

        function queueConsistencyCorrection(map, entry) {
            const key = `${entry.entity}:${entry.id}`;
            if (!map.has(key)) {
                map.set(key, { ...entry, reasons: entry.reasons || [] });
                return;
            }
            const existing = map.get(key);
            existing.data = { ...existing.data, ...entry.data };
            existing.reasons = Array.from(new Set([...(existing.reasons || []), ...(entry.reasons || [])]));
            if (entry.label) {
                existing.label = existing.label ? `${existing.label}; ${entry.label}` : entry.label;
            }
        }

        function runConsistencyAudit() {
            const issues = [];
            const correctionMap = new Map();
            const debtMap = calculateDebtByCard();
            const creditTransactions = transactions.filter(t => t.tipo === 'credito' && t.esCredito && !t.pendingDelete);

            cardsList.forEach(card => {
                const debt = debtMap[card.name] || 0;
                const baseAvailable = (card.quota || 0) - debt;
                const adjustment = card.ajusteDisponible || 0;
                const adjustedAvailable = baseAvailable + adjustment;
                const diff = adjustment;
                if (Math.abs(diff) > 0.01) {
                    issues.push({
                        title: `${card.name} · Cupo vs deuda`,
                        badge: 'Cupo',
                        badgeClass: '',
                        body: `Deuda calculada: ${formatMoney(debt)} · Cupo disponible ajustado: ${formatMoney(adjustedAvailable)} · Diferencia: ${formatMoney(diff)}.`,
                        meta: `Sugerencia: ajustar ajusteDisponible a ${formatMoney(0)} para alinear cálculos.`
                    });
                    queueConsistencyCorrection(correctionMap, {
                        entity: 'cards',
                        id: card.id,
                        data: { ajusteDisponible: 0 },
                        label: `Ajuste de cupo en ${card.name} → ${formatMoney(0)}`,
                        reasons: ['Ajuste distinto a la deuda calculada.']
                    });
                }
            });

            creditTransactions.forEach(tx => {
                if (String(tx.id).startsWith('offline-')) {
                    return;
                }
                const cuotasRaw = Number(tx.cuotas);
                const cuotas = Number.isFinite(cuotasRaw) && cuotasRaw > 0 ? cuotasRaw : 1;
                const pagadasRaw = Number(tx.cuotasPagadas || 0);
                const pagadas = Math.min(Math.max(pagadasRaw, 0), cuotas);
                const totalRaw = Number(tx.totalDeuda || 0);
                const monto = Number(tx.monto || 0);
                const total = totalRaw > 0 ? totalRaw : monto;
                const remaining = Math.max(0, cuotas - pagadas);
                const remainingDebt = (total / cuotas) * remaining;
                const label = tx.descripcion ? `${tx.descripcion}` : 'Compra crédito';

                if (cuotasRaw !== cuotas) {
                    issues.push({
                        title: `${label} · Cuotas inválidas`,
                        badge: 'Cuotas',
                        badgeClass: 'audit-badge--danger',
                        body: `Cuotas registradas: ${Number.isFinite(cuotasRaw) ? cuotasRaw : 'N/A'}. Se recomienda usar ${cuotas}.`,
                        meta: `Sugerencia: ajustar cuotas a ${cuotas}.`
                    });
                    queueConsistencyCorrection(correctionMap, {
                        entity: 'transactions',
                        id: tx.id,
                        data: { cuotas },
                        label: `Cuotas corregidas en ${label} → ${cuotas}`,
                        reasons: ['Cuotas inválidas.']
                    });
                }

                if (pagadasRaw !== pagadas) {
                    issues.push({
                        title: `${label} · Cuotas pagadas fuera de rango`,
                        badge: 'Cuotas',
                        badgeClass: 'audit-badge--danger',
                        body: `Cuotas pagadas: ${pagadasRaw}. Rango esperado: 0 - ${cuotas}.`,
                        meta: `Sugerencia: ajustar cuotasPagadas a ${pagadas}.`
                    });
                    queueConsistencyCorrection(correctionMap, {
                        entity: 'transactions',
                        id: tx.id,
                        data: { cuotasPagadas: pagadas },
                        label: `Cuotas pagadas corregidas en ${label} → ${pagadas}`,
                        reasons: ['Cuotas pagadas fuera de rango.']
                    });
                }

                if (totalRaw <= 0 && monto > 0) {
                    issues.push({
                        title: `${label} · Total deuda vacío`,
                        badge: 'Deuda',
                        badgeClass: 'audit-badge--danger',
                        body: `Total deuda registrado: ${formatMoney(totalRaw)} · Monto: ${formatMoney(monto)}.`,
                        meta: `Sugerencia: registrar totalDeuda como ${formatMoney(monto)}.`
                    });
                    queueConsistencyCorrection(correctionMap, {
                        entity: 'transactions',
                        id: tx.id,
                        data: { totalDeuda: monto },
                        label: `Total deuda corregido en ${label} → ${formatMoney(monto)}`,
                        reasons: ['Total deuda faltante.']
                    });
                }

                if (remainingDebt > total + 1) {
                    issues.push({
                        title: `${label} · Cuotas restantes vs deuda`,
                        badge: 'Deuda',
                        badgeClass: 'audit-badge--danger',
                        body: `Suma de cuotas restantes: ${formatMoney(remainingDebt)} · Deuda total registrada: ${formatMoney(total)}.`,
                        meta: 'Revisa cuotas o totalDeuda para evitar sobreestimación.'
                    });
                }
            });

            cardsList.forEach(card => {
                const cardCredits = creditTransactions.filter(t => resolveCreditCardName(t) === card.name);
                if (!cardCredits.length) return;
                const totalDebtRecorded = cardCredits.reduce((sum, tx) => sum + Number(tx.totalDeuda || tx.monto || 0), 0);
                const remainingSum = cardCredits.reduce((sum, tx) => {
                    const cuotas = Number(tx.cuotas) > 0 ? Number(tx.cuotas) : 1;
                    const pagadas = Math.min(Math.max(Number(tx.cuotasPagadas || 0), 0), cuotas);
                    const total = Number(tx.totalDeuda || tx.monto || 0);
                    return sum + (total / cuotas) * Math.max(0, cuotas - pagadas);
                }, 0);

                if (remainingSum > totalDebtRecorded + 1) {
                    issues.push({
                        title: `${card.name} · Cuotas restantes vs deuda`,
                        badge: 'Deuda',
                        badgeClass: 'audit-badge--danger',
                        body: `Suma de cuotas restantes: ${formatMoney(remainingSum)} · Deuda total registrada: ${formatMoney(totalDebtRecorded)}.`,
                        meta: 'Revisa totales de crédito para ajustar el saldo real.'
                    });
                }
            });

            consistencyAudit = { issues, corrections: Array.from(correctionMap.values()) };
            renderConsistencyAlerts();
        }

        function renderConsistencyAlerts() {
            const container = document.getElementById('consistencyAlertList');
            const btn = document.getElementById('btnApplyConsistencyCorrections');
            if (!container) return;
            if (!consistencyAudit.issues.length) {
                container.innerHTML = '<div class="audit-empty">No se encontraron inconsistencias.</div>';
                if (btn) btn.disabled = true;
                return;
            }
            container.innerHTML = consistencyAudit.issues.map(issue => `
                <div class="audit-item">
                    <div class="audit-item-header">
                        <span class="audit-item-title">${issue.title}</span>
                        <span class="audit-badge ${issue.badgeClass || ''}">${issue.badge}</span>
                    </div>
                    <div class="audit-item-body">${issue.body}</div>
                    <div class="audit-item-meta">${issue.meta || 'Sin acción sugerida.'}</div>
                </div>
            `).join('');
            if (btn) btn.disabled = !consistencyAudit.corrections.length;
        }

        async function applyConsistencyCorrections() {
            const corrections = consistencyAudit.corrections || [];
            if (!corrections.length) {
                showToast('No hay correcciones disponibles', 'info');
                return;
            }
            const summary = corrections.map(c => `• ${c.label}`).join('\n');
            if (!confirm(`Se aplicarán ${corrections.length} correcciones:\n${summary}\n\n¿Deseas continuar?`)) return;
            const btn = document.getElementById('btnApplyConsistencyCorrections');
            if (btn) btn.classList.add('is-loading');
            try {
                for (const correction of corrections) {
                    if (correction.entity === 'cards') {
                        await db.collection('cards').doc(correction.id).update({
                            ...correction.data,
                            auditUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    if (correction.entity === 'transactions') {
                        if (String(correction.id).startsWith('offline-')) {
                            continue;
                        }
                        await db.collection('transactions').doc(correction.id).update({
                            ...correction.data,
                            auditUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                showToast('Correcciones aplicadas', 'success');
                loadCards();
                setTimeout(() => {
                    openQuotaModal();
                    runConsistencyAudit();
                }, 500);
            } catch (e) {
                console.error(e);
                showToast('Error al aplicar correcciones', 'error');
            } finally {
                if (btn) btn.classList.remove('is-loading');
            }
        }
        function openQuotaModal(){
            const d=document.getElementById('quotaListContainer');
            d.innerHTML='';
            cardsList.forEach(c=>{
                const db=globalDeudaPorTarjeta[c.name]||0;
                const av=calculateAvailableQuota(c);
                const safeName=c.name.replace(/'/g,"\\'");
                const el=document.createElement('div');
                el.className='quota-card';
                el.innerHTML=`<div class="quota-header"><span>${c.name}</span><div><button onclick="editCard('${c.id}','${safeName}','${c.quota}','${c.ajusteDisponible||0}','${c.diaPago||''}')" class="btn-icon-action btn-icon-action--info"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteCard('${c.id}')" class="btn-icon-action btn-icon-action--danger"><i class="fas fa-trash"></i></button></div></div><div class="quota-details"><span class="text-danger">Deuda a la fecha: ${formatMoney(db)}</span><span style="color:var(--success);">Cupo disponible: ${formatMoney(av)}</span></div>`;
                d.appendChild(el);
            });
            document.getElementById('cardNameInput').value='';
            document.getElementById('cardQuotaInput').value='';
            document.getElementById('cardAvailableAdjustmentInput').value='';
            document.getElementById('cardPaymentDayInput').value='';
            document.getElementById('editCardId').value='';
            document.getElementById('btnSaveCard').innerHTML='<i class="fas fa-plus"></i>';
            consistencyAudit = { issues: [], corrections: [] };
            renderConsistencyAlerts();
            document.getElementById('quotaModal').style.display='flex';
        }
        function closeModal(id){document.getElementById(id).style.display='none';if(id==='cardDetailModal')currentDetailCardName=null;}
        async function saveCard(){const n=document.getElementById('cardNameInput').value.trim();const q=parseCurrencyInput(document.getElementById('cardQuotaInput').value);const adj=parseCurrencyInput(document.getElementById('cardAvailableAdjustmentInput').value);const pRaw=document.getElementById('cardPaymentDayInput').value.trim();const i=document.getElementById('editCardId').value;const btn=document.getElementById('btnSaveCard');if(!n)return;const dupe=cardsList.some(c=>c.name===n&&c.id!==i);if(dupe){showToast('Nombre ya existe','warning');return;}let diaPago=null;if(pRaw!==''){const pNum=Number(pRaw);if(!Number.isInteger(pNum)||pNum<1||pNum>31){showToast('Día de pago inválido','warning');return;}diaPago=pNum;}if(btn)btn.classList.add('is-loading');try{if(i)await db.collection('cards').doc(i).update({name:n,quota:q,diaPago,ajusteDisponible:adj});else await db.collection('cards').add({name:n,quota:q,diaPago,ajusteDisponible:adj});await loadCards();openQuotaModal();}catch(e){console.error(e);showToast('Error al guardar','error');}finally{if(btn)btn.classList.remove('is-loading');}}
        async function reconcileCard(id){
            const card=findCardById(id);
            if(!card){showToast('Tarjeta no encontrada','error');return;}
            const debtMap=calculateDebtByCard();
            const debt=debtMap[card.name]||0;
            const baseAvailable=(card.quota||0)-debt;
            const currentAvailable=baseAvailable+(card.ajusteDisponible||0);
            const input=prompt(`Saldo real disponible para "${card.name}" (base: ${formatMoney(baseAvailable)}).`, formatMoney(currentAvailable));
            if(input===null)return;
            const saldoReal=parseCurrencyInput(input);
            if(Number.isNaN(saldoReal)){showToast('Saldo inválido','warning');return;}
            const ajuste=saldoReal-baseAvailable;
            const confirmMsg=`Se aplicará un ajuste de ${formatMoney(ajuste)} para "${card.name}".\n¿Confirmar conciliación?`;
            if(!confirm(confirmMsg))return;
            try{
                await db.collection('cards').doc(id).update({ajusteDisponible:ajuste});
                await loadCards();
                openQuotaModal();
                showToast('Conciliación aplicada','success');
            }catch(e){
                console.error(e);
                showToast('Error al conciliar','error');
            }
        }
        async function deleteCard(id){
            const card=findCardById(id);
            const cardName=card?.name||'';
            const relatedTransactions=transactions.filter(t=>t.cardId===id||resolveCreditCardName(t)===cardName||t.metodoPago===cardName||t.tarjetaDestino===cardName);
            const txCount=relatedTransactions.length;
            const confirmMsg=txCount?
                `Esta tarjeta tiene ${txCount} transacción(es) asociada(s).\n`+
                `Se desvincularán y quedarán marcadas como tarjeta eliminada.\n`+
                `¿Deseas continuar con la eliminación?`:
                `Se eliminará la tarjeta "${cardName}".\nTransacciones afectadas: ${txCount}.\n¿Confirmar?`;
            if(!confirm(confirmMsg)){
                showToast('Eliminación cancelada.','warning');
                return;
            }
            try{
                const batch=db.batch();
                relatedTransactions.forEach(t=>{
                    const updateData={cardDeleted:true};
                    if(t.cardId===id)updateData.cardId='';
                    if(t.cardName===cardName)updateData.cardName='';
                    if(resolveCreditCardName(t)===cardName&&!t.cardName)updateData.cardName='';
                    if(t.metodoPago===cardName)updateData.metodoPago='';
                    if(t.tarjetaDestino===cardName)updateData.tarjetaDestino='';
                    batch.update(db.collection('transactions').doc(t.id),updateData);
                });
                batch.delete(db.collection('cards').doc(id));
                await batch.commit();
                await loadCards();
                openQuotaModal();
                showToast(`Tarjeta eliminada. Transacciones actualizadas: ${txCount}.`,'success');
            }catch(e){
                console.error(e);
                showToast('Error al borrar','error');
            }
        }
        function editCard(id,n,q,a,p){document.getElementById('cardNameInput').value=n;const i=document.getElementById('cardQuotaInput');i.value=q;formatCurrencyInput(i);const adjInput=document.getElementById('cardAvailableAdjustmentInput');adjInput.value=a||0;formatCurrencyInput(adjInput);document.getElementById('cardPaymentDayInput').value=p||'';document.getElementById('editCardId').value=id;document.getElementById('btnSaveCard').innerHTML='<i class="fas fa-save"></i>';}
        function switchView(id){document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));document.getElementById('view-'+id).classList.add('active');const f=document.getElementById('headerDateFilter');if(f)f.style.display=id==='dashboard'?'flex':'none';document.querySelectorAll('.sidebar .nav-item, .mobile-nav .mob-link').forEach(x=>x.classList.remove('active'));const s=document.querySelectorAll('.sidebar .nav-item');const m=document.querySelectorAll('.mobile-nav .mob-link');if(id==='dashboard'){s[0].classList.add('active');m[0].classList.add('active');}if(id==='transacciones'){s[1].classList.add('active');m[1].classList.add('active');}if(id==='estadisticas'){s[2].classList.add('active');}if(id==='historial'){s[3].classList.add('active');m[3].classList.add('active');}if(id==='objetivos'){s[4].classList.add('active');renderGoals();}if(id==='asistente'){s[5].classList.add('active');m[4].classList.add('active');}closeSidebar();}
        function goToAddTransaction(){switchView('transacciones');}

        handleTipoChange();

        // Variables del calendario
        let calendarioMesActual = new Date().getMonth();
        let calendarioAnoActual = new Date().getFullYear();
        let fechaSeleccionadaCalendario = null;

        // Inicializar calendario
        function initCalendarioPagoCuota() {
            renderizarCalendario();
        }

        // Renderizar el calendario
        function renderizarCalendario() {
            const container = document.getElementById('calendarDays');
            const monthYearDisplay = document.getElementById('calendarMonthYear');
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            monthYearDisplay.textContent = `${meses[calendarioMesActual]} ${calendarioAnoActual}`;
            
            const primerDia = new Date(calendarioAnoActual, calendarioMesActual, 1).getDay();
            const diasEnMes = new Date(calendarioAnoActual, calendarioMesActual + 1, 0).getDate();
            const hoy = new Date();
            
            let html = '';
            
            // Días vacíos antes del primer día del mes
            for (let i = 0; i < primerDia; i++) {
                html += '<button class="calendar-day calendar-day-empty"></button>';
            }
            
            // Días del mes
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const fechaDia = new Date(calendarioAnoActual, calendarioMesActual, dia);
                const esHoy = fechaDia.getDate() === hoy.getDate() && 
                              fechaDia.getMonth() === hoy.getMonth() && 
                              fechaDia.getFullYear() === hoy.getFullYear();
                const esPasado = fechaDia < new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                
                let clases = 'calendar-day';
                if (esHoy) clases += ' calendar-day-today';
                if (esPasado) clases += ' calendar-day-disabled';
                if (fechaSeleccionadaCalendario && 
                    fechaSeleccionadaCalendario.getDate() === dia &&
                    fechaSeleccionadaCalendario.getMonth() === calendarioMesActual &&
                    fechaSeleccionadaCalendario.getFullYear() === calendarioAnoActual) {
                    clases += ' calendar-day-selected';
                }
                
                const disabledAttr = esPasado ? 'disabled' : '';
                const onclickAttr = esPasado ? '' : `onclick="seleccionarDiaCalendario(${dia})"`;
                
                html += `<button class="${clases}" ${disabledAttr} ${onclickAttr}>${dia}</button>`;
            }
            
            container.innerHTML = html;
        }

        // Cambiar mes
        function cambiarMesCalendario(direccion) {
            calendarioMesActual += direccion;
            if (calendarioMesActual < 0) {
                calendarioMesActual = 11;
                calendarioAnoActual--;
            } else if (calendarioMesActual > 11) {
                calendarioMesActual = 0;
                calendarioAnoActual++;
            }
            renderizarCalendario();
        }

        // Seleccionar día
        function seleccionarDiaCalendario(dia) {
            fechaSeleccionadaCalendario = new Date(calendarioAnoActual, calendarioMesActual, dia);
            renderizarCalendario();
        }

        // Formatear fecha
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const partes = dateStr.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
    </script>
</body>
</html>
