<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Financiero v3.2.1 - History Fix</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --primary-light: #818cf8; --secondary: #1e1b4b;
            --bg-body: #f3f4f6; --surface: #ffffff;
            --text-main: #1f2937; --text-light: #6b7280;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --credit: #ec4899;
            --ai-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            --radius: 16px; --nav-width: 260px; --header-height: 70px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        
        /* Layout */
        .sidebar { width: var(--nav-width); background: var(--surface); height: 100vh; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb; position: fixed; left: 0; top: 0; z-index: 50; }
        .main-wrapper { flex: 1; margin-left: var(--nav-width); height: 100vh; overflow-y: auto; position: relative; padding-bottom: 80px; }
        .content-container { padding: 24px; max-width: 1200px; margin: 0 auto; }
        
        /* Nav Items */
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-size: 1.25rem; font-weight: 800; color: var(--primary); border-bottom: 1px solid #f3f4f6; }
        .nav-links { flex: 1; padding: 20px 12px; display: flex; flex-direction: column; gap: 8px; }
        .nav-item { padding: 12px 16px; border-radius: 12px; color: var(--text-light); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover { background: #f9fafb; color: var(--primary); }
        .nav-item.active { background: #e0e7ff; color: var(--primary); font-weight: 600; }
        .nav-item.ai-nav { color: #0284c7; } .nav-item.ai-nav.active { background: #e0f2fe; color: #0369a1; }

        /* Header & Mobile */
        .top-header { height: var(--header-height); background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 40; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; border-bottom: 1px solid #e5e7eb; }
        .page-title { font-size: 1.2rem; font-weight: 700; }
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; height: 65px; border-top: 1px solid #eee; z-index: 90; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .mob-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.75rem; gap: 4px; background: none; border: none; }
        .mob-link.active { color: var(--primary); font-weight: 600; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(79,70,229,0.4); z-index: 100; border: none; cursor: pointer; }

        /* Components */
        .card { background: var(--surface); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .hero-balance { background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%); color: white; padding: 30px; border-radius: var(--radius); margin-bottom: 24px; position: relative; overflow: hidden; }
        .hero-amount { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .mini-stat { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid #f3f4f6; display: flex; flex-direction: column; justify-content: center; }
        .mini-value { font-size: 1.25rem; font-weight: 700; } .mini-stat.debt .mini-value { color: var(--danger); } .mini-stat.income .mini-value { color: var(--success); }

        /* AI & Forms */
        .ai-welcome-card { background: var(--ai-gradient); color: white; padding: 30px; border-radius: var(--radius); text-align: center; margin-bottom: 30px; }
        .btn-ai-action { background: white; color: #0369a1; padding: 15px 35px; border-radius: 30px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-flex; gap: 10px; align-items: center; }
        .ai-response-container { display: none; animation: slideUp 0.5s ease-out; }
        .ai-loading { display: none; flex-direction: column; align-items: center; padding: 40px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        input, select { padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem; background: #f9fafb; outline: none; }
        .btn-primary { background: var(--primary); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600; width: 100%; border: none; cursor: pointer; }
        .btn-cancel { background: #e5e7eb; color: var(--text-main); padding: 12px 24px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }

        /* History Specifics */
        .date-nav-container { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .nav-btn { width: 40px; height: 40px; border-radius: 50%; background: white; border: 1px solid #d1d5db; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .current-date-display { text-align: center; flex: 1; }
        .day-summary { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; }
        .summary-pill { background: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; border: 1px solid #eee; display: flex; gap: 8px; }
        .history-filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 16px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #eee; }
        td { padding: 16px; border-bottom: 1px solid #f3f4f6; }
        .btn-icon-action { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 5px; }

        /* Utilities */
        .hidden { display: none !important; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .text-success { color: var(--success); font-weight: 600; } .text-danger { color: var(--danger); font-weight: 600; } .text-credit { color: var(--credit); font-weight: 600; }
        
        .modal-overlay { z-index: 2000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; z-index: 3000; }
        .toast.success { background: var(--success); } .toast.error { background: var(--danger); }
        .quota-card { border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        
        @media (max-width: 768px) { .sidebar { display: none; } .mobile-nav { display: flex; } .main-wrapper { margin-left: 0; padding-bottom: 90px; } .fab { bottom: 85px; right: 20px; } .content-container { padding: 16px; } .history-filters { flex-direction: column; } }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand"><i class="fas fa-wallet"></i> CRM <span>Expert</span></div>
        <div class="nav-links">
            <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="switchView('transacciones', this)"><i class="fas fa-exchange-alt"></i> Transacciones</div>
            <div class="nav-item" onclick="switchView('estadisticas', this)"><i class="fas fa-chart-pie"></i> EstadÃ­sticas</div>
            <div class="nav-item" onclick="switchView('historial', this)"><i class="fas fa-list"></i> Historial</div>
            <div class="nav-item ai-nav" onclick="switchView('asistente', this)"><i class="fas fa-brain"></i> Asesor Experto</div>
        </div>
    </nav>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
        <button class="mob-link active" onclick="switchView('dashboard', this)"><i class="fas fa-home"></i> <span>Inicio</span></button>
        <button class="mob-link" onclick="switchView('transacciones', this)"><i class="fas fa-exchange-alt"></i> <span>Trans.</span></button>
        <button class="mob-link ai-mob" onclick="switchView('asistente', this)"><i class="fas fa-brain"></i> <span>Expert</span></button>
        <button class="mob-link" onclick="switchView('historial', this)"><i class="fas fa-list"></i> <span>Hist.</span></button>
    </nav>

    <button class="fab" onclick="goToAddTransaction()"><i class="fas fa-plus"></i></button>

    <div class="main-wrapper">
        <header class="top-header">
            <div class="page-title" id="pageTitle">Resumen Financiero</div>
            <div class="date-filter-pill" id="headerDateFilter">
                <i class="far fa-calendar-alt" style="color: var(--primary);"></i>
                <input type="month" id="dashboardMonth" onchange="updateDashboardView()">
            </div>
        </header>

        <div class="content-container">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="tab-content active">
                <div class="hero-balance">
                    <div class="hero-title">Patrimonio LÃ­quido Total</div><div class="hero-amount" id="saldoTotal">$ 0</div>
                </div>
                <div class="stats-grid">
                    <div class="mini-stat"><div class="mini-label">DÃ©bito</div><div class="mini-value" id="saldoDebito">$0</div></div>
                    <div class="mini-stat"><div class="mini-label">Efectivo</div><div class="mini-value" id="saldoEfectivo">$0</div></div>
                    <div class="mini-stat"><div class="mini-label">Nequi</div><div class="mini-value" id="saldoNequi">$0</div></div>
                </div>
                <div class="stats-grid">
                    <div class="mini-stat income"><div class="mini-label">Ingresos</div><div class="mini-value" id="totalIngresosMes">$0</div></div>
                    <div class="mini-stat debt"><div class="mini-label">Gastos</div><div class="mini-value" id="totalGastosMes">$0</div></div>
                    <div class="mini-stat"><div class="mini-label">Balance</div><div class="mini-value" id="balanceMes">$0</div></div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3>Deudas TC</h3><button onclick="openQuotaModal()" style="background:#f3f4f6; border:none; padding:8px; border-radius:8px; cursor:pointer;">Gestionar</button>
                    </div>
                    <div class="hero-amount" id="deudaTotalTC" style="color:var(--danger); font-size:1.8rem;">$0</div>
                    <div id="cardsBreakdown"></div>
                </div>
            </div>

            <!-- ASISTENTE -->
            <div id="view-asistente" class="tab-content">
                <div class="ai-welcome-card">
                    <h2>Asesor Experto</h2><p>AnÃ¡lisis local, privado y gratuito.</p>
                    <button class="btn-ai-action" onclick="generateLocalAnalysis()"><i class="fas fa-calculator"></i> DiagnÃ³stico</button>
                </div>
                <div id="aiLoading" class="ai-loading">Analizando...</div>
                <div id="aiResultContainer" class="ai-response-container">
                    <div class="card"><div id="aiContentBody"></div></div>
                </div>
            </div>

            <!-- TRANSACCIONES -->
            <div id="view-transacciones" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom:20px;" id="formTitle">Nueva TransacciÃ³n</h2>
                    <form id="transactionForm">
                        <input type="hidden" id="editingId" value="">
                        <div class="form-grid">
                            <div class="form-group full-width"><label>Tipo</label><select id="tipo" required onchange="handleTipoChange()"><option value="gasto">ðŸ’¸ Gasto</option><option value="ingreso">ðŸ’° Ingreso</option><option value="credito">ðŸ’³ CrÃ©dito</option><option value="pago_tarjeta">ðŸ“‰ Abono TC</option><option value="transferencia">ðŸ”„ Transferencia</option></select></div>
                            <div id="creditConfig" class="form-group full-width hidden" style="background:#fff1f2; padding:10px; border-radius:8px;"><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><div class="form-group"><label>Tarjeta</label><select id="tarjetaCredito"></select></div><div class="form-group"><label>Cuotas</label><input type="number" id="cuotas" value="1"></div></div></div>
                            <div id="divPagoTarjeta" class="form-group full-width hidden" style="background:#ecfdf5; padding:10px; border-radius:8px;"><div class="form-group"><label>Tarjeta a Pagar</label><select id="tarjetaDestinoPago"></select></div></div>
                            <div class="form-group" id="metodoPagoDiv"><label>MÃ©todo</label><select id="metodoPago"><option value="debito">DÃ©bito</option><option value="efectivo">Efectivo</option><option value="nequi">Nequi</option></select></div>
                            <div class="form-group hidden" id="metodoDestinoDiv"><label>Destino</label><select id="metodoDestino"><option value="debito">DÃ©bito</option><option value="efectivo">Efectivo</option><option value="nequi">Nequi</option></select></div>
                            <div class="form-group"><label>Monto</label><input type="text" id="monto" required oninput="formatCurrencyInput(this)"></div>
                            <div class="form-group"><label>CategorÃ­a</label><select id="categoria" required></select></div>
                            <div class="form-group hidden" id="subcategoriaDiv"><label>SubcategorÃ­a</label><select id="subcategoria"></select></div>
                            <div class="form-group"><label>Responsable</label><select id="miembro"><option value="papa">PapÃ¡</option><option value="mama">MamÃ¡</option><option value="hijo1">Hijo/a 1</option><option value="compartido">Compartido</option></select></div>
                            <div class="form-group full-width"><label>DescripciÃ³n</label><input type="text" id="descripcion" required></div>
                            <div class="form-group"><label>Fecha</label><input type="date" id="fecha" required></div>
                        </div>
                        <div style="margin-top:20px; display:flex; gap:10px;">
                            <button type="button" onclick="preSubmit()" class="btn-primary" id="btnSubmitText">Guardar</button>
                            <button type="button" id="btnCancelar" class="btn-cancel hidden" onclick="cancelEdit()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ESTADISTICAS -->
            <div id="view-estadisticas" class="tab-content">
                <div class="card"><h3>Tendencia (6 Meses)</h3><div style="height:300px;"><canvas id="chartTendencias"></canvas></div></div>
                <div class="card"><h3>DistribuciÃ³n</h3><div style="height:350px;"><canvas id="chartCategorias"></canvas></div></div>
            </div>

            <!-- HISTORIAL (MODIFIED TABLE) -->
            <div id="view-historial" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom:15px; text-align:center;">Agenda Financiera</h3>
                    <div class="date-nav-container">
                        <button class="nav-btn" onclick="changeDay(-1)"><i class="fas fa-chevron-left"></i></button>
                        <div class="current-date-display" onclick="document.getElementById('historyDatePicker').showPicker()">
                            <div class="date-label" id="lblHistoryDate">Hoy</div>
                            <input type="date" id="historyDatePicker" onchange="setHistoryDate(this.value)" style="position:absolute; opacity:0; width:1px;">
                        </div>
                        <button class="nav-btn" onclick="changeDay(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="day-summary">
                        <div class="summary-pill inc"><i class="fas fa-arrow-down"></i><span id="valDailyInc">$0</span></div>
                        <div class="summary-pill exp"><i class="fas fa-arrow-up"></i><span id="valDailyExp">$0</span></div>
                    </div>
                    <div class="history-filters">
                        <input type="text" id="historySearch" class="filter-input search-box" placeholder="Buscar..." oninput="renderHistory()">
                        <select id="historyType" class="filter-input" style="flex:1;" onchange="renderHistory()"><option value="all">Todo</option><option value="gasto">Gastos</option><option value="ingreso">Ingresos</option><option value="credito">CrÃ©dito</option></select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>MÃ©todo</th> <!-- NEW COLUMN -->
                                    <th>Cat.</th>
                                    <th>Desc.</th>
                                    <th>Monto</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="transactionList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="creditModal" style="display:none;"><div class="modal-content"><h3>Confirmar</h3><div class="modal-details"><div class="modal-row"><span>Tarjeta:</span><strong id="modalTarjeta">-</strong></div><div class="modal-row"><span>Cuotas:</span><span id="modalCuotas">0</span></div><div class="modal-row total"><span>Total:</span><span id="modalTotalDeuda">$0</span></div></div><div class="modal-actions"><button class="btn-cancel" onclick="closeModal('creditModal')">Volver</button><button class="btn-confirm" onclick="confirmSaveTransaction()">Confirmar</button></div></div></div>
    <div class="modal-overlay" id="quotaModal" style="display:none;"><div class="modal-content"><div style="display:flex;justify-content:space-between;"><h3>Tarjetas</h3><button onclick="closeModal('quotaModal')" style="background:none;font-size:1.5rem;">&times;</button></div><div class="add-card-form"><div class="form-group"><label>Nombre</label><input type="text" id="cardNameInput"></div><div class="form-group"><label>Cupo</label><input type="text" id="cardQuotaInput" oninput="formatCurrencyInput(this)"></div><button class="btn-primary" onclick="saveCard()" id="btnSaveCard"><i class="fas fa-plus"></i></button><input type="hidden" id="editCardId"></div><div id="quotaListContainer"></div></div></div>
    <div id="toastContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAP8f9ldzgyKAg74Da2yYL9u_urRLtf8nY", authDomain: "crm-financiero.firebaseapp.com", projectId: "crm-financiero", storageBucket: "crm-financiero.firebasestorage.app", messagingSenderId: "442754442943", appId: "1:442754442943:web:914d5a8ef619d77407880a", measurementId: "G-5EBSSNG8P9" };
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let transactions=[], cardsList=[], editingTransactionId=null, chartInstance=null, trendChartInstance=null, tempTransactionData=null, globalDeudaPorTarjeta={}, currentViewDate=new Date(), currentHistoryDate=new Date();
        const categories={ gasto: { 'vivienda':{icon:'ðŸ ',subcategorias:['Arriendo','Cuota hipoteca','AdministraciÃ³n','Impuesto','Reparaciones']}, 'servicios_publicos':{icon:'ðŸ’¡',subcategorias:['EnergÃ­a','Agua','Gas','Internet','Celular','Streaming']}, 'alimentacion':{icon:'ðŸ”',subcategorias:['Mercado','Carnes','Frutas','Tienda','Domicilios']}, 'transporte':{icon:'ðŸš—',subcategorias:['Transporte pÃºblico','Gasolina','SOAT','Mantenimiento','Parqueadero','Peajes','Uber']}, 'educacion':{icon:'ðŸ“š',subcategorias:['PensiÃ³n','Universidad','Ãštiles','Uniformes','Transporte']}, 'salud':{icon:'âš•ï¸',subcategorias:['Prepagada','Consultas','Medicamentos','OdontologÃ­a']}, 'vestuario':{icon:'ðŸ‘•',subcategorias:['Ropa','Calzado']}, 'cuidado_personal':{icon:'ðŸ’„',subcategorias:['PeluquerÃ­a','Aseo','CosmÃ©ticos','Gym']}, 'entretenimiento':{icon:'ðŸŽ¬',subcategorias:['Restaurantes','Cine','Paseos','Eventos']}, 'deudas':{icon:'ðŸ’³',subcategorias:['PrÃ©stamos','Gota a gota']}, 'seguros':{icon:'ðŸ›¡ï¸',subcategorias:['Vida','Hogar','VehÃ­culo']}, 'otros':{icon:'ðŸ“¦',subcategorias:['Mascotas','Regalos','Imprevistos']} }, ingreso: { 'salario':{icon:'ðŸ’¼',subcategorias:['Principal','Extras','Prima']}, 'negocio':{icon:'ðŸª',subcategorias:['Ventas','Servicios']}, 'inversiones':{icon:'ðŸ“ˆ',subcategorias:['Dividendos','Intereses']}, 'otros':{icon:'ðŸ’°',subcategorias:['Subsidios','PensiÃ³n','Regalos']} } }; const categorias=categories;

        document.addEventListener('DOMContentLoaded', () => { const t=new Date(); document.getElementById('dashboardMonth').value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`; document.getElementById('fecha').valueAsDate=t; updateHistoryHeader(); document.getElementById('creditModal').style.display='none'; document.getElementById('quotaModal').style.display='none'; loadCards(); });

        // --- UTILS ---
        function formatMoney(n){return '$ '+parseFloat(n).toLocaleString('es-CO',{maximumFractionDigits:0});}
        function formatCurrencyInput(i){let v=i.value.replace(/\D/g,"");if(v===""){i.value="";return;}i.value="$ "+new Intl.NumberFormat('es-CO').format(v);}
        function parseCurrencyInput(v){return v?parseFloat(v.replace(/\D/g,'')):0;}
        function showToast(m,t){const c=document.getElementById('toastContainer');const d=document.createElement('div');d.className=`toast ${t}`;d.textContent=m;c.appendChild(d);setTimeout(()=>d.remove(),4000);}

        // --- HISTORY LOGIC (FIXED) ---
        function renderHistory() {
            const tbody = document.getElementById('transactionList'); tbody.innerHTML = '';
            const filterDateStr = `${currentHistoryDate.getFullYear()}-${String(currentHistoryDate.getMonth()+1).padStart(2,'0')}-${String(currentHistoryDate.getDate()).padStart(2,'0')}`;
            const searchText = document.getElementById('historySearch').value.toLowerCase();
            const filterType = document.getElementById('historyType').value;
            let dayInc=0, dayExp=0;

            const filtered = transactions.filter(t => {
                const isSameDay = t.fecha === filterDateStr;
                const textMatch = t.descripcion.toLowerCase().includes(searchText);
                const typeMatch = filterType === 'all' || t.tipo === filterType;
                if(isSameDay){ const m=parseFloat(t.monto); if(t.tipo==='ingreso') dayInc+=m; else if(t.tipo==='gasto'||t.tipo==='credito') dayExp+=m; }
                return isSameDay && textMatch && typeMatch;
            });

            document.getElementById('valDailyInc').textContent = formatMoney(dayInc);
            document.getElementById('valDailyExp').textContent = formatMoney(dayExp);

            if(filtered.length===0){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:#999;">Sin movimientos</td></tr>'; return; }

            filtered.forEach(t => {
                let color = t.tipo==='ingreso'?'text-success':(t.tipo==='pago_tarjeta'?'text-credit':'text-danger');
                let symbol = t.tipo==='ingreso'?'+':'-'; if(t.tipo==='transferencia'){color='text-main';symbol='';}
                
                // --- FIX: METHOD COLUMN LOGIC ---
                let methodInfo = t.metodoPago;
                if(t.tipo === 'credito') methodInfo = `${t.metodoPago} (${t.cuotas}x)`;
                else if(t.tipo === 'pago_tarjeta') methodInfo = `${t.metodoPago} âž” ${t.tarjetaDestino}`;
                else if(t.tipo === 'transferencia') methodInfo = `${t.metodoPago} âž” ${t.metodoDestino}`;
                // --------------------------------

                tbody.innerHTML += `
                    <tr>
                        <td style="text-transform:capitalize;font-size:0.85rem;">${t.tipo.replace('_',' ')}</td>
                        <td style="font-size:0.85rem; color:#4b5563;">${methodInfo}</td> <!-- NEW CELL -->
                        <td>${t.categoria||'-'}</td>
                        <td>${t.descripcion}</td>
                        <td class="${color}" style="font-weight:bold;">${symbol} ${formatMoney(t.monto)}</td>
                        <td style="text-align:right;">
                            <button onclick="editTransaction('${t.id}')" class="btn-icon-action" style="color:var(--info);"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTransaction('${t.id}')" class="btn-icon-action" style="color:var(--danger);"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function changeDay(o){currentHistoryDate.setDate(currentHistoryDate.getDate()+o); updateHistoryHeader(); renderHistory();}
        function setHistoryDate(d){const[y,m,dd]=d.split('-').map(Number); currentHistoryDate=new Date(y,m-1,dd); updateHistoryHeader(); renderHistory();}
        function updateHistoryHeader(){const s=currentHistoryDate.toLocaleDateString('es-CO',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); document.getElementById('lblHistoryDate').textContent=(new Date().toDateString()===currentHistoryDate.toDateString())?"Hoy":s; document.getElementById('historyDatePicker').value=`${currentHistoryDate.getFullYear()}-${String(currentHistoryDate.getMonth()+1).padStart(2,'0')}-${String(currentHistoryDate.getDate()).padStart(2,'0')}`; }

        // --- OTHER LOGIC (UNCHANGED) ---
        async function loadCards(){try{const s=await db.collection('cards').orderBy('name').get(); cardsList=[]; s.forEach(d=>cardsList.push({id:d.id,...d.data()})); if(cardsList.length===0){await seedDefaultCards();return;} populateCardSelects(); loadTransactions();}catch(e){console.error(e);}}
        async function seedDefaultCards(){const d=['Exito','Nu','Falabella']; const b=db.batch(); d.forEach(n=>b.set(db.collection('cards').doc(),{name:n,quota:0})); await b.commit(); loadCards();}
        function populateCardSelects(){const s1=document.getElementById('tarjetaCredito'); const s2=document.getElementById('tarjetaDestinoPago'); s1.innerHTML=''; s2.innerHTML=''; cardsList.forEach(c=>{s1.add(new Option(c.name,c.name));s2.add(new Option(c.name,c.name));});}
        async function loadTransactions(){const s=await db.collection('transactions').orderBy('fecha','desc').get(); transactions=[]; s.forEach(d=>transactions.push({id:d.id,...d.data()})); updateDashboard(); renderHistory(); renderCharts(); renderTrendChart();}
        
        // ... (Rest of standard functions: updateDashboard, renderCharts, handleTipoChange, preSubmit, etc. maintained exactly as v3.2) ...
        // Shortened for brevity but logically identical to v3.2 provided previously
        function updateDashboard(){let d=0,e=0,n=0,i=0,g=0; let dm={}; cardsList.forEach(c=>dm[c.name]=0); const vm=currentViewDate.getMonth(); const vy=currentViewDate.getFullYear();
        transactions.forEach(t=>{const m=parseFloat(t.monto); const[ty,tm]=t.fecha.split('-').map(Number); const iv=(tm-1)===vm&&ty===vy;
        if(t.tipo==='pago_tarjeta'){if(t.metodoPago==='debito')d-=m;if(t.metodoPago==='efectivo')e-=m;if(t.metodoPago==='nequi')n-=m;if(dm[t.tarjetaDestino]!==undefined)dm[t.tarjetaDestino]-=m;}
        else if(!t.esCredito){if(t.tipo==='ingreso'){if(t.metodoPago==='debito')d+=m;if(t.metodoPago==='efectivo')e+=m;if(t.metodoPago==='nequi')n+=m;if(iv)i+=m;}else if(t.tipo==='gasto'){if(t.metodoPago==='debito')d-=m;if(t.metodoPago==='efectivo')e-=m;if(t.metodoPago==='nequi')n-=m;if(iv)g+=m;}else if(t.tipo==='transferencia'){if(t.metodoPago==='debito')d-=m;if(t.metodoPago==='efectivo')e-=m;if(t.metodoPago==='nequi')n-=m;if(t.metodoDestino==='debito')d+=m;if(t.metodoDestino==='efectivo')e+=m;if(t.metodoDestino==='nequi')n+=m;}}else{const c=t.metodoPago;if(dm[c]!==undefined)dm[c]+=(t.totalDeuda||m);if(iv)g+=m;}});
        globalDeudaPorTarjeta=dm; document.getElementById('saldoDebito').textContent=formatMoney(d); document.getElementById('saldoEfectivo').textContent=formatMoney(e); document.getElementById('saldoNequi').textContent=formatMoney(n); document.getElementById('saldoTotal').textContent=formatMoney(d+e+n); document.getElementById('totalIngresosMes').textContent=formatMoney(i); document.getElementById('totalGastosMes').textContent=formatMoney(g); document.getElementById('balanceMes').textContent=formatMoney(i-g);
        const dv=document.getElementById('cardsBreakdown'); dv.innerHTML=''; let td=0; Object.keys(dm).forEach(k=>{if(dm[k]!==0){td+=dm[k];dv.innerHTML+=`<div class="card-status-item"><span class="card-name">${k}</span><span class="card-debt">${formatMoney(dm[k])}</span></div>`;}}); document.getElementById('deudaTotalTC').textContent=formatMoney(td);}
        function updateDashboardView(){const v=document.getElementById('dashboardMonth').value; if(v){const[y,m]=v.split('-'); currentViewDate=new Date(parseInt(y),parseInt(m)-1,1); updateDashboard(); renderCharts();}}
        function renderTrendChart(){const c=document.getElementById('chartTendencias'); if(trendChartInstance)trendChartInstance.destroy(); const l=[],i=[],g=[],t=new Date(),b={}; for(let x=5;x>=0;x--){const d=new Date(t.getFullYear(),t.getMonth()-x,1);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;b[k]={i:0,g:0};l.push(d.toLocaleString('es-CO',{month:'short'}));} transactions.forEach(tx=>{const k=tx.fecha.substring(0,7);if(b[k]){if(tx.tipo==='ingreso')b[k].i+=parseFloat(tx.monto);else if(tx.tipo==='gasto'||tx.tipo==='credito')b[k].g+=parseFloat(tx.monto);}}); Object.keys(b).sort().forEach(k=>{i.push(b[k].i);g.push(b[k].g);}); trendChartInstance=new Chart(c,{type:'line',data:{labels:l,datasets:[{label:'Ing',data:i,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',fill:true},{label:'Gas',data:g,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}});}
        function renderCharts(){const c=document.getElementById('chartCategorias'); if(chartInstance)chartInstance.destroy(); const ct={},vm=currentViewDate.getMonth(),vy=currentViewDate.getFullYear(); transactions.filter(t=>(t.tipo==='gasto'||t.tipo==='credito')).forEach(t=>{const[ty,tm]=t.fecha.split('-').map(Number);if((tm-1)===vm&&ty===vy){const n=t.categoria||'Otros';ct[n]=(ct[n]||0)+parseFloat(t.monto);}}); chartInstance=new Chart(c,{type:'doughnut',data:{labels:Object.keys(ct),datasets:[{data:Object.values(ct),backgroundColor:['#6366f1','#ec4899','#10b981','#f59e0b','#3b82f6','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}});}
        
        // Form & AI
        function handleTipoChange(){const t=document.getElementById('tipo').value; const cc=document.getElementById('creditConfig'); const pc=document.getElementById('divPagoTarjeta'); const mp=document.getElementById('metodoPagoDiv'); const md=document.getElementById('metodoDestinoDiv'); const cat=document.getElementById('categoria'); cc.classList.add('hidden'); pc.classList.add('hidden'); mp.classList.remove('hidden'); md.classList.add('hidden'); if(t==='credito'){cc.classList.remove('hidden');mp.classList.add('hidden');}else if(t==='pago_tarjeta'){pc.classList.remove('hidden');}else if(t==='transferencia'){md.classList.remove('hidden');} cat.innerHTML='<option value="">Seleccione...</option>'; document.getElementById('subcategoriaDiv').classList.add('hidden'); if(t==='pago_tarjeta')cat.add(new Option('Abono Tarjeta','pago_tc')); else if(t==='transferencia')cat.add(new Option('Transferencia','transferencia')); else{const g=t==='credito'?'gasto':t;if(categorias[g]){Object.keys(categorias[g]).forEach(k=>{cat.add(new Option(categorias[g][k].icon+' '+k.toUpperCase().replace(/_/g,' '),k));});}}}
        document.getElementById('categoria').addEventListener('change',function(){const t=document.getElementById('tipo').value;if(t==='pago_tarjeta'||t==='transferencia')return;const k=this.value;const s=document.getElementById('subcategoria');const d=document.getElementById('subcategoriaDiv');const g=t==='credito'?'gasto':t;if(k&&categorias[g][k]){d.classList.remove('hidden');s.innerHTML='';categorias[g][k].subcategorias.forEach(x=>s.add(new Option(x,x)));}else d.classList.add('hidden');});
        function preSubmit(){const t=document.getElementById('tipo').value; const m=parseCurrencyInput(document.getElementById('monto').value); if(m<=0){alert('Monto invÃ¡lido');return;} const d={tipo:t,monto:m,categoria:document.getElementById('categoria').value,subcategoria:document.getElementById('subcategoria').value||'',miembro:document.getElementById('miembro').value,descripcion:document.getElementById('descripcion').value,fecha:document.getElementById('fecha').value,timestamp:firebase.firestore.FieldValue.serverTimestamp()}; if(t==='credito'){const tc=document.getElementById('tarjetaCredito').value;const c=parseInt(document.getElementById('cuotas').value);d.metodoPago=tc;d.esCredito=true;d.cuotas=c;d.totalDeuda=m;tempTransactionData=d;document.getElementById('modalTarjeta').textContent=tc;document.getElementById('modalCuotas').textContent=c;document.getElementById('modalTotalDeuda').textContent=formatMoney(m);document.getElementById('creditModal').style.display='flex';}else{if(t==='pago_tarjeta'){d.metodoPago=document.getElementById('metodoPago').value;d.tarjetaDestino=document.getElementById('tarjetaDestinoPago').value;}else{d.metodoPago=document.getElementById('metodoPago').value;if(t==='transferencia')d.metodoDestino=document.getElementById('metodoDestino').value;}saveTransaction(d);}}
        function confirmSaveTransaction(){if(tempTransactionData)saveTransaction(tempTransactionData);closeModal('creditModal');}
        async function saveTransaction(d){try{if(editingTransactionId)await db.collection('transactions').doc(editingTransactionId).update(d);else await db.collection('transactions').add(d); cancelEdit(); loadTransactions(); showToast(editingTransactionId?'Actualizado':'Guardado','success');}catch(e){alert(e.message);}}
        function cancelEdit(){editingTransactionId=null; document.getElementById('transactionForm').reset(); document.getElementById('formTitle').textContent='Nueva TransacciÃ³n'; document.getElementById('btnCancelar').classList.add('hidden'); document.getElementById('btnSubmitText').textContent='Guardar'; handleTipoChange();}
        window.editTransaction=function(id){const t=transactions.find(x=>x.id===id);if(!t)return;editingTransactionId=id;switchView('transacciones');document.getElementById('tipo').value=t.tipo;handleTipoChange();const m=document.getElementById('monto');m.value=t.monto;formatCurrencyInput(m);document.getElementById('descripcion').value=t.descripcion;document.getElementById('fecha').value=t.fecha;document.getElementById('miembro').value=t.miembro;if(t.tipo==='credito'){document.getElementById('tarjetaCredito').value=t.metodoPago;document.getElementById('cuotas').value=t.cuotas;}else if(t.tipo==='pago_tarjeta'){document.getElementById('metodoPago').value=t.metodoPago;document.getElementById('tarjetaDestinoPago').value=t.tarjetaDestino;}else{document.getElementById('metodoPago').value=t.metodoPago;if(t.tipo==='transferencia')document.getElementById('metodoDestino').value=t.metodoDestino;}document.getElementById('formTitle').textContent='Editar';document.getElementById('btnSubmitText').textContent='Actualizar';document.getElementById('btnCancelar').classList.remove('hidden');setTimeout(()=>{document.getElementById('categoria').value=t.categoria;const e=new Event('change');document.getElementById('categoria').dispatchEvent(e);setTimeout(()=>{if(t.subcategoria)document.getElementById('subcategoria').value=t.subcategoria;},50);},100);}
        window.deleteTransaction=async function(id){if(confirm("Borrar?")){await db.collection('transactions').doc(id).delete();loadTransactions();showToast('Borrado','success');}}
        function openQuotaModal(){const d=document.getElementById('quotaListContainer');d.innerHTML='';cardsList.forEach(c=>{const db=globalDeudaPorTarjeta[c.name]||0;const av=(c.quota||0)-db;d.innerHTML+=`<div class="quota-card"><div class="quota-header"><span>${c.name}</span><div><button onclick="editCard('${c.id}','${c.name}','${c.quota}')" class="btn-icon-action" style="color:var(--info);"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteCard('${c.id}')" class="btn-icon-action" style="color:var(--danger);"><i class="fas fa-trash"></i></button></div></div><div class="quota-details"><span>Cupo:${formatMoney(c.quota)}</span><span class="text-danger">Deuda:${formatMoney(db)}</span></div></div>`;});document.getElementById('cardNameInput').value='';document.getElementById('cardQuotaInput').value='';document.getElementById('editCardId').value='';document.getElementById('btnSaveCard').innerHTML='<i class="fas fa-plus"></i>';document.getElementById('quotaModal').style.display='flex';}
        function closeModal(id){document.getElementById(id).style.display='none';}
        async function saveCard(){const n=document.getElementById('cardNameInput').value.trim();const q=parseCurrencyInput(document.getElementById('cardQuotaInput').value);const i=document.getElementById('editCardId').value;if(!n)return;try{if(i)await db.collection('cards').doc(i).update({name:n,quota:q});else await db.collection('cards').add({name:n,quota:q});loadCards();setTimeout(openQuotaModal,500);}catch(e){console.error(e);}}
        async function deleteCard(id){if(!confirm("Borrar?"))return;await db.collection('cards').doc(id).delete();loadCards();setTimeout(openQuotaModal,500);}
        function editCard(id,n,q){document.getElementById('cardNameInput').value=n;const i=document.getElementById('cardQuotaInput');i.value=q;formatCurrencyInput(i);document.getElementById('editCardId').value=id;document.getElementById('btnSaveCard').innerHTML='<i class="fas fa-save"></i>';}
        
        function generateLocalAnalysis(){const l=document.getElementById('aiLoading');const r=document.getElementById('aiResultContainer');const b=document.querySelector('.btn-ai-action');b.disabled=true;l.style.display='flex';r.style.display='none';setTimeout(()=>{const d=prepareFinancialContext();let hS="",hC="",hM="";if(d.cashFlow>(d.income*0.15)){hS="SALUDABLE";hC="good";hM="Ahorro posible.";}else if(d.cashFlow>=0){hS="ALERTA";hC="warn";hM="Al lÃ­mite.";}else{hS="CRÃTICO";hC="bad";hM="DÃ©ficit.";}let dA="";if(d.totalDebt===0)dA="Sin deuda.";else{dA=`Deuda: **${formatMoney(d.totalDebt)}** (${Math.round((d.totalDebt/d.income)*100)}% ingreso).`;}let aH="";if(d.topExpenses.length>0)aH+=`<li>Mayor gasto: <strong>${d.topExpenses[0].category}</strong> (${formatMoney(d.topExpenses[0].amount)})</li>`;const h=`<div class="report-section"><div class="report-title"><i class="fas fa-heartbeat" style="color:#ef4444"></i> Salud: <span class="tag ${hC}">${hS}</span></div><p class="report-text">${hM}</p></div><div class="report-section"><div class="report-title"><i class="fas fa-chart-pie" style="color:#3b82f6"></i> Flujo</div><ul class="report-text" style="list-style:none;padding:0;"><li>Ingresos: ${formatMoney(d.income)}</li><li>Gastos: ${formatMoney(d.expenses)}</li><li>Balance: <strong>${formatMoney(d.cashFlow)}</strong></li></ul></div><div class="report-section"><div class="report-title"><i class="fas fa-shield-alt" style="color:#eab308"></i> Deuda</div><p class="report-text">${dA}</p></div><div class="report-section"><div class="report-title"><i class="fas fa-lightbulb" style="color:#8b5cf6"></i> Tips</div><ul class="report-text" style="padding-left:20px;">${aH}</ul></div>`;document.getElementById('aiContentBody').innerHTML=h;l.style.display='none';r.style.display='block';b.disabled=false;},1000);}
        function prepareFinancialContext(){let i=0,e=0,dt={...globalDeudaPorTarjeta},td=0;const t=new Date();const p=new Date();p.setDate(t.getDate()-30);const rt=transactions.filter(x=>new Date(x.fecha)>=p);rt.forEach(x=>{const m=parseFloat(x.monto);if(x.tipo==='ingreso')i+=m;if(x.tipo==='gasto'||x.tipo==='credito')e+=m;});Object.values(dt).forEach(x=>td+=x);let cm={};rt.filter(x=>x.tipo==='gasto').forEach(x=>{cm[x.categoria]=(cm[x.categoria]||0)+parseFloat(x.monto);});const tc=Object.entries(cm).sort(([,a],[,b])=>b-a).slice(0,3).map(([k,v])=>({category:k,amount:v}));return{income:i,expenses:e,cashFlow:i-e,totalDebt:td,debtDetails:dt,topExpenses:tc};}
        function switchView(id){document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));document.getElementById('view-'+id).classList.add('active');const f=document.getElementById('headerDateFilter');if(f)f.style.display=id==='dashboard'?'flex':'none';document.querySelectorAll('.sidebar .nav-item, .mobile-nav .mob-link').forEach(x=>x.classList.remove('active'));const s=document.querySelectorAll('.sidebar .nav-item');const m=document.querySelectorAll('.mobile-nav .mob-link');if(id==='dashboard'){s[0].classList.add('active');m[0].classList.add('active');}if(id==='transacciones'){s[1].classList.add('active');m[1].classList.add('active');}if(id==='estadisticas'){s[2].classList.add('active');}if(id==='historial'){s[3].classList.add('active');m[3].classList.add('active');}if(id==='asistente'){s[4].classList.add('active');m[2].classList.add('active');}}
        function goToAddTransaction(){switchView('transacciones');}

        handleTipoChange();
    </script>
</body>
</html>