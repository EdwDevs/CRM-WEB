<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Financiero Familiar v2.5 - Business Intelligence</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4ade80;
            --danger: #dc2626;
            --warning: #fbbf24;
            --info: #60a5fa;
            --credit: #e11d48;
            --payment: #059669;
            --light: #f8fafc;
            --dark: #1e293b;
            --text: #374151;
            --text-muted: #6b7280;
            --white: #ffffff;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
            min-height: 100vh;
            color: var(--text);
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease-out;
        }

        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { font-size: 2.5rem; color: var(--dark); text-align: center; margin-bottom: 10px; }
        h2 { font-size: 1.8rem; color: var(--dark); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        h3 { font-size: 1.3rem; color: var(--dark); margin: 20px 0 15px 0; display: flex; align-items: center; gap: 10px; }
        .subtitle { text-align: center; color: var(--text-muted); margin-bottom: 0; }

        /* Tabs */
        .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button {
            padding: 12px 25px; border: none; border-radius: var(--border-radius);
            font-size: 1rem; font-weight: 600; cursor: pointer;
            background: var(--white); color: var(--text); border: 1px solid var(--light);
            transition: var(--transition); display: flex; align-items: center; gap: 8px;
        }
        .tab-button.active { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .tab-button:hover { transform: translateY(-2px); border-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Stats & Grids */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;
        }

        .stat-card {
            background: var(--white); border-radius: var(--border-radius); padding: 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); color: var(--white);
            animation: fadeInUp 0.5s ease-out; border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .stat-card.debito { background: linear-gradient(135deg, #4ade80 0%, #16a34a 100%); }
        .stat-card.efectivo { background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); }
        .stat-card.nequi { background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%); }
        .stat-card.credito-total { background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%); }
        .stat-card.total { background: linear-gradient(135deg, #fbbf24 0%, #ea580c 100%); }

        .stat-info p:first-child { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .stat-info p:last-child { font-size: 1.8rem; font-weight: bold; }
        .stat-icon { font-size: 2.5rem; opacity: 0.5; }

        /* Cards Status Grid */
        .cards-status-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;
        }
        .card-status-item {
            background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid var(--credit);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card-name { font-weight: bold; color: var(--text); font-size: 0.9rem; }
        .card-debt { color: var(--credit); font-size: 1.2rem; font-weight: bold; margin-top: 5px; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        
        label { font-weight: 600; color: var(--text); margin-bottom: 8px; font-size: 0.9rem; }
        input, select, textarea {
            padding: 12px 15px; border: 2px solid var(--light); border-radius: var(--border-radius);
            font-size: 1rem; transition: var(--transition);
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* NEW: Date Filter Header */
        .header-controls {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;
        }
        .date-filter-container {
            display: flex; align-items: center; gap: 10px; background: var(--light); padding: 8px 15px; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .date-filter-container input { border: none; background: transparent; padding: 5px; outline: none; font-weight: bold; color: var(--primary); }

        .button-group { display: flex; gap: 10px; align-items: flex-end; }
        button {
            padding: 12px 25px; border: none; border-radius: var(--border-radius);
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition);
        }
        .btn-primary { background: var(--primary); color: var(--white); flex: 1; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-cancel { background: var(--text-muted); color: var(--white); display: none; }
        .btn-export { background: var(--success); color: var(--white); }
        .btn-edit { background: var(--info); color: var(--white); padding: 8px 15px; border-radius: 8px; margin-right: 5px; }
        .btn-delete { background: var(--danger); color: var(--white); padding: 8px 15px; border-radius: 8px; }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--light); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--light); }
        .tipo-ingreso { color: var(--success); font-weight: 600; }
        .tipo-gasto { color: var(--danger); font-weight: 600; }
        .tipo-transferencia { color: var(--info); font-weight: 600; }
        .tipo-credito { color: var(--credit); font-weight: 600; }
        .tipo-pago { color: var(--payment); font-weight: 600; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideUp 0.3s ease-out;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .modal-title { font-size: 1.5rem; font-weight: bold; color: var(--dark); }
        .modal-details { margin-bottom: 20px; background: var(--light); padding: 15px; border-radius: 8px; }
        .modal-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; }
        .modal-row.total { font-weight: bold; font-size: 1.1rem; color: var(--credit); border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm { background: var(--credit); color: white; flex: 1; }
        .btn-confirm:hover { background: #be123c; }

        /* Quota & Card Management Styles */
        .quota-card {
            border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            background: #fff; transition: all 0.2s; display: flex; flex-direction: column; gap: 10px;
        }
        .quota-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .quota-header { display: flex; justify-content: space-between; align-items: center; }
        .quota-name { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .quota-actions button {
            background: none; border: none; cursor: pointer; font-size: 1rem; padding: 5px; transition: color 0.2s;
        }
        .btn-icon-edit { color: var(--info); }
        .btn-icon-delete { color: var(--danger); }
        
        .progress-container { height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; width: 100%; }
        .progress-bar { height: 100%; transition: width 0.5s ease; border-radius: 6px; }
        .progress-bar.good { background: var(--success); }
        .progress-bar.warning { background: var(--warning); }
        .progress-bar.danger { background: var(--danger); }
        
        .quota-details { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); }
        .val-debt { color: var(--credit); font-weight: 600; }
        .val-avail { color: var(--success); font-weight: 600; }

        .add-card-form {
            background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px;
            display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .loading { display: flex; justify-content: center; padding: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; animation: slideUp 0.3s ease-out; z-index: 2000; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid, .form-grid { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
            .add-card-form { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <h1><i class="fas fa-wallet"></i> CRM Financiero V2.5</h1>
            <p class="subtitle">Inteligencia de Negocios y Control Total üöÄ</p>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs-container">
                <button class="tab-button active" onclick="switchTab('dashboard', this)">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="tab-button" onclick="switchTab('transacciones', this)">
                    <i class="fas fa-exchange-alt"></i> Transacciones
                </button>
                <button class="tab-button" onclick="switchTab('estadisticas', this)">
                    <i class="fas fa-chart-line"></i> Estad√≠sticas
                </button>
                <button class="tab-button" onclick="switchTab('historial', this)">
                    <i class="fas fa-history"></i> Historial
                </button>
            </div>
        </div>

        <!-- TAB: Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- NEW: Global Date Filter -->
            <div class="header-controls">
                <h3 style="margin: 0;">Saldos L√≠quidos</h3>
                <div class="date-filter-container">
                    <i class="fas fa-calendar-alt" style="color: var(--primary);"></i>
                    <label for="dashboardMonth" style="margin:0; font-size:0.9rem; cursor:pointer;">Mes Vista:</label>
                    <input type="month" id="dashboardMonth" onchange="updateDashboardView()">
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card debito">
                    <div class="stat-info"><p>D√©bito (Total)</p><p id="saldoDebito">$0</p></div>
                    <i class="fas fa-credit-card stat-icon"></i>
                </div>
                <div class="stat-card efectivo">
                    <div class="stat-info"><p>Efectivo (Total)</p><p id="saldoEfectivo">$0</p></div>
                    <i class="fas fa-money-bill-wave stat-icon"></i>
                </div>
                <div class="stat-card nequi">
                    <div class="stat-info"><p>Nequi (Total)</p><p id="saldoNequi">$0</p></div>
                    <i class="fas fa-mobile-alt stat-icon"></i>
                </div>
                <div class="stat-card total">
                    <div class="stat-info"><p>Total L√≠quido</p><p id="saldoTotal">$0</p></div>
                    <i class="fas fa-wallet stat-icon"></i>
                </div>
            </div>

            <!-- Secci√≥n de Deudas TC -->
            <div class="card" style="border-left: 5px solid var(--credit);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap;">
                    <h2><i class="fas fa-money-check-alt"></i> Estado de Tarjetas de Cr√©dito</h2>
                    <button class="btn-primary" style="padding: 8px 15px; font-size: 0.9rem; max-width: 250px;" onclick="openQuotaModal()">
                        <i class="fas fa-cog"></i> Gestionar Tarjetas y Cupos
                    </button>
                </div>
                <p class="subtitle" style="text-align: left;">Deuda acumulada actual (Compras - Abonos)</p>
                
                <div class="dashboard-grid" style="margin-bottom: 0;">
                    <div class="stat-card credito-total">
                        <div class="stat-info">
                            <p>Deuda Total Tarjetas</p>
                            <p id="deudaTotalTC">$0</p>
                        </div>
                        <i class="fas fa-file-invoice-dollar stat-icon"></i>
                    </div>
                </div>

                <div class="cards-status-grid" id="cardsBreakdown">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Resumen Mes (Afectado por Filtro) -->
            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> Resumen: <span id="lblPeriodoResumen">Mes Actual</span></h2>
                <div class="dashboard-grid">
                    <div class="stat-card" style="background: #fff; color: var(--text); border: 1px solid #eee;">
                        <div class="stat-info"><p>Total Ingresos</p><p id="totalIngresosMes" style="color: var(--success);">$0</p></div>
                    </div>
                    <div class="stat-card" style="background: #fff; color: var(--text); border: 1px solid #eee;">
                        <div class="stat-info"><p>Gastos + Compras TC</p><p id="totalGastosMes" style="color: var(--danger);">$0</p></div>
                    </div>
                    <div class="stat-card" style="background: #fff; color: var(--text); border: 1px solid #eee;">
                        <div class="stat-info"><p>Balance (Flujo)</p><p id="balanceMes" style="color: var(--primary);">$0</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Transacciones -->
        <div id="tab-transacciones" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> <span id="formTitle">Nueva Transacci√≥n</span></h2>
                <form id="transactionForm">
                    <input type="hidden" id="editingId" value="">

                    <div class="form-grid">
                        <!-- Tipo de Movimiento -->
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="tipo" required onchange="handleTipoChange()">
                                <option value="gasto">üí∏ Gasto (Salida inmediata)</option>
                                <option value="ingreso">üí∞ Ingreso</option>
                                <option value="credito">üí≥ Compra con Cr√©dito (Aumenta Deuda)</option>
                                <option value="pago_tarjeta">üìâ Abono / Pago Tarjeta (Disminuye Deuda)</option>
                                <option value="transferencia">üîÑ Transferencia</option>
                            </select>
                        </div>

                        <!-- 1. Configuraci√≥n Nueva Deuda (Solo Credito) -->
                        <div id="creditConfig" class="form-group hidden" style="grid-column: 1 / -1; background: #fff1f2; padding: 15px; border-radius: 8px; border: 1px solid #fecdd3; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label style="color: var(--credit);">Tarjeta a Usar</label>
                                <select id="tarjetaCredito">
                                    <!-- Se llena dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="color: var(--credit);">Cuotas</label>
                                <input type="number" id="cuotas" min="1" max="36" value="1" placeholder="N√∫mero de cuotas">
                                <small style="color: var(--text-muted); font-size: 0.75rem;">Si es Addi a 3 cuotas o menos = 0% inter√©s</small>
                            </div>
                        </div>

                        <!-- 2. Configuraci√≥n Pago de Tarjeta (Solo Pago) -->
                        <div id="divPagoTarjeta" class="form-group hidden" style="grid-column: 1 / -1; background: #ecfdf5; padding: 15px; border-radius: 8px; border: 1px solid #a7f3d0; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label style="color: var(--payment); font-weight:bold;">Tarjeta a Pagar (Disminuir deuda)</label>
                                <select id="tarjetaDestinoPago">
                                    <!-- Se llena dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group" style="justify-content:center;">
                                <p style="font-size: 0.8rem; color: #047857;">
                                    <i class="fas fa-info-circle"></i> Este valor se restar√° de la deuda acumulada de la tarjeta seleccionada y saldr√° de tus fondos l√≠quidos.
                                </p>
                            </div>
                        </div>

                        <!-- M√©todo Pago (Origen del dinero) -->
                        <div class="form-group" id="metodoPagoDiv">
                            <label id="lblMetodoPago">M√©todo de Pago</label>
                            <select id="metodoPago">
                                <option value="debito">üí≥ D√©bito</option>
                                <option value="efectivo">üíµ Efectivo</option>
                                <option value="nequi">üì± Nequi</option>
                            </select>
                        </div>

                        <!-- M√©todo Destino (Solo transferencia) -->
                        <div class="form-group hidden" id="metodoDestinoDiv">
                            <label>M√©todo Destino</label>
                            <select id="metodoDestino">
                                <option value="debito">üí≥ D√©bito</option>
                                <option value="efectivo">üíµ Efectivo</option>
                                <option value="nequi">üì± Nequi</option>
                            </select>
                        </div>

                        <!-- UX UPGRADE: Input text para mascara de moneda -->
                        <div class="form-group">
                            <label>Monto (COP)</label>
                            <input type="text" id="monto" placeholder="$ 0" required oninput="formatCurrencyInput(this)">
                        </div>

                        <div class="form-group">
                            <label>Categor√≠a</label>
                            <select id="categoria" required><option value="">Seleccione...</option></select>
                        </div>

                        <div class="form-group hidden" id="subcategoriaDiv">
                            <label>Subcategor√≠a</label>
                            <select id="subcategoria"><option value="">Seleccione...</option></select>
                        </div>

                        <div class="form-group">
                            <label>Miembro Familiar</label>
                            <select id="miembro" required>
                                <option value="papa">üë® Pap√°</option>
                                <option value="mama">üë© Mam√°</option>
                                <option value="hijo1">üë¶ Hijo/a 1</option>
                                <option value="hijo2">üëß Hijo/a 2</option>
                                <option value="compartido">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Compartido</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label>Descripci√≥n</label>
                            <input type="text" id="descripcion" placeholder="Detalle de la transacci√≥n" required>
                        </div>

                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="fecha" required>
                        </div>

                        <div class="form-group button-group">
                            <button type="button" onclick="preSubmit()" class="btn-primary">
                                <i class="fas fa-save"></i> <span id="btnSubmitText">Guardar</span>
                            </button>
                            <button type="button" id="btnCancelar" class="btn-cancel" onclick="cancelEdit()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB: Estad√≠sticas -->
        <div id="tab-estadisticas" class="tab-content">
            <!-- NEW: Trend Chart -->
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Tendencias (√öltimos 6 Meses)</h2>
                <div style="height: 300px; position: relative;">
                    <canvas id="chartTendencias"></canvas>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> Distribuci√≥n de Gastos</h2>
                <div style="height: 400px; position: relative;">
                    <canvas id="chartCategorias"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB: Historial -->
        <div id="tab-historial" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-history"></i> Historial Completo</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>M√©todo/Tarjeta</th>
                                <th>Categor√≠a</th>
                                <th>Subcategor√≠a</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMACION CREDITO -->
    <div class="modal-overlay" id="creditModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Simulaci√≥n de Cr√©dito</span>
                <button onclick="closeModal('creditModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="modal-details">
                <div class="modal-row">
                    <span>Tarjeta:</span>
                    <strong id="modalTarjeta">-</strong>
                </div>
                <div class="modal-row">
                    <span>Monto Compra:</span>
                    <span id="modalMonto">$0</span>
                </div>
                <div class="modal-row">
                    <span>Cuotas:</span>
                    <span id="modalCuotas">0</span>
                </div>
                <div class="modal-row">
                    <span>Tasa Inter√©s:</span>
                    <span id="modalTasa">1.9% M.V.</span>
                </div>
                <hr style="margin: 10px 0; border: 0; border-top: 1px dashed #ccc;">
                <div class="modal-row">
                    <span>Valor Cuota Aprox:</span>
                    <strong id="modalValorCuota">$0</strong>
                </div>
                <div class="modal-row">
                    <span>Intereses Totales:</span>
                    <span id="modalIntereses" style="color: var(--danger);">$0</span>
                </div>
                <div class="modal-row total">
                    <span>Total a Pagar (Deuda):</span>
                    <span id="modalTotalDeuda">$0</span>
                </div>
            </div>

            <p style="font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 15px;">
                *C√°lculo estimado. La entidad bancaria puede variar centavos.
            </p>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" style="display:block; flex:1;" onclick="closeModal('creditModal')">Corregir</button>
                <button type="button" class="btn-confirm" onclick="confirmSaveTransaction()">Confirmar y Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CUPOS Y GESTION (CRUD) -->
    <div class="modal-overlay" id="quotaModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title"><i class="fas fa-tasks"></i> Gesti√≥n de Tarjetas</span>
                <button onclick="closeModal('quotaModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <!-- Formulario Agregar/Editar Tarjeta -->
            <div class="add-card-form">
                <div class="form-group">
                    <label style="font-size: 0.8rem;">Nombre Tarjeta</label>
                    <input type="text" id="cardNameInput" placeholder="Ej: Visa Gold">
                </div>
                <div class="form-group">
                    <label style="font-size: 0.8rem;">Cupo Total</label>
                    <!-- UX UPGRADE: Input text para mascara -->
                    <input type="text" id="cardQuotaInput" placeholder="$ 0" oninput="formatCurrencyInput(this)">
                </div>
                <button class="btn-primary" onclick="saveCard()" id="btnSaveCard"><i class="fas fa-plus"></i></button>
                <input type="hidden" id="editCardId">
            </div>

            <div style="margin-bottom: 15px; color: var(--text-muted); font-size: 0.8rem; text-align:center;">
                <i class="fas fa-cloud"></i> Datos sincronizados con Firestore Database
            </div>

            <div id="quotaListContainer">
                <!-- Se llena din√°micamente con las tarjetas -->
                <div class="loading"><div class="spinner"></div></div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" style="background: #999; display: block;" onclick="closeModal('quotaModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAP8f9ldzgyKAg74Da2yYL9u_urRLtf8nY",
            authDomain: "crm-financiero.firebaseapp.com",
            projectId: "crm-financiero",
            storageBucket: "crm-financiero.firebasestorage.app",
            messagingSenderId: "442754442943",
            appId: "1:442754442943:web:914d5a8ef619d77407880a",
            measurementId: "G-5EBSSNG8P9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- VARIABLES GLOBALES ---
        let transactions = [];
        let cardsList = []; 
        let editingTransactionId = null;
        let chartInstance = null;
        let trendChartInstance = null; // NEW: Instance for trend chart
        let tempTransactionData = null;
        let globalDeudaPorTarjeta = {};
        
        // NEW: View state variable for month filter
        let currentViewDate = new Date(); 

        // Categor√≠as
        const categorias = {
            gasto: {
                'vivienda': { icon: 'üè†', subcategorias: ['Arriendo', 'Cuota hipoteca', 'Administraci√≥n', 'Impuesto predial', 'Reparaciones', 'Muebles y electrodom√©sticos'] },
                'servicios_publicos': { icon: 'üí°', subcategorias: ['Energ√≠a el√©ctrica', 'Agua y alcantarillado', 'Gas natural', 'Internet', 'Telefon√≠a m√≥vil', 'TV por cable/streaming'] },
                'alimentacion': { icon: 'üçî', subcategorias: ['Mercado semanal', 'Carnes y pescados', 'Frutas y verduras', 'Panader√≠a', 'Tienda de barrio', 'Domicilios'] },
                'transporte': { icon: 'üöó', subcategorias: ['Transporte p√∫blico', 'Gasolina', 'SOAT', 'Revisi√≥n t√©cnico-mec√°nica', 'Mantenimiento veh√≠culo', 'Parqueadero', 'Peajes', 'Uber/Taxi'] },
                'educacion': { icon: 'üìö', subcategorias: ['Pensi√≥n escolar', 'Universidad', '√ötiles escolares', 'Uniformes', 'Transporte escolar', 'Cursos/academias', 'Libros'] },
                'salud': { icon: '‚öïÔ∏è', subcategorias: ['Medicina prepagada', 'Consultas m√©dicas', 'Medicamentos', 'Odontolog√≠a', 'Ex√°menes', '√ìptica', 'EPS copagos'] },
                'vestuario': { icon: 'üëï', subcategorias: ['Ropa adultos', 'Ropa ni√±os', 'Calzado', 'Ropa interior', 'Accesorios'] },
                'cuidado_personal': { icon: 'üíÑ', subcategorias: ['Peluquer√≠a/barber√≠a', 'Productos de aseo', 'Cosm√©ticos', 'Gym/deporte'] },
                'entretenimiento': { icon: 'üé¨', subcategorias: ['Restaurantes', 'Cine', 'Paseos/turismo', 'Eventos/conciertos', 'Parques de diversiones', 'Streaming (Netflix, etc.)'] },
                'deudas': { icon: 'üí≥', subcategorias: ['Pr√©stamos bancarios', 'Cr√©ditos de libre inversi√≥n', 'Pr√©stamos familiares', 'Gota a gota'] }, 
                'seguros': { icon: 'üõ°Ô∏è', subcategorias: ['Seguro de vida', 'Seguro hogar', 'Seguro veh√≠culo', 'SOAT'] },
                'otros': { icon: 'üì¶', subcategorias: ['Mascotas', 'Regalos', 'Donaciones/diezmos', 'Imprevistos', 'Otros gastos'] }
            },
            ingreso: {
                'salario': { icon: 'üíº', subcategorias: ['Salario principal', 'Horas extras', 'Bonificaciones', 'Prima', 'Cesant√≠as'] },
                'negocio': { icon: 'üè™', subcategorias: ['Ventas', 'Servicios profesionales', 'Comisiones', 'Arriendos'] },
                'inversiones': { icon: 'üìà', subcategorias: ['Dividendos', 'Intereses', 'Ganancias de capital'] },
                'otros': { icon: 'üí∞', subcategorias: ['Subsidios estatales', 'Pensi√≥n', 'Regalos/donaciones', 'Otros ingresos'] }
            }
        };

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Init date picker with current month
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('dashboardMonth').value = `${yyyy}-${mm}`;
            document.getElementById('fecha').valueAsDate = today;

            loadCards(); 
        });

        // --- UX: CURRENCY MASKING ---
        function formatCurrencyInput(input) {
            // 1. Get raw value (numbers only)
            let value = input.value.replace(/\D/g, "");
            
            // 2. Handle empty case
            if (value === "") {
                input.value = "";
                return;
            }

            // 3. Format with dots
            const formatted = new Intl.NumberFormat('es-CO').format(value);
            input.value = "$ " + formatted;
        }

        function parseCurrencyInput(valueString) {
            if (!valueString) return 0;
            // Remove non-numeric characters except maybe minus sign if needed (not here)
            return parseFloat(valueString.replace(/\D/g, ''));
        }

        // --- DASHBOARD LOGIC (TIME TRAVEL) ---
        function updateDashboardView() {
            // Called when month picker changes
            const pickerVal = document.getElementById('dashboardMonth').value; // YYYY-MM
            if(pickerVal) {
                // Set currentViewDate to the 1st of selected month to avoid timezone issues
                const [year, month] = pickerVal.split('-');
                currentViewDate = new Date(parseInt(year), parseInt(month) - 1, 1);
                updateDashboard(); // Recalculate
            }
        }

        // --- GESTI√ìN DE TARJETAS (FIRESTORE CRUD) ---
        async function loadCards() {
            try {
                const snapshot = await db.collection('cards').orderBy('name').get();
                cardsList = [];
                snapshot.forEach(doc => {
                    cardsList.push({ id: doc.id, ...doc.data() });
                });

                if (cardsList.length === 0) {
                    await seedDefaultCards();
                    return; 
                }

                populateCardSelects();
                loadTransactions(); 
            } catch (error) {
                console.error("Error cargando tarjetas", error);
                showToast("Error conectando BD Tarjetas", "error");
            }
        }

        async function seedDefaultCards() {
            const defaults = ['Exito', 'Nu Eli', 'Nu Edward', 'Falabella', 'RappiCard', 'Addi'];
            const batch = db.batch();
            defaults.forEach(name => {
                const ref = db.collection('cards').doc();
                batch.set(ref, { name: name, quota: 0 });
            });
            await batch.commit();
            loadCards();
        }

        function populateCardSelects() {
            const selectCredito = document.getElementById('tarjetaCredito');
            const selectPago = document.getElementById('tarjetaDestinoPago');
            selectCredito.innerHTML = '';
            selectPago.innerHTML = '';

            cardsList.forEach(c => {
                let opt1 = document.createElement('option');
                opt1.value = c.name;
                opt1.textContent = c.name;
                selectCredito.appendChild(opt1);

                let opt2 = document.createElement('option');
                opt2.value = c.name;
                opt2.textContent = c.name;
                selectPago.appendChild(opt2);
            });
        }

        // --- FUNCIONES DEL MODAL DE GESTION (CRUD) ---
        function openQuotaModal() {
            renderQuotaCards(); 
            resetCardForm();
            document.getElementById('quotaModal').style.display = 'flex';
        }

        function resetCardForm() {
            document.getElementById('cardNameInput').value = '';
            document.getElementById('cardQuotaInput').value = '';
            document.getElementById('editCardId').value = '';
            document.getElementById('btnSaveCard').innerHTML = '<i class="fas fa-plus"></i>';
            document.getElementById('btnSaveCard').classList.remove('btn-edit');
            document.getElementById('btnSaveCard').classList.add('btn-primary');
        }

        async function saveCard() {
            const name = document.getElementById('cardNameInput').value.trim();
            // Use parser for masked input
            const quota = parseCurrencyInput(document.getElementById('cardQuotaInput').value);
            const id = document.getElementById('editCardId').value;

            if (!name) { showToast("El nombre es requerido", "error"); return; }
            // Allow 0, check isNaN
            if (isNaN(quota)) { showToast("El cupo debe ser n√∫mero", "error"); return; }

            try {
                if (id) {
                    await db.collection('cards').doc(id).update({ name, quota });
                    showToast("Tarjeta actualizada", "success");
                } else {
                    await db.collection('cards').add({ name, quota });
                    showToast("Tarjeta creada", "success");
                }
                resetCardForm();
                loadCards(); 
                setTimeout(renderQuotaCards, 500); 
            } catch (e) {
                showToast("Error guardando tarjeta", "error");
            }
        }

        async function deleteCard(id) {
            if (!confirm("¬øSeguro eliminar esta tarjeta?")) return;
            try {
                await db.collection('cards').doc(id).delete();
                showToast("Tarjeta eliminada", "success");
                loadCards();
                setTimeout(renderQuotaCards, 500);
            } catch (e) { showToast("Error al eliminar", "error"); }
        }

        function editCard(id, name, quota) {
            document.getElementById('cardNameInput').value = name;
            // Format input for editing
            const input = document.getElementById('cardQuotaInput');
            input.value = quota; 
            formatCurrencyInput(input); // Trigger formatting
            
            document.getElementById('editCardId').value = id;
            const btn = document.getElementById('btnSaveCard');
            btn.innerHTML = '<i class="fas fa-save"></i>';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-edit');
        }

        function renderQuotaCards() {
            const container = document.getElementById('quotaListContainer');
            container.innerHTML = '';
            const deudas = globalDeudaPorTarjeta;

            cardsList.forEach(card => {
                const assigned = card.quota || 0;
                const debt = deudas[card.name] || 0; 
                const available = assigned - debt;
                
                let percentUsed = 0;
                if (assigned > 0) {
                    percentUsed = (debt / assigned) * 100;
                    if (percentUsed > 100) percentUsed = 100;
                }

                let barClass = 'good';
                if (percentUsed > 50) barClass = 'warning';
                if (percentUsed > 80) barClass = 'danger';

                const div = document.createElement('div');
                div.className = 'quota-card';
                div.innerHTML = `
                    <div class="quota-header">
                        <div class="quota-name">
                            <i class="fas fa-credit-card" style="color: var(--primary);"></i> ${card.name}
                        </div>
                        <div class="quota-actions">
                            <button class="btn-icon-edit" onclick="editCard('${card.id}', '${card.name}', '${assigned}')"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-icon-delete" onclick="deleteCard('${card.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div style="font-size:0.85rem; color:#666; display:flex; justify-content:space-between;">
                         <span>Cupo: <strong>${formatMoney(assigned)}</strong></span>
                         <span>Uso: ${Math.round(percentUsed)}%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar ${barClass}" style="width: ${percentUsed}%"></div>
                    </div>
                    <div class="quota-details">
                        <div>Deuda: <span class="val-debt">${formatMoney(debt)}</span></div>
                        <div>Disponible: <span class="val-avail">${formatMoney(available)}</span></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- L√ìGICA DE INTERFAZ FORMULARIO ---
        function handleTipoChange() {
            const tipo = document.getElementById('tipo').value;
            const creditConfig = document.getElementById('creditConfig');
            const pagoTCConfig = document.getElementById('divPagoTarjeta');
            const metodoPagoDiv = document.getElementById('metodoPagoDiv');
            const metodoDestinoDiv = document.getElementById('metodoDestinoDiv');
            const categoriaSelect = document.getElementById('categoria');
            
            creditConfig.classList.add('hidden');
            pagoTCConfig.classList.add('hidden');
            metodoPagoDiv.classList.remove('hidden');
            metodoDestinoDiv.classList.add('hidden');
            document.getElementById('lblMetodoPago').textContent = "M√©todo de Pago";

            document.getElementById('tarjetaCredito').required = false;
            document.getElementById('cuotas').required = false;
            document.getElementById('tarjetaDestinoPago').required = false;
            document.getElementById('metodoPago').required = true;
            
            if (tipo === 'credito') {
                creditConfig.classList.remove('hidden');
                creditConfig.style.display = 'grid';
                metodoPagoDiv.classList.add('hidden'); 
                document.getElementById('tarjetaCredito').required = true;
                document.getElementById('cuotas').required = true;
                document.getElementById('metodoPago').required = false;
            } 
            else if (tipo === 'pago_tarjeta') {
                pagoTCConfig.classList.remove('hidden');
                pagoTCConfig.style.display = 'grid';
                document.getElementById('tarjetaDestinoPago').required = true;
                document.getElementById('lblMetodoPago').textContent = "Pagar desde (Origen)";
            }
            else if (tipo === 'transferencia') {
                metodoDestinoDiv.classList.remove('hidden');
            }

            categoriaSelect.innerHTML = '<option value="">Seleccione...</option>';
            document.getElementById('subcategoriaDiv').classList.add('hidden');
            
            if (tipo === 'credito') {
                loadCategoriesToSelect(categorias['gasto'], categoriaSelect);
            } else if (tipo === 'pago_tarjeta') {
                let opt = document.createElement('option');
                opt.value = 'pago_tc';
                opt.textContent = 'üí≥ Abono a Capital / Pago Cuota';
                opt.selected = true;
                categoriaSelect.appendChild(opt);
            } else if (tipo === 'transferencia') {
                let opt = document.createElement('option');
                opt.value = 'transferencia';
                opt.textContent = 'üîÑ Transferencia Interna';
                opt.selected = true;
                categoriaSelect.appendChild(opt);
            } else {
                if (categorias[tipo]) {
                    loadCategoriesToSelect(categorias[tipo], categoriaSelect);
                }
            }
        }

        function loadCategoriesToSelect(catsObj, selectElement) {
            for (let key in catsObj) {
                let opt = document.createElement('option');
                opt.value = key;
                opt.textContent = `${catsObj[key].icon} ${key.replace(/_/g, ' ').toUpperCase()}`;
                selectElement.appendChild(opt);
            }
        }

        document.getElementById('categoria').addEventListener('change', function() {
            const tipo = document.getElementById('tipo').value;
            let tipoCategoria = tipo;
            if (tipo === 'credito') tipoCategoria = 'gasto';
            const cat = this.value;
            const subDiv = document.getElementById('subcategoriaDiv');
            const subSelect = document.getElementById('subcategoria');
            
            if (tipo === 'pago_tarjeta' || tipo === 'transferencia') {
                subDiv.classList.add('hidden');
                return;
            }

            if (cat && categorias[tipoCategoria] && categorias[tipoCategoria][cat]) {
                subDiv.classList.remove('hidden');
                subSelect.innerHTML = '<option value="">Seleccione...</option>';
                const subcategoriasList = categorias[tipoCategoria][cat].subcategorias || [];
                subcategoriasList.forEach(sub => {
                    let opt = document.createElement('option');
                    opt.value = sub;
                    opt.textContent = sub;
                    subSelect.appendChild(opt);
                });
            } else {
                subDiv.classList.add('hidden');
            }
        });

        // --- C√ÅLCULO FINANCIERO ---
        function calcularCredito(monto, cuotas, tarjeta) {
            if (tarjeta.toLowerCase().includes('addi') && cuotas <= 3) {
                return { cuota: monto / cuotas, interesTotal: 0, totalDeuda: monto };
            }
            const tasaMensual = 0.019; // 1.9% M.V.
            if (cuotas === 1) return { cuota: monto, interesTotal: 0, totalDeuda: monto };

            const numerador = monto * tasaMensual * Math.pow(1 + tasaMensual, cuotas);
            const denominador = Math.pow(1 + tasaMensual, cuotas) - 1;
            const valorCuota = numerador / denominador;
            const totalDeuda = valorCuota * cuotas;
            const interesTotal = totalDeuda - monto;

            return { cuota: valorCuota, interesTotal: interesTotal, totalDeuda: totalDeuda };
        }

        function preSubmit() {
            const form = document.getElementById('transactionForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const tipo = document.getElementById('tipo').value;
            
            // UX UPDATE: Parse masked input
            const monto = parseCurrencyInput(document.getElementById('monto').value);
            
            const data = {
                tipo: tipo,
                monto: monto,
                categoria: document.getElementById('categoria').value,
                subcategoria: document.getElementById('subcategoria').value || '',
                miembro: document.getElementById('miembro').value,
                descripcion: document.getElementById('descripcion').value,
                fecha: document.getElementById('fecha').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (tipo === 'credito') {
                const tarjeta = document.getElementById('tarjetaCredito').value;
                const cuotas = parseInt(document.getElementById('cuotas').value);
                const calculo = calcularCredito(monto, cuotas, tarjeta);

                data.metodoPago = tarjeta; 
                data.esCredito = true;
                data.cuotas = cuotas;
                data.valorCuotaInicial = calculo.cuota;
                data.interesCalculado = calculo.interesTotal;
                data.totalDeuda = calculo.totalDeuda;

                tempTransactionData = data;
                showCreditModal(data, calculo);
            } 
            else if (tipo === 'pago_tarjeta') {
                data.metodoPago = document.getElementById('metodoPago').value;
                data.tarjetaDestino = document.getElementById('tarjetaDestinoPago').value;
                data.esCredito = false;
                data.esAbono = true;
                saveTransaction(data);
            }
            else {
                data.metodoPago = document.getElementById('metodoPago').value;
                if(tipo === 'transferencia') data.metodoDestino = document.getElementById('metodoDestino').value;
                data.esCredito = false;
                data.totalDeuda = 0;
                saveTransaction(data);
            }
        }

        function showCreditModal(data, calculo) {
            document.getElementById('modalTarjeta').textContent = data.metodoPago;
            document.getElementById('modalMonto').textContent = formatMoney(data.monto);
            document.getElementById('modalCuotas').textContent = data.cuotas;
            
            if(data.metodoPago.toLowerCase().includes('addi') && data.cuotas <= 3) {
                document.getElementById('modalTasa').textContent = "0% (Beneficio Addi)";
                document.getElementById('modalTasa').style.color = "var(--success)";
            } else {
                document.getElementById('modalTasa').textContent = "1.9% M.V.";
                document.getElementById('modalTasa').style.color = "var(--text)";
            }

            document.getElementById('modalValorCuota').textContent = formatMoney(calculo.cuota) + " / mes";
            document.getElementById('modalIntereses').textContent = formatMoney(calculo.interesTotal);
            document.getElementById('modalTotalDeuda').textContent = formatMoney(calculo.totalDeuda);
            document.getElementById('creditModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'creditModal') tempTransactionData = null;
        }

        function confirmSaveTransaction() {
            if (tempTransactionData) {
                saveTransaction(tempTransactionData);
                closeModal('creditModal');
            }
        }

        async function saveTransaction(data) {
            try {
                if (editingTransactionId) {
                    await db.collection('transactions').doc(editingTransactionId).update(data);
                    showToast('Transacci√≥n actualizada', 'success');
                } else {
                    await db.collection('transactions').add(data);
                    showToast('Transacci√≥n guardada', 'success');
                }
                cancelEdit();
                loadTransactions();
            } catch (error) {
                showToast('Error al guardar: ' + error.message, 'error');
            }
        }

        // --- CARGA Y DISPLAY ---
        async function loadTransactions() {
            try {
                const snapshot = await db.collection('transactions').orderBy('fecha', 'desc').get();
                transactions = [];
                snapshot.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
                
                updateDashboard();
                renderHistory();
                renderCharts(); // Pie Chart
                renderTrendChart(); // NEW Line Chart
            } catch (e) {
                console.error("Error cargando transactions", e);
            }
        }

        function updateDashboard() {
            let sDebito = 0, sEfectivo = 0, sNequi = 0;
            let deudaPorTarjeta = {};
            
            cardsList.forEach(c => deudaPorTarjeta[c.name] = 0);

            let totalIngresosMes = 0;
            let totalGastosMes = 0;
            
            // Use currentViewDate variable instead of new Date()
            const viewMonth = currentViewDate.getMonth();
            const viewYear = currentViewDate.getFullYear();
            
            // Format label for UI
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            document.getElementById('lblPeriodoResumen').textContent = `${monthNames[viewMonth]} ${viewYear}`;

            transactions.forEach(t => {
                const monto = parseFloat(t.monto);
                // Important: Need to handle TDATE accounting for timezone offset or use simple string split for accuracy
                // Using split to ensure '2023-01-01' stays '2023-01-01'
                const [tYear, tMonth, tDay] = t.fecha.split('-').map(Number); 
                
                // JS Month is 0-indexed, tMonth is 1-indexed
                const isViewMonth = (tMonth - 1) === viewMonth && tYear === viewYear;

                if (t.tipo === 'pago_tarjeta') {
                    // Saldos liquidos are global (accumulative of all time), so we process all
                    if (t.metodoPago === 'debito') sDebito -= monto;
                    if (t.metodoPago === 'efectivo') sEfectivo -= monto;
                    if (t.metodoPago === 'nequi') sNequi -= monto;

                    if (deudaPorTarjeta[t.tarjetaDestino] === undefined) deudaPorTarjeta[t.tarjetaDestino] = 0;
                    deudaPorTarjeta[t.tarjetaDestino] -= monto;

                } else if (!t.esCredito) {
                    if (t.tipo === 'ingreso') {
                        if (t.metodoPago === 'debito') sDebito += monto;
                        if (t.metodoPago === 'efectivo') sEfectivo += monto;
                        if (t.metodoPago === 'nequi') sNequi += monto;
                        if (isViewMonth) totalIngresosMes += monto;
                    } else if (t.tipo === 'gasto') {
                        if (t.metodoPago === 'debito') sDebito -= monto;
                        if (t.metodoPago === 'efectivo') sEfectivo -= monto;
                        if (t.metodoPago === 'nequi') sNequi -= monto;
                        if (isViewMonth) totalGastosMes += monto;
                    } else if (t.tipo === 'transferencia') {
                        if (t.metodoPago === 'debito') sDebito -= monto;
                        if (t.metodoPago === 'efectivo') sEfectivo -= monto;
                        if (t.metodoPago === 'nequi') sNequi -= monto;
                        if (t.metodoDestino === 'debito') sDebito += monto;
                        if (t.metodoDestino === 'efectivo') sEfectivo += monto;
                        if (t.metodoDestino === 'nequi') sNequi += monto;
                    }
                } else {
                    // Credito
                    const cardName = t.metodoPago;
                    if (deudaPorTarjeta[cardName] === undefined) deudaPorTarjeta[cardName] = 0;
                    deudaPorTarjeta[cardName] += (t.totalDeuda || monto);
                    
                    if (isViewMonth) totalGastosMes += monto;
                }
            });

            globalDeudaPorTarjeta = deudaPorTarjeta;

            // Global totals (Liquid & Debt) are always 'All Time', so they don't depend on View Date
            document.getElementById('saldoDebito').textContent = formatMoney(sDebito);
            document.getElementById('saldoEfectivo').textContent = formatMoney(sEfectivo);
            document.getElementById('saldoNequi').textContent = formatMoney(sNequi);
            document.getElementById('saldoTotal').textContent = formatMoney(sDebito + sEfectivo + sNequi);

            // Period totals depend on View Date
            document.getElementById('totalIngresosMes').textContent = formatMoney(totalIngresosMes);
            document.getElementById('totalGastosMes').textContent = formatMoney(totalGastosMes);
            document.getElementById('balanceMes').textContent = formatMoney(totalIngresosMes - totalGastosMes);

            const containerTarjetas = document.getElementById('cardsBreakdown');
            containerTarjetas.innerHTML = '';
            let deudaTotalGlobal = 0;
            const tarjetasAmostrar = new Set([...cardsList.map(c => c.name), ...Object.keys(deudaPorTarjeta)]);
            
            tarjetasAmostrar.forEach(cardName => {
                const deuda = deudaPorTarjeta[cardName] || 0;
                const existsInConfig = cardsList.find(c => c.name === cardName);

                if (deuda !== 0 || existsInConfig) {
                    if(deuda !== 0) deudaTotalGlobal += deuda;
                    
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card-status-item';
                    cardDiv.innerHTML = `<div class="card-name">${cardName} ${!existsInConfig ? '(Archivada)' : ''}</div><div class="card-debt">${formatMoney(deuda)}</div>`;
                    containerTarjetas.appendChild(cardDiv);
                }
            });
            
            if(Object.keys(deudaPorTarjeta).length === 0 && deudaTotalGlobal === 0) {
                containerTarjetas.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color: #aaa;">No hay tarjetas activas.</p>';
            }
            document.getElementById('deudaTotalTC').textContent = formatMoney(deudaTotalGlobal);
        }

        // --- NEW: TREND CHART LOGIC ---
        function renderTrendChart() {
            // 1. Prepare buckets for last 6 months
            const buckets = {};
            const labels = [];
            const dataIngresos = [];
            const dataGastos = [];

            // Generate last 6 month keys
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('es-CO', { month: 'short', year: '2-digit' });
                buckets[key] = { ingresos: 0, gastos: 0 };
                labels.push(label);
            }

            // 2. Aggregate Data
            transactions.forEach(t => {
                const [year, month] = t.fecha.split('-');
                const key = `${year}-${month}`;
                
                // Only process if key exists in our last 6 months buckets
                if (buckets[key]) {
                    const monto = parseFloat(t.monto);
                    
                    if (t.tipo === 'ingreso') {
                        buckets[key].ingresos += monto;
                    } else if (t.tipo === 'gasto' || t.tipo === 'credito') {
                        // We count credit purchase as expense in the month it happens
                        buckets[key].gastos += monto;
                    }
                    // Transfers and Payments don't count as expense trends generally (debatable, but cleaner)
                }
            });

            // 3. Flatten data for chart
            const keys = Object.keys(buckets).sort();
            keys.forEach(k => {
                dataIngresos.push(buckets[k].ingresos);
                dataGastos.push(buckets[k].gastos);
            });

            // 4. Render
            const ctx = document.getElementById('chartTendencias');
            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: dataIngresos,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Gastos',
                            data: dataGastos,
                            borderColor: '#f43f5e',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderHistory() {
            const tbody = document.getElementById('transactionList');
            tbody.innerHTML = '';
            transactions.forEach(t => {
                const row = document.createElement('tr');
                let tipoClass = '';
                let tipoIcon = '';
                let metodoDisplay = '';

                if (t.tipo === 'ingreso') { tipoClass = 'tipo-ingreso'; tipoIcon = 'üí∞'; metodoDisplay = t.metodoPago; }
                else if (t.tipo === 'credito') { tipoClass = 'tipo-credito'; tipoIcon = 'üí≥'; metodoDisplay = `${t.metodoPago} (${t.cuotas} cuotas)`; }
                else if (t.tipo === 'transferencia') { tipoClass = 'tipo-transferencia'; tipoIcon = 'üîÑ'; metodoDisplay = `${t.metodoPago} ‚Üí ${t.metodoDestino}`; }
                else if (t.tipo === 'pago_tarjeta') { tipoClass = 'tipo-pago'; tipoIcon = 'üìâ'; metodoDisplay = `${t.metodoPago} ‚Üí ${t.tarjetaDestino}`; }
                else { tipoClass = 'tipo-gasto'; tipoIcon = 'üí∏'; metodoDisplay = t.metodoPago; }

                row.innerHTML = `
                    <td>${t.fecha}</td>
                    <td class="${tipoClass}">${tipoIcon} ${t.tipo.replace('_', ' ').toUpperCase()}</td>
                    <td>${metodoDisplay}</td>
                    <td>${t.categoria ? t.categoria.replace(/_/g, ' ') : '-'}</td>
                    <td>${t.subcategoria || '-'}</td>
                    <td>${t.descripcion}</td>
                    <td class="${tipoClass}">${formatMoney(t.monto)}</td>
                    <td>
                        <button class="btn-edit" onclick="editTransaction('${t.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="deleteTransaction('${t.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderCharts() {
            const ctx = document.getElementById('chartCategorias');
            const cats = {};
            // Filter by current view date for pie chart? 
            // Usually category breakdown is better for "This Month" context.
            // Let's use the same filter as Dashboard to be consistent.
            const viewMonth = currentViewDate.getMonth();
            const viewYear = currentViewDate.getFullYear();

            transactions.filter(t => (t.tipo === 'gasto' || t.tipo === 'credito')).forEach(t => {
                const [tYear, tMonth] = t.fecha.split('-').map(Number);
                if ((tMonth - 1) === viewMonth && tYear === viewYear) {
                    const nombreCat = t.categoria ? t.categoria.replace(/_/g, ' ').toUpperCase() : 'OTROS';
                    cats[nombreCat] = (cats[nombreCat] || 0) + parseFloat(t.monto);
                }
            });

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4ade80', '#fbbf24', '#f43f5e', '#63b3ed', '#f687b3']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'right' },
                        title: { display: true, text: 'Gastos del Mes Seleccionado' }
                    } 
                }
            });
        }

        function formatMoney(amount) {
            return '$ ' + parseFloat(amount).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        function showToast(msg, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            btn.classList.add('active');
        }
        function cancelEdit() {
            editingTransactionId = null;
            document.getElementById('transactionForm').reset();
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('formTitle').textContent = 'Nueva Transacci√≥n';
            document.getElementById('btnSubmitText').textContent = 'Guardar';
            document.getElementById('btnCancelar').style.display = 'none';
            handleTipoChange(); 
        }
        window.editTransaction = function(id) {
            const t = transactions.find(x => x.id === id);
            if (!t) return;
            editingTransactionId = id;
            document.getElementById('tipo').value = t.tipo;
            handleTipoChange(); 
            
            // Format input for edit
            const mInput = document.getElementById('monto');
            mInput.value = t.monto;
            formatCurrencyInput(mInput);

            document.getElementById('descripcion').value = t.descripcion;
            document.getElementById('fecha').value = t.fecha;
            document.getElementById('miembro').value = t.miembro;
            
            if (t.tipo === 'credito') {
                document.getElementById('tarjetaCredito').value = t.metodoPago;
                document.getElementById('cuotas').value = t.cuotas;
            } else if (t.tipo === 'pago_tarjeta') {
                document.getElementById('metodoPago').value = t.metodoPago;
                document.getElementById('tarjetaDestinoPago').value = t.tarjetaDestino;
            } else {
                document.getElementById('metodoPago').value = t.metodoPago;
                if(t.tipo === 'transferencia') document.getElementById('metodoDestino').value = t.metodoDestino;
            }

            setTimeout(() => {
                document.getElementById('categoria').value = t.categoria;
                const event = new Event('change');
                document.getElementById('categoria').dispatchEvent(event);
                setTimeout(() => { document.getElementById('subcategoria').value = t.subcategoria; }, 50);
            }, 100);

            document.getElementById('formTitle').textContent = 'Editar Transacci√≥n';
            document.getElementById('btnSubmitText').textContent = 'Actualizar';
            document.getElementById('btnCancelar').style.display = 'block';
            switchTab('transacciones', document.querySelectorAll('.tab-button')[1]);
        }
        window.deleteTransaction = async function(id) {
            if(confirm('¬øSeguro que deseas eliminar este registro?')) {
                try {
                    await db.collection('transactions').doc(id).delete();
                    showToast('Eliminado correctamente', 'success');
                    loadTransactions();
                } catch(e) { showToast('Error eliminando', 'error'); }
            }
        }
    </script>
</body>
</html>